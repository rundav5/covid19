---
title: "Visualización de datos COVID-19 en Colombia"
author: "Rafael Unda | Ingeniero Civil y MSc. Ingeniería de Transporte | Twitter: @rundav5"
date: "11 de julio, 2021"
output:
  html_document: 
    code_folding: hide
    fig_height: 4.5
    fig_width: 8
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r inicializar}
# definir zona horaria
Sys.setenv(TZ="America/Bogota")

# variable de fecha actual
reciente <- "210905"

fecha_datos <- as.Date(paste(paste(20,substr(reciente,1,2),sep=""),substr(reciente,3,4),substr(reciente,5,6),sep="-"))

```

```{r librerias}
# instalar packages
#install.packages("ggplot2")
#install.packages("stringi")
#install.packages("RColorBrewer")
#install.packages("xlsx")
#install.packages("lubridate")
#install.packages("plyr")
#install.packages("zoo")
#install.packages("ggrepel")
#install.packages("stringr")
#install.packages("gganimate")
#install.packages("DT")
#install.packages("tsibble")

# llamar librerias
library(ggplot2)
library(scales)
library(stringi)
library(RColorBrewer)
library(readxl)
library(lubridate)
library(plyr)
library(zoo)
library(ggrepel)
library(stringr)
#library(gganimate)
library(DT)
library(tsibble)

```

```{r funcion simple uppercase}
# uppercase
simpleCap <- function(x) {
  s <- strsplit(x, " ")[[1]]
  paste(toupper(substring(s, 1,1)), substring(s, 2),
      sep="", collapse=" ")
}

```

***
# Introducción

Varias plataformas, como [Our World in Data](https://ourworldindata.org/coronavirus), [Coronavirus tracker](https://gorkang.shinyapps.io/2020-corona/) y [Financial Times](https://www.ft.com/content/a2901ce8-5eb7-4633-b89c-cbdf5b386938), han realizado y publicado análisis de los datos a nivel global y nacional de la pandemia del COVID-19 y de los procesos de vacunación.

Utilizando los datos publicados recurrentemente por el [Gobierno de Colombia](https://coronaviruscolombia.gov.co/covid19/index.html), hice algunas gráficas de la evolución de la pandemia en nuestro país para analizar con más detalle su evolución a nivel nacional, departamental y municipal.

También calculé el exceso de mortalidad con los datos de muertes por todas las causas que publica el [DANE](https://www.dane.gov.co/index.php/estadisticas-por-tema/demografia-y-poblacion/informe-de-seguimiento-defunciones-por-covid-19) aproximadamente cada tres meses.

Además, utilizando los reportes diarios de las dosis aplicadas en Colombia que publica el Ministerio de Salud en Twitter, [Silvana Zapata Bedoya](https://twitter.com/solsilvanazb) construyó una base de datos para analizar la evolución del proceso de vacunación a nivel nacional y departamental, que he utilizado para generar visualizaciones presentadas más abajo. Hasta la fecha, el Gobierno Nacional no ha hecho pública una base de datos que permita analizar dicha evolución.

```{r importar datos de casos INS}
data_col <- read.csv(paste("inputs/casos/Casos1_",reciente,".csv",sep=""))

# nombres de columnas
colnames(data_col) <- c("fecha_reporte_web","caso",                        "fecha_notificacion","cod_DIVIPOLA_departamento","departamento","cod_DIVIPOLA_ciudad","ciudad","edad","unidad_edad","sexo","tipo","atencion","estado","cod_ISO_pais_procedencia","pais_procedencia","recuperacion","fis","fecha_muerte","fecha_diagnostico","fecha_recuperacion","tipo_recuperacion","pertenencia_etnica","grupo_etnico")

# departamento
data_col$departamento <- as.character(data_col$departamento)
data_col$departamento <- stri_trans_general(data_col$departamento,"Latin-ASCII") #acentos
data_col$departamento <- toupper(data_col$departamento)
data_col$departamento <- ifelse(data_col$departamento == "STA MARTA D.E.", "MAGDALENA", data_col$departamento) # Santa Marta
data_col$departamento <- ifelse(data_col$departamento == "CARTAGENA", "BOLIVAR", data_col$departamento) # Cartagena
data_col$departamento <- ifelse(data_col$departamento == "BARRANQUILLA", "ATLANTICO", data_col$departamento) # Cartagena

# municipio
data_col$ciudad <- as.character(data_col$ciudad)
data_col$ciudad <- stri_trans_general(data_col$ciudad,"Latin-ASCII") #acentos
data_col$ciudad <- toupper(data_col$ciudad)

# codigo DIVIPOLA departamento
data_col$cod_DIVIPOLA_departamento <- ifelse(data_col$cod_DIVIPOLA_departamento == 47001, 47, data_col$cod_DIVIPOLA_departamento) # Santa Marta
data_col$cod_DIVIPOLA_departamento <- ifelse(data_col$cod_DIVIPOLA_departamento == 13001, 13, data_col$cod_DIVIPOLA_departamento) # Cartagena
data_col$cod_DIVIPOLA_departamento <- ifelse(data_col$cod_DIVIPOLA_departamento == 8001, 8, data_col$cod_DIVIPOLA_departamento) # Cartagena

# fecha reporte web
data_col$new_date <- NA
data_col$new_date <- as.Date(data_col$fecha_reporte_web,"%d/%m/%Y")
data_col$fecha_reporte_web <- data_col$new_date

# fecha notificacion
data_col$new_date <- NA
data_col$new_date <- as.Date(data_col$fecha_notificacion,"%d/%m/%Y")
data_col$fecha_notificacion <- data_col$new_date

# fecha inicio síntomas
data_col$new_date <- NA
data_col$new_date <- as.Date(data_col$fis,"%d/%m/%Y")
data_col$fis <- data_col$new_date

# fecha diagnostico
data_col$new_date <- NA
data_col$new_date <- as.Date(data_col$fecha_diagnostico,"%d/%m/%Y")
data_col$fecha_diagnostico <- data_col$new_date

# fecha recuperacion
data_col$new_date <- NA
data_col$new_date <- as.Date(data_col$fecha_recuperacion,"%d/%m/%Y")
data_col$fecha_recuperacion <- data_col$new_date

# fecha muerte
data_col$new_date <- NA
data_col$new_date <- as.Date(data_col$fecha_muerte,"%d/%m/%Y")
data_col$fecha_muerte <- data_col$new_date

# fecha de inicio de síntomas / de diagnóstico para asintomáticos
data_col$fecha_sintom_diagno <- NA
data_col$fecha_sintom_diagno <- ifelse(is.na(data_col$fis), data_col$fecha_diagnostico, data_col$fis)
data_col$fecha_sintom_diagno <- ifelse(is.na(data_col$fecha_sintom_diagno),data_col$fecha_notificacion,data_col$fecha_sintom_diagno)
data_col$new_date <- NA
data_col$new_date <- as.Date(data_col$fecha_sintom_diagno)
data_col$fecha_sintom_diagno <- data_col$new_date

data_col$new_date <- NULL

# edad
data_col$edad_new <- NA
data_col$edad_new <- ifelse(data_col$unidad_edad == 1, data_col$edad, ifelse(data_col$unidad_edad == 2, data_col$edad / 12, data_col$edad / 365))
data_col$edad <- round(data_col$edad_new, 0)
data_col$edad_new <- NULL

# sexo 
data_col$sexo <- toupper(data_col$sexo)

# tipo
data_col$tipo <- toupper(data_col$tipo)
data_col$tipo <- ifelse(data_col$tipo=="ENESTUDIO", "EN ESTUDIO",data_col$tipo)
data_col$tipo <- ifelse(data_col$tipo=="RELACIOANDO", "RELACIONADO",data_col$tipo)
data_col$tipo <- ifelse(data_col$tipo=="IMPORTADOS", "IMPORTADO",data_col$tipo)
data_col$tipo <- ifelse(data_col$tipo=="COMUNITARIA", "COMUNITARIO",data_col$tipo)

# atencion
data_col$atencion <- toupper(data_col$atencion)
data_col$atencion <- ifelse(data_col$atencion=="N/A",NA,as.character(data_col$atencion))
data_col$atencion <- ifelse(data_col$atencion=="",NA,as.character(data_col$atencion))
data_col$atencion <- ifelse(data_col$atencion=="FALLECIDO","MUERTO",data_col$atencion)

# estado
data_col$estado <- toupper(data_col$estado)
data_col$estado <- ifelse(data_col$estado=="N/A",NA,as.character(data_col$estado))

# recuperacion
data_col$recuperacion <- toupper(data_col$recuperacion)
```

```{r importar datos de pruebas PCR INS}
pruebas_PCR <- read.csv(paste("inputs/pruebas PCR/Muestras_procesadas_",reciente,".csv",sep=""), stringsAsFactors=FALSE)

colnames(pruebas_PCR)[1] <- "fecha"
colnames(pruebas_PCR)[2] <- "pruebas_acum"
pruebas_PCR$fecha[1] <- "2020-03-04"
pruebas_PCR$new_date <- NA
pruebas_PCR$new_date <- substring(pruebas_PCR$fecha,1,10)
pruebas_PCR$fecha <- pruebas_PCR$new_date
pruebas_PCR$new_date <- NULL

```

```{r importar datos de pruebas antigeno INS}
pruebas_antigeno <- read.csv(paste("inputs/pruebas antigeno/Antigeno_procesadas_",reciente,".csv",sep=""), stringsAsFactors=FALSE)

colnames(pruebas_antigeno)[1] <- "fecha"
pruebas_antigeno$fecha_new <- as.Date(paste(substr(pruebas_antigeno$fecha,7,10),substr(pruebas_antigeno$fecha,1,2),sep="-",substr(pruebas_antigeno$fecha,4,5)))
pruebas_antigeno$fecha <- pruebas_antigeno$fecha_new
pruebas_antigeno$fecha_new <- NULL
```

```{r importar datos auxiliares}
# fechas
aux_fechas <- read.csv("inputs/auxiliares/fechas.csv", sep=";", stringsAsFactors = FALSE)
colnames(aux_fechas) <- c("num_dia","fecha")
aux_fechas$fecha <- as.Date(aux_fechas$fecha)

```

```{r importar datos del CNPV DANE}
# poblacion departamentos
info_dep <- read_excel("inputs/auxiliares/CNPV-2018-Poblacion-Ajustada-por-Cobertura.xls", sheet = "Ajuste por Cobertura CNPV 2018", range = "A9:H43")

colnames(info_dep) <- c("cod_DIVIPOLA","departamento","pob_total","pob_cabecera","pob_centros_pob_rural","omi_total","omi_cabecera","omi_centros_pob_rural")
info_dep$departamento <- stri_trans_general(info_dep$departamento,"Latin-ASCII") #acentos
info_dep$departamento <- toupper(info_dep$departamento)
info_dep$pob_total <- as.numeric(info_dep$pob_total) # numeros
info_dep$cod_DIVIPOLA <- as.numeric(info_dep$cod_DIVIPOLA)
info_dep$departamento <- ifelse(info_dep$departamento=="BOGOTA, D.C.","BOGOTA",info_dep$departamento)
info_dep$departamento <- ifelse(info_dep$departamento=="VALLE DEL CAUCA","VALLE",info_dep$departamento)
info_dep$departamento <- ifelse(info_dep$departamento=="LA GUAJIRA","GUAJIRA",info_dep$departamento)
info_dep$departamento <- ifelse(info_dep$departamento=="NORTE DE SANTANDER","NORTE SANTANDER",info_dep$departamento)
info_dep$departamento <- ifelse(info_dep$departamento=="ARCHIPIELAGO DE SAN ANDRES","SAN ANDRES",info_dep$departamento)

# poblacion municipios
info_mun <- read_excel("inputs/auxiliares/CNPV-2018-Poblacion-Ajustada-por-Cobertura.xls", sheet = "Ajuste por Cobertura CNPV Mpios", range = "A9:I1131")

colnames(info_mun) <- c("cod_DIVIPOLA","departamento","municipio","pob_total","pob_cabecera","pob_centros_pob_rural","omi_total","omi_cabecera","omi_centros_pob_rural")
info_mun$departamento <- stri_trans_general(info_mun$departamento,"Latin-ASCII") #acentos
info_mun$departamento <- toupper(info_mun$departamento)
info_mun$municipio <- stri_trans_general(info_mun$municipio,"Latin-ASCII") #acentos
info_mun$municipio <- toupper(info_mun$municipio)
info_mun$pob_total <- as.numeric(info_mun$pob_total) # numeros
info_mun$cod_DIVIPOLA <- as.numeric(info_mun$cod_DIVIPOLA)

```

```{r importar datos de OWID, eval=FALSE, include=FALSE}
owid <- read.csv(paste("inputs/stringency index/owid-covid-data_",reciente,".csv",sep=""), stringsAsFactors=FALSE)

owid <- subset(owid, iso_code == "COL", select = c("iso_code","location","date","stringency_index"))

owid$date <- as.Date(owid$date)

```

```{r importar datos de google mobility, eval=FALSE, include=FALSE}
google <- read.csv(paste("inputs/google mobility/Global_Mobility_Report_",reciente,".csv",sep=""), stringsAsFactors=FALSE)

google <- subset(google, country_region_code == "CO")

google$date <- as.Date(google$date)

```

***
# Evolución de la pandemia

## Colombia

Hay tres indicadores generales que se pueden calcular con la información pública disponible para Colombia: pruebas, casos y muertes.

Las pruebas son el mecanismo de medición del contagio de la pandemia. En la medida en que la cantidad de pruebas sea mayor, mejor será la medición de la evolución del contagio. Sin embargo, el número de pruebas realizadas nunca será suficiente para captar la totalidad de casos, por lo que existe y existirá siempre un subregistro.

Aunque tampoco es perfecto, el indicador de muertes es un mejor reflejo de la evolución de la pandemia, pues es mayor la probabilidad de identificar un caso positivo de COVID-19 cuando se trata de una muerte.

### Pruebas

El número de pruebas reportadas diariamente por el [Instituto Nacional de Salud (INS)](https://www.ins.gov.co/Noticias/Paginas/Coronavirus.aspx) corresponde a las pruebas realizadas a sospechosos de COVID-19, sin incluir las segundas (o más) pruebas realizadas a pacientes o casos activos que aún no se recuperan.

Desde marzo se están utilizando las pruebas PCR como la principal prueba diagnóstica para COVID-19 en Colombia. Adicionalmente, a partir de Agosto del 2020, también se empezaron a utilizar pruebas de antígeno para diagnosticar el virus.

En ese sentido, la gráfica a continuación refleja la capacidad del sistema de salud para medir casos activos de COVID-19 en Colombia.

```{r pruebas PCR procesadas al dia, include=FALSE}
# construir tabla de pruebas diarias
t_PCR <- pruebas_PCR
t_PCR$pruebas_acum <- str_replace_all(t_PCR$pruebas_acum, "[[:punct:]]", "")
t_PCR$pruebas_acum <- as.numeric(t_PCR$pruebas_acum)

# calcular pruebas diarias
t_PCR$pruebas_diarias <- NA
lista <- seq(2,length(t_PCR$pruebas_diarias))
for (i in lista) {
  j <- i-1
  t_PCR$pruebas_diarias[i] = t_PCR$pruebas_acum[i] - t_PCR$pruebas_acum[j]
}

t_PCR$fecha <- as.Date(t_PCR$fecha)

# construir grafica
ggplot(t_PCR,aes(x=fecha,y=pruebas_diarias)) +
  geom_text(x=as.Date("2020-05-04"),y=10000,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  
  # datos
  geom_bar(stat="identity") +
  scale_fill_manual(values=c("#999999","#E69F00","black")) +
  scale_x_date(date_breaks="1 month",date_labels="%m-%y'",limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,50000,5000),minor_breaks=seq(0,50000,1000),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,50000,5000),labels=comma)) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",plot.caption=element_text(face="italic",hjust=0)) +
  labs(x="Fecha reporte",y=NULL,fill=NULL,title="Pruebas PCR reportadas al día en Colombia",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  
  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dashed") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+1,y=20000,label="Reporte caso nº 1"),angle=90,size=2.5,col="black") +
  
  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0,xend=fecha_datos,yend=0),col="black",size=0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5)

```

```{r pruebas de antigeno acumuladas, include=FALSE}
# construir tabla de pruebas diarias
t_antigeno <- pruebas_antigeno
t_antigeno$pruebas_acum <- NA
t_antigeno$pruebas_acum <- rowSums(t_antigeno[,2:34], na.rm = TRUE)

t_antigeno <- subset(t_antigeno, select = c("fecha","pruebas_acum"))
t_antigeno$fecha <- as.Date(t_antigeno$fecha)

# construir grafica
ggplot(t_antigeno,aes(x=fecha,y=pruebas_acum)) +
  geom_text(x=as.Date("2020-05-04"),y=200000,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  
  # datos
  geom_line() +
  scale_fill_manual(values=c("#999999","#E69F00","black")) +
  scale_x_date(date_breaks="1 month",date_labels="%m-%y'",limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,5000000,200000),minor_breaks=seq(0,5000000,1000000),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,5000000,200000),labels=comma)) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",plot.caption=element_text(face="italic",hjust=0)) +
  labs(x="Fecha reporte",y=NULL,fill=NULL,title="Pruebas de antígeno acumuladas en Colombia",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  
  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dashed") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+1,y=5000,label="Reporte caso nº 1"),angle=90,size=2.5,col="black") +
  
  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0,xend=fecha_datos,yend=0),col="black",size=0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5)

```

```{r pruebas de antigeno al dia, include=FALSE}

# calcular pruebas diarias
t_antigeno$pruebas_diarias <- NA
lista <- seq(2,length(t_antigeno$pruebas_diarias))
for (i in lista) {
  j <- i-1
  t_antigeno$pruebas_diarias[i] = t_antigeno$pruebas_acum[i] - t_antigeno$pruebas_acum[j]
}

# depurar base de datos
t_antigeno$pruebas_diarias <- ifelse(t_antigeno$pruebas_diarias < 1, NA, t_antigeno$pruebas_diarias)
t_antigeno$pruebas_diarias <- ifelse(t_antigeno$fecha %in% as.Date(c("2020-10-16","2020-09-17","2020-08-07")), NA, t_antigeno$pruebas_diarias)

t_antigeno$pruebas_diarias[match(as.Date("2020-09-02"),t_antigeno$fecha)] <- 4578
t_antigeno$pruebas_diarias[match(as.Date("2020-09-15"),t_antigeno$fecha)] <- 9516
t_antigeno$pruebas_diarias[match(as.Date("2020-09-17"),t_antigeno$fecha)] <- 10010
t_antigeno$pruebas_diarias[match(as.Date("2020-10-15"),t_antigeno$fecha)] <- 21668
t_antigeno$pruebas_diarias[match(as.Date("2020-10-16"),t_antigeno$fecha)] <- 17767
t_antigeno$pruebas_diarias[match(as.Date("2021-01-11"),t_antigeno$fecha)] <- 9835
t_antigeno$pruebas_diarias[match(as.Date("2021-01-12"),t_antigeno$fecha)] <- 16625
t_antigeno$pruebas_diarias[match(as.Date("2021-01-15"),t_antigeno$fecha)] <- 40860
t_antigeno$pruebas_diarias[match(as.Date("2021-01-20"),t_antigeno$fecha)] <- 31727
t_antigeno$pruebas_diarias[match(as.Date("2021-01-21"),t_antigeno$fecha)] <- 27677
t_antigeno$pruebas_diarias[match(as.Date("2021-03-08"),t_antigeno$fecha)] <- 8524
t_antigeno$pruebas_diarias[match(as.Date("2021-03-09"),t_antigeno$fecha)] <- 12330
t_antigeno$pruebas_diarias[match(as.Date("2021-03-13"),t_antigeno$fecha)] <- 18350
t_antigeno$pruebas_diarias[match(as.Date("2021-03-14"),t_antigeno$fecha)] <- 7764


# construir grafica
ggplot(t_antigeno,aes(x=fecha,y=pruebas_diarias)) +
  geom_text(x=as.Date("2020-05-04"),y=5000,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  
  # datos
  geom_bar(stat="identity") +
  scale_fill_manual(values=c("#999999","#E69F00","black")) +
  scale_x_date(date_breaks="1 month",date_labels="%m-%y'",limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,50000,5000),minor_breaks=seq(0,50000,1000),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,50000,5000),labels=comma)) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",plot.caption=element_text(face="italic",hjust=0)) +
  labs(x="Fecha reporte",y=NULL,fill=NULL,title="Pruebas de antígeno reportadas al día en Colombia",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  
  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dashed") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+1,y=15000,label="Reporte caso nº 1"),angle=90,size=2.5,col="black") +
  
  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0,xend=fecha_datos,yend=0),col="black",size=0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5)

```

```{r sumar PCR y antigeno}
t_pruebas <- subset(t_PCR, select = c("fecha","pruebas_diarias"))
colnames(t_pruebas)[2] <- "PCR_diarias"

t_pruebas$antigeno_diarias <- NA
t_pruebas$antigeno_diarias <- t_antigeno$pruebas_diarias[match(t_pruebas$fecha,t_antigeno$fecha)]

# calcular total de pruebas diarias
t_pruebas$total_diarias <- NA
t_pruebas$total_diarias <- rowSums(t_pruebas[,2:3], na.rm = TRUE)

# pegar número dia
t_pruebas$dia <- NA
t_pruebas$dia <- aux_fechas$num_dia[match(t_pruebas$fecha,aux_fechas$fecha)]

# calcular numero acumulado de pruebas
t_pruebas$total_acum <- NA
t_pruebas$total_acum[1] <- t_pruebas$total_diarias[1]
lista <- t_pruebas$dia[2:length(t_pruebas$dia)]
i <- lista[1]
for (i in lista) {
  t_pruebas$total_acum[match(i,t_pruebas$dia)] <- t_pruebas$total_acum[match(i-1,t_pruebas$dia)] + t_pruebas$total_diarias[match(i,t_pruebas$dia)]
}
rm(i,lista)

```

```{r casos reportados y descartados al dia}
# construir tabla de casos reportados al dia
aux <- aggregate(fecha_notificacion ~ fecha_reporte_web, data_col, length)
colnames(aux) <- c("fecha_reporte_web","caso")
t_pruebas$casos_reportados <- NA
t_pruebas$casos_reportados <- aux$caso[match(as.character(t_pruebas$fecha),as.character(aux$fecha_reporte_web))]
rm(aux)
t_pruebas$casos_reportados[is.na(t_pruebas$casos_reportados)] <- 0

# descartados
t_pruebas$casos_descartados <- NA
t_pruebas$casos_descartados <- t_pruebas$total_diarias - t_pruebas$casos_reportados

# porcentaje positivos
t_pruebas$porc_positivos <- NA
t_pruebas$porc_positivos <- t_pruebas$casos_reportados / t_pruebas$total_diarias

# promedio móvil positivos
t_pruebas$prom_positivos <- NA
lista_dias <- t_pruebas$dia[7:length(t_pruebas$dia)]
i <- lista_dias[1]
for (i in lista_dias) {
  j <- i-6
  aux <- subset(t_pruebas, dia >= j & dia <= i)
  t_pruebas$prom_positivos[match(i,t_pruebas$dia)] <- sum(aux$porc_positivos)/7
  }
rm(i,lista_dias)

porc_acum <-  sum(t_pruebas$casos_reportados,na.rm=TRUE) / max(t_pruebas$total_acum,na.rm=TRUE)
```

```{r pruebas diarias}
# construir tabla
aux_pruebas <- subset(t_pruebas, select = c("fecha", "total_diarias"))
colnames(aux_pruebas)[2] <- "diarios"
aux_pruebas$dato <- "casos confirmados"
aux_pruebas$orden <- 1
aux_2 <- subset(t_pruebas, select = c("fecha","casos_reportados"))
colnames(aux_2)[2] <- "diarios"
aux_2$dato <- "casos confirmados"
aux_2$orden <- 1
aux_3 <- subset(t_pruebas, select = c("fecha", "casos_descartados"))
colnames(aux_3)[2] <- "diarios"
aux_3$dato <- "casos descartados"
aux_3$orden <- 2

t_pruebas_aux <- rbind(aux_2, aux_3)
rm(aux_2,aux_3)
t_pruebas_aux$fecha <- as.Date(t_pruebas_aux$fecha)

# exportar dataframe
#write.csv(t_pruebas_aux, paste("outputs/",reciente,"_pruebas_col_aux.csv"))

# construir grafica
ggplot(t_pruebas_aux,aes(x=fecha,y=diarios,fill=reorder(dato,-orden))) +
  geom_text(x=as.Date("2020-06-01"),y=60000,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  
  # datos
  geom_bar(stat="identity") +
  scale_fill_manual(values=c("#999999","#E69F00","black")) +
  scale_x_date(date_breaks="2 months",date_labels="%m-%y'",limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,200000,20000),minor_breaks=seq(0,200000,5000),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,200000,20000),labels=comma)) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",plot.caption=element_text(face="italic",hjust=0)) +
  labs(x="Fecha reporte",y=NULL,fill=NULL,title="Pruebas reportadas y casos confirmados al día en Colombia",subtitle="Incluye pruebas PCR y de antígenos",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  
  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=70000,label="Reporte caso nº 1"),angle=90,size=2.5,col="black") +
  
  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0,xend=fecha_datos,yend=0),col="black",size=0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5)
 
# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_001.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r pruebas positivas}
# construir grafica
ggplot(t_pruebas,aes(x=fecha,y=porc_positivos)) +
  geom_text(x=as.Date("2020-06-01"),y=0.05,label="@rundav5",col="#AEB6BF",size=3)+ #usuario
  
  # datos
  #geom_line(aes(x=fecha,y=prom_positivos),col="white",size=2) +
  geom_line(aes(x=fecha,y=prom_positivos,col=prom_positivos),size=1) +
  scale_x_date(date_breaks="2 months",date_labels="%m-%y'",limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,0.5,0.05),labels=percent_format(accuracy=1),sec.axis=sec_axis(~.,labels=percent_format(accuracy=1),breaks=seq(0,0.5,0.05))) +
  scale_color_gradient(low="#FFC30F",high="#C70039", guide = FALSE) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",plot.caption=element_text(face="italic",hjust=0)) +
  labs(x="Fecha reporte",y=NULL,title="Porcentaje de pruebas positivas en Colombia",subtitle="Promedio móvil de 7 días",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  
  # promedio de todos los días
  geom_hline(yintercept=porc_acum,linetype="dashed",size=0.5,colour="#999999") +
  geom_label(aes(x=as.Date("2020-04-20"),y=porc_acum*1.1,label=paste(round(porc_acum*100,1),"% del total",sep="")),colour="white",size=2.2,fill="#999999") +
  
  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=0.15,label="Reporte caso nº 1"),angle=90,size=2.5,col="black") +
  
  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0,xend=fecha_datos,yend=0),col="black",size=0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5)
 
# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_002.jpeg", sep = ""),last_plot(),device = "jpeg",path = "outputs/",width = w,height = h)
rm(aratio, w,h)

```

Además de la cantidad de pruebas, el tiempo de reporte de los casos también es un indicador de la capacidad de medición. En la gráfica a continuación se muestra la distribución del tiempo (en días) entre la fecha de inicio de síntomas y la fecha de reporte, que es información suministrada en la base de datos de casos que publica el INS.

La distribución de ese tiempo determina el tiempo de "rezago", "datos preliminares" o "datos no confiables" de la información de casos cuando se observa o se analiza contra la fecha de inicio de síntomas, como se presentan más adelante.


### Tiempo de reporte

```{r tiempo de reporte}
# calcular tiempo de notificacion de cada caso
data_col$tiempo_reporte <- NA
data_col$tiempo_reporte <- as.Date(data_col$fecha_reporte_web) - as.Date(data_col$fis)
data_col$tiempo_reporte <- ifelse(data_col$tiempo_reporte < 0, NA, data_col$tiempo_reporte)
data_col$fecha_reporte_web <- as.Date(data_col$fecha_reporte_web)

# incluir semana y año de reporte
data_col$semana_reporte <- NA
data_col$semana_reporte <- isoweek(data_col$fecha_reporte_web)
data_col$ano <- isoyear(data_col$fecha_reporte_web)
data_col$ano_sem <- NA
data_col$ano_sem <- as.numeric(paste(data_col$ano, data_col$semana_reporte,sep = ""))

```

```{r boxplots de tiempo de reporte, eval=FALSE, include=FALSE}
# construir grafica
ggplot(subset(data_col,!is.na(tiempo_reporte)), aes(x=semana_reporte,y=tiempo_reporte,group=semana_reporte)) +
  
  # usuario
  geom_text(x=13,y=0,label="@rundav5",col="#AEB6BF",size=3) +
  
  # datos
  geom_boxplot(outlier.shape=NA,outlier.size=1,fill="#E69F00") +
  scale_x_continuous(breaks=seq(2,52,2),minor_breaks = seq(2,52,2)) +
  scale_y_continuous(breaks=seq(0,100,2),minor_breaks=seq(0,30,1),limits=c(0,30),sec.axis=sec_axis(~.,breaks=seq(0,100,2))) +
  labs(title="Tiempo de reporte de casos en Colombia",subtitle="Sólo casos sintomáticos",y="Días entre inicio de síntomas y fecha reporte",x = "Semana de reporte",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  theme_minimal() +
  theme(plot.caption=element_text(face="italic",hjust=0)) 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_094.jpeg", sep = ""),last_plot(),device = "jpeg",path = "outputs/",width = w,height = h)
rm(aratio, w,h)

```

```{r barras de tiempo de reporte, include=FALSE}
c_tiempo_reporte_col <- aggregate(tiempo_reporte ~ ano + semana_reporte + ano_sem, data_col,mean)
#c_tiempo_reporte_col <- aggregate(tiempo_reporte ~ ano + semana_reporte, data_col,mean)

c_tiempo_reporte_col$yr_wk <- NA
c_tiempo_reporte_col$yr_wk <- yearweek(paste(c_tiempo_reporte_col$ano, 'week', c_tiempo_reporte_col$semana_reporte))

colnames(c_tiempo_reporte_col)[4] <- "promedio"
c_tiempo_reporte_col$percentil90 <- NA
c_tiempo_reporte_col$percentil75 <- NA
c_tiempo_reporte_col$percentil50 <- NA

lista <- unique(c_tiempo_reporte_col$ano_sem)
i <- lista[1]
for (i in lista) {
  aux <- subset(data_col, ano_sem == i)
  c_tiempo_reporte_col$percentil90[match(i,c_tiempo_reporte_col$ano_sem)] <- quantile(aux$tiempo_reporte,0.9,na.rm=TRUE)
    c_tiempo_reporte_col$percentil75[match(i,c_tiempo_reporte_col$ano_sem)] <- quantile(aux$tiempo_reporte,0.75,na.rm=TRUE)
    c_tiempo_reporte_col$percentil50[match(i,c_tiempo_reporte_col$ano_sem)] <- quantile(aux$tiempo_reporte,0.50,na.rm=TRUE)
  
}
rm(i,lista)

# construir grafica
ggplot(c_tiempo_reporte_col,aes(x=yr_wk,xend=yr_wk)) +
  
  # usuario
  geom_text(x=as.Date("2020-05-01"),y=24,label="@rundav5",col="#AEB6BF",size=3) +
  
  # datos
  geom_segment(aes(y=0,yend=percentil90,color=percentil90)) +
  geom_point(aes(y=percentil90,color=percentil90,shape="Percentil 90")) +
  geom_point(aes(y=percentil75,color=percentil75,shape="Percentil 75")) +
  geom_point(aes(y=promedio,shape="Promedio")) +
  scale_color_gradient(low="#E69F00",high="#e67f00",guide=FALSE) +
  scale_shape_manual(values=c(17,15,21)) +
  #scale_x_yearweek(date_breaks="4 weeks", date_labels = "%y'-%U") + 
  scale_x_yearweek(date_breaks="4 weeks", date_labels = "%d-%m") + 
  scale_y_continuous(limits=c(0,NA),breaks=seq(0,50,2),sec.axis=sec_axis(~.,breaks=seq(0,50,2))) +
  theme_minimal() +
  theme(legend.position="top",axis.text.x=element_text(angle=0),axis.text.y=element_text(size=8),plot.caption=element_text(face="italic",hjust=0)) +
  labs(color=NULL,shape=NULL,x="Fecha reporte (día-mes)",y="Días entre inicio de síntomas y reporte",title="Tiempo de reporte de casos en Colombia",
       #subtitle="Percentil 90 de la distribución del tiempo de reporte de la última semana",
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +

  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dashed") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=16,label="Reporte caso nº 1"),angle=90,size=2.5,col="black") +

  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0,xend=fecha_datos,yend=0),col="black",size=0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5)

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_095.jpeg", sep = ""),last_plot(),device = "jpeg",path = "outputs/",width = w,height = h)
rm(aratio, w,h)

```

### Casos

De acuerdo con el hallazgo de la gráfica anterior, al analizar los casos contra la fecha de inicio de síntomas los datos de los últimos días no son confiables. La cantidad de días que corresponden a ese periodo de datos no confiables o datos preliminares es variable y se establece en el percentil 90 de la distribución del tiempo de notificación de las últimas dos semanas.

```{r tiempo confiable de datos preliminares}
aux_tiempo_reporte <- quantile(subset(data_col, ano_sem >= max(ano_sem,na.rm=TRUE)-1, select = "tiempo_reporte"), na.rm = TRUE,c(0.75,0.8,0.85,0.9,0.95))
confianza_casos <- aux_tiempo_reporte[4]
rm(aux_tiempo_reporte)
confianza_casos <- 21
```

```{r casos diarios}
# construir tabla de casos diarios por fecha de diagnóstico
c_col <- aggregate(caso ~ fecha_sintom_diagno, data_col, length)
c_col$fecha_sintom_diagno <- as.Date(c_col$fecha_sintom_diagno)
colnames(c_col)[2] <- "casos_dia"

# pegar dia
c_col$dia <- NA
c_col$dia <- aux_fechas$num_dia[match(c_col$fecha,aux_fechas$fecha)]

# promedio diario
c_col$prom_diario <- NA

lista_dias <- c_col$dia[7:length(c_col$dia)]
i <- lista_dias[1]
for (i in lista_dias) {
  j <- i-6
  aux <- subset(c_col, dia >= j & dia <= i)
  c_col$prom_diario[match(i,c_col$dia)] <- sum(aux$casos_dia)/7
  }
rm(i,lista_dias)


# construir grafica
ggplot(c_col,aes(x=fecha_sintom_diagno)) +
  
  # usuario
  geom_text(x=as.Date("2020-06-01"),y=14000,label="@rundav5",col="#AEB6BF",size=3) +

  # aislamiento
  #geom_rect(xmin=as.Date("2020-03-25")-0.5,ymin=-Inf,xmax=as.Date("2020-09-01")-0.5,ymax=Inf,fill="#E69F00",col="white",alpha=0.01) +

  # datos
  geom_bar(aes(y=casos_dia,fill="casos diarios"),stat="identity") +
  geom_line(aes(y=prom_diario),col="white",size=2) +
  geom_line(aes(y=prom_diario,col="promedio móvil (7 días)"),size=1) +
  scale_x_date(date_breaks="2 months",date_labels="%m-%y'",
               #date_minor_breaks="1/2 month",
               limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,50000,5000),minor_breaks=seq(0,50000,1000),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,50000,5000),labels=comma)) +
  scale_fill_manual(values="#999999") +
  scale_color_manual(values="#999999") +
  theme_minimal() +
  theme(legend.position="top",legend.box="horizontal",legend.background=element_rect(fill="transparent",color=NA),plot.caption=element_text(face="italic",hjust=0)) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,title="Casos diarios en Colombia",fill=NULL,color=NULL,caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
 
  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=max(casos_dia,na.rm=TRUE)*0.5,label="Reporte caso nº 1"),angle=90,size=2.5) +
 
  # # aislamiento
  # geom_vline(xintercept=as.Date("2020-03-25")-0.5,size=0.4,colour="#E69F00") +
  # geom_segment(aes(x=as.Date("2020-03-25")-0.5,y=max(casos_dia)*0.7,yend=max(casos_dia)*0.7),xend=as.Date("2020-09-01")-0.5,col="#E69F00",size=0.4) +
  # geom_label(aes(x=as.Date("2020-03-25")-0.5,y=max(casos_dia)*0.7,label="Aislamiento\nnacional"),colour="white",size=2,fill="#E69F00") +
  # 
  # # apertura parcial
  # geom_vline(xintercept=as.Date("2020-04-27")-0.5,size=0.4,colour="#E69F00",linetype="dashed") +
  # geom_label(aes(x=as.Date("2020-04-27")-0.5,y=max(casos_dia)*0.7,label="Apertura\nparcial"),colour="white",size=2,fill="#E69F00") +
  # 
  # # aislamiento selectivo
  # geom_vline(xintercept=as.Date("2020-09-01")-0.5,size=0.4,colour="#E69F00") +
  # geom_label(aes(x=as.Date("2020-09-01")-0.5,y=max(casos_dia)*0.7,label="Fin\naislamiento"),colour="white",size=2,fill="#E69F00") +

  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+0.4,y=0,xend=fecha_datos,yend=0), col = "black",size = 0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5) +
  
  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0",alpha=0.01) +
  geom_vline(xintercept=fecha_datos-confianza_casos-0.5,size=0.4,colour="white") + 
  geom_text(aes(x=fecha_datos-confianza_casos/5,y=max(casos_dia)*0.5,label="Datos\npreliminares"),angle=90,size=2.5,col="white") +
  geom_text(aes(x=fecha_datos-confianza_casos+4,y=2000,label=paste("-",confianza_casos,"días*")),angle=90,size=2.5,col="white") 
  

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_003.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos vs stringency index, eval=FALSE, include=FALSE}
c_col$stringency_index <- NA
c_col$stringency_index <- owid$stringency_index[match(c_col$fecha_sintom_diagno,owid$date)]

# construir grafica
ggplot(c_col,aes(x=fecha_sintom_diagno)) +
  
  # usuario
  geom_text(x=as.Date("2020-06-01"),y=14000,label="@rundav5",col="#AEB6BF",size=3) +

  # datos
  #geom_bar(aes(y=casos_dia,fill="casos diarios"),stat="identity") +
  #geom_line(aes(y=prom_diario),col="white",size=2) +
  geom_line(aes(y=prom_diario,col=stringency_index),size=1) +
  scale_x_date(date_breaks="2 months",date_labels="%m-%y'",
               #date_minor_breaks="1/2 month",
               limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,30000,2000),minor_breaks=seq(0,30000,500),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,20000,2000),labels=comma)) +
  scale_color_gradient(low="green",high="red") +
  theme_minimal() +
  theme(legend.position="top",legend.box="horizontal",legend.background=element_rect(fill="transparent",color=NA),plot.caption=element_text(face="italic",hjust=0)) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,title="Casos diarios y nivel de restricción* en Colombia",fill=NULL,color="*Stringency index",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"y stringency index de OWID\n**El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
 
  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=max(casos_dia,na.rm=TRUE)*0.5,label="Reporte caso nº 1"),angle=90,size=2.5) +
 
  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+0.4,y=0,xend=fecha_datos,yend=0), col = "black",size = 0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5) +
  
  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0",alpha=0.01) +
  geom_vline(xintercept=fecha_datos-confianza_casos-0.5,size=0.4,colour="white") + 
  geom_text(aes(x=fecha_datos-confianza_casos/5,y=max(casos_dia)*0.5,label="Datos\npreliminares"),angle=90,size=2.5,col="white") +
  geom_text(aes(x=fecha_datos-confianza_casos+4,y=1000,label=paste("-",confianza_casos,"días**")),angle=90,size=2.5,col="white") 
  

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_004.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos acumulados}
# calcular acumulados
c_col$casos_acum <- NA
lista_fechas <- c_col$fecha_sintom_diagno
i <- lista_fechas[1]
for (i in lista_fechas) {
  aux <- subset(c_col, fecha_sintom_diagno <= i)
  c_col$casos_acum[match(i,c_col$fecha_sintom_diagno)] <- sum(aux$casos_dia)
  rm(aux)
}
rm(i,lista_fechas)
```

```{r proporcion asintomaticos}
data_col$sintomas <- NA
data_col$sintomas <- ifelse(is.na(data_col$fis), "Asintomático","Sintomático")
data_col$fecha_notificacion <- as.Date(data_col$fecha_notificacion)

c_col_sintomas <- aggregate(caso ~ fecha_sintom_diagno + sintomas, data_col, length)
#c_col_sintomas <- aggregate(caso ~ sintomas, data_col, length)
colnames(c_col_sintomas)[1] <- "fecha"
colnames(c_col_sintomas)[3] <- "casos"

# arreglar fecha y agregar dia
#c_col_sintomas$fecha <- as.Date(c_col_sintomas$fecha)
c_col_sintomas$dia <- NA
c_col_sintomas$dia <- aux_fechas$num_dia[match(as.character(c_col_sintomas$fecha),as.character(aux_fechas$fecha))]

# promedio movil
c_col_sintomas$prom <- NA
lista_estados <- unique(c_col_sintomas$sintomas)
for (i in lista_estados) {
  aux_1 <- subset(c_col_sintomas, sintomas == i)
  lista_dias <- aux_1$dia[7:length(aux_1$dia)]
  j <- lista_dias[1]
  for (j in lista_dias) {
    k <- j-6
    aux_2 <- subset(aux_1, dia >= k & dia <= j)
    c_col_sintomas$prom[match(paste(i,j),paste(c_col_sintomas$sintomas,c_col_sintomas$dia))] <- sum(aux_2$casos)/7
  }
  rm(j,k,lista_dias,aux_2)
}
rm(i,lista_estados,aux_1)

# calcular proporcion
c_col_sintomas$prop <- NA
lista_dias <- unique(c_col_sintomas$dia)
#i <- lista_dias[1]
for (i in lista_dias) {
  aux_1 <- subset(c_col_sintomas, dia == i)
  aux_1$prop <- aux_1$prom / sum(aux_1$prom,na.rm=TRUE)
  lista_estados <- unique(aux_1$sintomas)
  #j <- lista_estados[1]
  for (j in lista_estados) {
    aux_2 <- subset(aux_1, sintomas == j)
    aux_2 <- aux_2$prop
    c_col_sintomas$prop[match(paste(i,j),paste(c_col_sintomas$dia,c_col_sintomas$sintomas))] <- aux_2
  }
  rm(j,lista_estados,aux_2)
}
rm(i,lista_dias,aux_1)

c_col_sintomas$fecha <- as.Date(c_col_sintomas$fecha)

# construir grafica
ggplot(c_col_sintomas,aes(x=fecha,y=prop,fill=sintomas)) +
  
  # datos
  geom_area(position="stack",alpha = 0.8,size=0.5,col="white") +
  scale_x_date(date_breaks="2 months",date_labels="%m-%y'",limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,1,0.2),minor_breaks=seq(0,1,0.1),labels=percent,sec.axis=sec_axis(~.,breaks=seq(0,1,0.2),labels=percent)) +
  scale_fill_manual(values=c("#999999", "#D55E00", "#E69F00", "#56B4E9","#009E73", "#F0E442","#0072B2", "#CC79A7")) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",
       y=NULL,fill=NULL,title="Proporción de casos sintomáticos y asintomáticos en Colombia",fill=NULL,caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",plot.caption=element_text(face="italic",hjust=0)) +
  
  # usuario
  geom_text(x=as.Date("2020-06-01"),y=0.1,label="@rundav5",col="white",size=3,angle=0) +

  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=0.5,label="Reporte caso nº 1"),angle=90,size=2.5) +

  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0,xend=fecha_datos,yend=0),col="black",size=0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5) +

  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0",alpha=0.01) +
  geom_vline(xintercept = fecha_datos-confianza_casos-0.5, size=0.4,colour="white") + 
  geom_text(aes(x=fecha_datos-confianza_casos/5,y=0.5,label="Datos\npreliminares"),angle=90,size=2.5,col="white") +
  geom_text(aes(x=fecha_datos-confianza_casos+4,y=0.08,label=paste("-",confianza_casos,"días*")),angle=90,size=2.5,col="white") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_009.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

El número de casos confirmados de COVID-19 relacionados es un indicador de la eficiencia del rastreo de contactos en la búsqueda de nuevos casos. La siguiente gráfica muestra la evolución de la proporción de casos relacionados respecto al total de casos confirmados en Colombia.

```{r casos relacionados}
c_col_tipo <- aggregate(caso ~ fecha_sintom_diagno + tipo, data_col, length)

c_col_tipo$fecha_sintom_diagno <- as.Date(c_col_tipo$fecha_sintom_diagno)
colnames(c_col_tipo)[1] <- "fecha"
colnames(c_col_tipo)[3] <- "casos"

c_col_tipo$dia <- NA
c_col_tipo$dia <- aux_fechas$num_dia[match(as.character(c_col_tipo$fecha),as.character(aux_fechas$fecha))]

# promedio movil
c_col_tipo$prom <- NA
lista_tipos <- unique(c_col_tipo$tipo)
for (i in lista_tipos) {
  aux_1 <- subset(c_col_tipo, tipo == i)
  lista_dias <- aux_1$dia[7:length(aux_1$dia)]
  j <- lista_dias[1]
  for (j in lista_dias) {
    k <- j-6
    aux_2 <- subset(aux_1, dia >= k & dia <= j)
    c_col_tipo$prom[match(paste(i,j),paste(c_col_tipo$tipo,c_col_tipo$dia))] <- sum(aux_2$casos)/7
  }
  rm(j,k,lista_dias,aux_2)
}
rm(i,lista_tipos,aux_1)

# calcular proporcion
c_col_tipo$prop <- NA
lista_dias <- unique(c_col_tipo$dia)
for (i in lista_dias) {
  aux_1 <- subset(c_col_tipo, dia == i)
  aux_1$prop <- aux_1$prom / sum(aux_1$prom,na.rm=TRUE)
  lista_tipos <- unique(aux_1$tipo)
  for (j in lista_tipos) {
    aux_2 <- subset(aux_1, tipo == j)
    aux_2 <- aux_2$prop
    c_col_tipo$prop[match(paste(i,j),paste(c_col_tipo$dia,c_col_tipo$tipo))] <- aux_2
  }
  rm(j,lista_tipos,aux_2)
}
rm(i,lista_dias,aux_1)

c_col_tipo$fecha <- as.Date(c_col_tipo$fecha)

# construir grafica
ggplot(c_col_tipo,aes(x=fecha,y=prop,fill=tipo)) +
  
  # datos
  geom_area(position="stack",alpha = 0.8,size=0.5,col="white") +
  scale_x_date(date_breaks="2 months",date_labels="%m-%y'",limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,1,0.2),minor_breaks=seq(0,1,0.1),labels=percent,sec.axis=sec_axis(~.,breaks=seq(0,1,0.2),labels=percent)) +
  scale_fill_manual(values=c("#999999", "#D55E00", "#E69F00", "#56B4E9","#009E73", "#F0E442","#0072B2", "#CC79A7")) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",
       y=NULL,fill=NULL,title="Proporción de casos relacionados en Colombia",fill=NULL,caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",plot.caption=element_text(face="italic",hjust=0)) +
  
  # usuario
  geom_text(x=as.Date("2020-06-01"),y=0.1,label="@rundav5",col="white",size=3,angle=0) +

  # 1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=0.5,label="Reporte caso nº 1"),angle=90,size=2.5) +

  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0,xend=fecha_datos,yend=0),col="black",size=0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5) +
  
  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0",alpha=0.01) +
  geom_vline(xintercept = fecha_datos-confianza_casos-0.5, size=0.4,colour="white") + 
  geom_text(aes(x=fecha_datos-confianza_casos/5,y=0.5,label="Datos\npreliminares"),angle=90,size=2.5,col="white") +
  geom_text(aes(x=fecha_datos-confianza_casos+4,y=0.08,label=paste("-",confianza_casos,"días*")),angle=90,size=2.5,col="white") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_010.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos diarios por estado actual}
data_col$estado_actual <- NA
data_col$recuperacion <- as.character(data_col$recuperacion)
data_col$estado_actual <- ifelse(data_col$recuperacion == "RECUPERADO",data_col$recuperacion, data_col$atencion)
c_col_atencion <- aggregate(caso ~ fecha_sintom_diagno + estado_actual, data_col, length)
c_col_atencion$fecha_sintom_diagno <- as.Date(c_col_atencion$fecha_sintom_diagno)
colnames(c_col_atencion)[3] <- "casos_dia"

# construir grafica
ggplot(c_col_atencion,aes(x=fecha_sintom_diagno,y=casos_dia,fill=estado_actual)) +
  
  # usuario
  geom_text(x=as.Date("2020-06-01"),y=14000,label="@rundav5",col="#AEB6BF",size=3) + 
  
  # 1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=5000,label="Reporte caso nº 1"),angle=90,size=2.5) +
 
  # datos
  geom_bar(stat = "identity") +
  scale_x_date(date_breaks="2 months",date_labels="%m-%y'",limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,30000,2000),minor_breaks=seq(0,30000,500),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,20000,2000),labels=comma)) +
  scale_fill_manual(values=c("#999999","#56B4E9","#0072B2","#CC79A7","#009E73")) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,title="Casos diarios por estado actual en Colombia",fill=NULL,caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",legend.background=element_rect(fill="transparent",color=NA),plot.caption=element_text(face="italic",hjust=0)) +
  
  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0,xend=fecha_datos,yend=0),col="black",size=0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5) +
  
  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0",alpha=0.01) +
  geom_vline(xintercept = fecha_datos-confianza_casos-0.5, size=0.4,colour="white") + 
  geom_text(aes(x=fecha_datos-confianza_casos/5,y=max(casos_dia)*0.5,label="Datos\npreliminares"),angle=90,size=2.5,col="white") +
  geom_text(aes(x=fecha_datos-confianza_casos+4,y=1000,label=paste("-",confianza_casos,"días*")),angle=90,size=2.5,col="white") 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_011.jpeg", sep = ""),last_plot(),device = "jpeg",path = "outputs/",width = w,height = h)
rm(aratio, w,h)

```

```{r casos diarios por edad}
# arreglar fecha y agregar dia
data_col$grupo_edad <- NA
data_col$grupo_edad <- ifelse(data_col$edad >= 80, "> 80 años", data_col$grupo_edad)
data_col$grupo_edad <- ifelse(is.na(data_col$grupo_edad) & data_col$edad >= 70, "70-79", data_col$grupo_edad)
data_col$grupo_edad <- ifelse(is.na(data_col$grupo_edad) & data_col$edad >= 60, "60-69", data_col$grupo_edad)
data_col$grupo_edad <- ifelse(is.na(data_col$grupo_edad) & data_col$edad >= 40, "40-59", data_col$grupo_edad)
data_col$grupo_edad <- ifelse(is.na(data_col$grupo_edad) & data_col$edad >= 20, "20-39", data_col$grupo_edad)
data_col$grupo_edad <- ifelse(is.na(data_col$grupo_edad), "< 20", data_col$grupo_edad)

c_col_edad <- aggregate(caso ~ fecha_sintom_diagno + grupo_edad, data_col, length)
c_col_edad$fecha_sintom_diagno <- as.Date(c_col_edad$fecha_sintom_diagno)
colnames(c_col_edad)[3] <- "casos_dia"

c_col_edad$orden <- NA
c_col_edad$orden <- ifelse(c_col_edad$grupo_edad == "> 80 años", 1, c_col_edad$orden)
c_col_edad$orden <- ifelse(c_col_edad$grupo_edad == "70-79", 2, c_col_edad$orden)
c_col_edad$orden <- ifelse(c_col_edad$grupo_edad == "60-69", 3, c_col_edad$orden)
c_col_edad$orden <- ifelse(c_col_edad$grupo_edad == "40-59", 4, c_col_edad$orden)
c_col_edad$orden <- ifelse(c_col_edad$grupo_edad == "20-39", 5, c_col_edad$orden)
c_col_edad$orden <- ifelse(c_col_edad$grupo_edad == "< 20", 6, c_col_edad$orden)

c_col_edad$fecha <- as.Date(c_col_edad$fecha)
c_col_edad$dia <- NA
c_col_edad$dia <- aux_fechas$num_dia[match(c_col_edad$fecha,aux_fechas$fecha)]


# calcular promedio diario
c_col_edad$prom_diario <- NA
lista <- as.character(unique(c_col_edad$grupo_edad))

i <- lista[1]
for (i in lista) {
  aux_1 <- subset(c_col_edad, grupo_edad == i)
  lista_dias <- aux_1$dia[7:length(aux_1$dia)]
  j <- lista_dias[1]
  for (j in lista_dias) {
    k <- j-6
    aux_2 <- subset(aux_1, dia >= k & dia <= j)
    c_col_edad$prom_diario[match(paste(i,j),paste(c_col_edad$grupo_edad,c_col_edad$dia))] <- sum(aux_2$casos_dia)/7
  }
  rm(j,k,lista_dias,aux_2)
}
rm(i,lista_depart,aux_1)


# construir grafica
ggplot(c_col_edad,aes(x=fecha_sintom_diagno,y=prom_diario,col=reorder(grupo_edad,orden))) +
  geom_text(x=as.Date("2020-06-01"),y=6000,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  
  # datos
  geom_line(size=1) +
  scale_x_date(date_breaks="2 months",date_labels="%m-%y'",limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,20000,by=2000),minor_breaks=seq(0,20000,500),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,20000,2000),labels=comma)) +
  scale_color_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7","#999999")) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,col=NULL,title="Casos diarios por edad en Colombia",subtitle="Promedio móvil de 7 días",fill=NULL,caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",legend.direction = "horizontal",legend.background=element_rect(fill="transparent",color=NA),plot.caption=element_text(face="italic",hjust=0)) +
  
  guides(col=guide_legend(nrow=1)) +
  
  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=7000,label="Reporte caso nº 1"),angle=90,size=2.5,col="black",show.legend=FALSE) +
  
  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0,xend=fecha_datos,yend=0),col="black",size=0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5) +
  
  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0",alpha=0.01,col=NA) +
  geom_vline(xintercept = fecha_datos-confianza_casos-0.5, size=0.4,colour="white") + 
  geom_text(aes(x=fecha_datos-confianza_casos/5,y=max(casos_dia)*0.5,label="Datos\npreliminares"),angle=90,size=2.5,col="white") +
  geom_text(aes(x=fecha_datos-confianza_casos+4,y=1000,label=paste("-",confianza_casos,"días*")),angle=90,size=2.5,col="white") 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_014.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos diarios por edad apilada}
# construir grafica
ggplot(c_col_edad,aes(x=fecha_sintom_diagno,y=prom_diario,fill=reorder(grupo_edad,orden))) +
  geom_text(x=as.Date("2020-06-01"),y=14000,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  
  # datos
  #geom_line(size=1) +
  geom_area(alpha=0.8) +
  scale_x_date(date_breaks="2 months",date_labels="%m-%y'",limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,30000,by=5000),minor_breaks=seq(0,30000,1000),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,30000,5000),labels=comma)) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7","#999999")) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,col=NULL,title="Casos diarios por edad en Colombia",subtitle="Promedio móvil de 7 días",fill=NULL,caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",legend.direction = "horizontal",legend.background=element_rect(fill="transparent",color=NA),plot.caption=element_text(face="italic",hjust=0)) +
  
  guides(fill=guide_legend(nrow=1)) +
  
  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=15000,label="Reporte caso nº 1"),angle=90,size=2.5,col="black",show.legend=FALSE) +
  
  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0,xend=fecha_datos,yend=0),col="black",size=0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5) +
  
  
  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0",alpha=0.01,col=NA) +
  geom_vline(xintercept = fecha_datos-confianza_casos-0.5, size=0.4,colour="white") +
  geom_text(aes(x=fecha_datos-confianza_casos/5,y=15000,label="Datos\npreliminares"),angle=90,size=2.5,col="white") +
  geom_text(aes(x=fecha_datos-confianza_casos+4,y=2000,label=paste("-",confianza_casos,"días*")),angle=90,size=2.5,col="white")

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_015.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos diarios por edad porcentaje}
# construir grafica
ggplot(c_col_edad,aes(x=fecha_sintom_diagno,y=prom_diario,fill=reorder(grupo_edad,orden))) +
  
  # datos
  #geom_line(size=1) +
  geom_area(alpha=0.8,position="fill") +
  scale_x_date(date_breaks="2 months",date_labels="%m-%y'",limits=c(as.Date(NA),fecha_datos)) +
  scale_y_continuous(breaks=seq(0,1,by=0.2),minor_breaks=seq(0,1,0.1),labels=percent,sec.axis=sec_axis(~.,breaks=seq(0,1,0.2),labels=percent)) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7","#999999")) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,col=NULL,title="Porcentaje de casos diarios por edad en Colombia",fill=NULL,caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",legend.direction = "horizontal",legend.background=element_rect(fill="transparent",color=NA),plot.caption=element_text(face="italic",hjust=0)) +
  
  guides(fill=guide_legend(nrow=1)) +
  
  geom_text(x=as.Date("2020-06-01"),y=0.2,label="@rundav5",col="white",size=3)  # usuario

  # #1º confirmado
  # geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  # geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  # geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=0.5,label="Reporte caso nº 1"),angle=90,size=2.5,col="black",show.legend=FALSE) +
  # 
  # # dias desde 1º
  # geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0,xend=fecha_datos,yend=0),col="black",size=0.4) +
  # geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  # geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5) 
  # 
  
  # # punto de confianza
  # geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0",alpha=0.01,col=NA) +
  # geom_vline(xintercept = fecha_datos-confianza_casos-0.5, size=0.4,colour="white") +
  # geom_text(aes(x=fecha_datos-confianza_casos/5,y=max(casos_dia)*0.5,label="Datos\npreliminares"),angle=90,size=2.5,col="white") +
  # geom_text(aes(x=fecha_datos-confianza_casos+4,y=300,label=paste("-",confianza_casos,"días*")),angle=90,size=2.5,col="white")

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_016.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos acumulados por edad y sexo}
c_col_edad_sexo <- aggregate(caso ~ edad + estado_actual + sexo, data_col, length)
colnames(c_col_edad_sexo)[4] <- "casos"
#c_col_atencion_total <- aggregate(caso ~ atencion, data_col,length)
c_col_edad_sexo$casos_new <- ifelse(c_col_edad_sexo$sexo=="F",c_col_edad_sexo$casos*-1,c_col_edad_sexo$casos)

# construir grafica
ggplot(c_col_edad_sexo, aes(x = edad,y = casos_new,fill = estado_actual)) +
  geom_text(x=10,y=-20000,label="@rundav5",col="#AEB6BF",size=3)+ #usuario
  # datos 
  geom_bar(stat = "identity") +
  scale_x_continuous(breaks = seq(0,100,by=10),limits=c(0,100)) +
  scale_y_continuous(limits=c(-40000,40000),breaks=seq(-40000,40000,by=5000),minor_breaks=seq(-40000,40000,1000),labels=c("40k","35k","30k","25k","20k","15k","10k","5k",0,"5k","10k","15k","20k","25k","30k","35k","40k"),sec.axis=sec_axis(~.,breaks=seq(-40000,40000,5000),labels=c("40k","35k","30k","25k","20k","15k","10k","5k",0,"5k","10k","15k","20k","25k","30k","35k","40k"))) +
  scale_fill_manual(values=c("#999999","#56B4E9","#0072B2","#CC79A7","#009E73")) +
  labs(x="Edad",y=NULL,title="Distribución de casos acumulados por edad y sexo en Colombia",fill=NULL,caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  theme_minimal() +
  theme(legend.position="right",plot.caption=element_text(face="italic",hjust=0)) +
  coord_flip() +
  geom_hline(yintercept = 0, size= 0.4) +
  geom_label(x=100,y=10000,label="Hombres",size=3,fill="white") +
  geom_label(x=100,y=-10000,label="Mujeres",size=3,fill="white")


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_012.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos acumulados por edad y estado actual}
c_col_edad_atencion <- aggregate(caso ~ edad + estado_actual, data_col, length)
colnames(c_col_edad_atencion)[3] <- "casos"
c_col_atencion_total <- aggregate(caso ~ estado_actual, data_col,length)

# data frame con anotaciones
anno_text <- data.frame(estado_actual = unique(c_col_edad_atencion$estado_actual),x1=NA,y1=NA,label_1=NA)
anno_text$x1[5] <- 0
anno_text$y1[5] <- 30000
anno_text$label_1[5] <- "@rundav5"

# construir grafica
ggplot(c_col_edad_atencion, aes(x = edad,y = casos,fill = estado_actual)) +
  geom_hline(yintercept = 0, size= 0.2) +
  
  # datos 
  geom_bar(stat = "identity") +
  scale_x_continuous(breaks = seq(0,100,by=10),limits=c(0,100)) +
  scale_y_continuous(labels=comma) +
  scale_fill_manual(values=c("#999999","#56B4E9","#0072B2","#CC79A7","#009E73")) +
  labs(x="Edad",y=NULL,title="Distribución de casos acumulados por edad y estado actual en Colombia",subtitle="Escala variable entre estados",fill=NULL,caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  theme_minimal() +
  theme(legend.position="none",axis.text.x=element_text(angle=90,size=8),plot.caption=element_text(face="italic",hjust=0)) +
  coord_flip() +
  facet_wrap(~ estado_actual, nrow = 1, scales="free_x") +
  
  # totales
  geom_text(data=c_col_atencion_total,mapping=aes(x=100,y=0,label=paste(comma(caso),"en total")),col=c("#999999","#56B4E9","#0072B2","#CC79A7","#009E73"),hjust=-0.3,vjust=0,size=3) +
  
  # usuario
  geom_text(data=anno_text,aes(x=x1,y=y1,label=label_1),hjust=0.5,angle=0,size=3.5,col="#AEB6BF99") 

 # guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_013.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)
```

### Muertes

```{r muertes diarias y promedio movil}
data_col_muertes <- subset(data_col, atencion == "MUERTO")

# construir tabla
m_col <- aggregate(caso ~ fecha_muerte, data_col_muertes,length)
m_col$fecha_muerte <- as.Date(m_col$fecha_muerte)
colnames(m_col)[2] <- "casos_dia"

# pegar dia
m_col$dia <- NA
m_col$dia <- aux_fechas$num_dia[match(m_col$fecha,aux_fechas$fecha)]

# promedio diario
m_col$prom_diario <- NA

lista_dias <- m_col$dia[7:length(m_col$dia)]
i <- lista_dias[1]
for (i in lista_dias) {
  j <- i-6
  aux <- subset(m_col, dia >= j & dia <= i)
  m_col$prom_diario[match(i,m_col$dia)] <- sum(aux$casos_dia)/7
  }
rm(i,lista_dias)

# construir grafica
ggplot(m_col,aes(x=fecha_muerte)) +
  geom_text(x=as.Date("2020-06-01"),y=400,label="@rundav5",col="#AEB6BF",size=3) + # usuario

  # datos
  geom_bar(aes(y=casos_dia,fill="muertes diarias"),stat="identity") +
  geom_line(aes(y=prom_diario),col="white",size=2) +
  geom_line(aes(y=prom_diario,col="promedio móvil (7 días)"),size=1) +
  scale_x_date(date_breaks="2 months",date_labels="%m-%y'") +
  scale_y_continuous(breaks=seq(0,10000,100),minor_breaks=seq(0,10000,20),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,10000,100),labels=comma)) +
  scale_fill_manual(values="#CC79A7") +
  scale_color_manual(values="#CC79A7") +
  theme_minimal() +
  theme(legend.position="top",legend.box="horizontal",legend.background=element_rect(fill="transparent",color=NA),plot.caption=element_text(face="italic",hjust=0)) +
  labs(x="Fecha muerte",y=NULL,title="Muertes diarias en Colombia",fill=NULL,color=NULL,caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  
  #1º confirmado
  geom_vline(xintercept = as.Date("2020-03-06"),size=0.4,linetype="dotdash") +
  geom_point(aes(x=as.Date("2020-03-06"),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=as.Date("2020-03-06")+6,y=max(casos_dia,na.rm=TRUE)*0.5,label="Reporte caso nº 1"),angle=90,size=2.5,col="black") +
  
  # dias desde 1º
  geom_segment(aes(x=as.Date("2020-03-06"),y=0,xend=fecha_datos,yend=0),col="black",size=0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-as.Date("2020-03-06"),"\ndías")),colour="black",size=2.5) +
  
  # punto de confianza
  geom_rect(xmin=fecha_datos-14.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0",alpha=0.01) +
  geom_vline(xintercept=fecha_datos-14.5,size=0.4,colour="white") + 
  geom_text(aes(x=fecha_datos,y=max(casos_dia,na.rm=TRUE)*0.5,label="Datos\npreliminares"),angle=90,size=2.5,col="white") +
  geom_text(aes(x=fecha_datos,y=100,label="- 14 días"),angle=90,size=2.5,col="white") 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_033.jpeg", sep = ""),last_plot(),device = "jpeg",path = "outputs/",width = w,height = h)
rm(aratio, w,h)
```

```{r muertes acumuladas}
# calcular acumulados
m_col$casos_acum <- NA
lista_fechas <- m_col$fecha_muerte
i <- lista_fechas[1]
for (i in lista_fechas) {
  aux <- subset(m_col, fecha_muerte <= i)
  m_col$casos_acum[match(i,m_col$fecha_muerte)] <- sum(aux$casos_dia)
  rm(aux)
}
rm(i,lista_fechas)

```

```{r muertes diarias por edad}
m_col_edad <- aggregate(caso ~ fecha_muerte + grupo_edad, data_col_muertes, length)
m_col_edad$fecha_muerte <- as.Date(m_col_edad$fecha_muerte)
colnames(m_col_edad)[3] <- "casos_dia"

m_col_edad$orden <- NA
m_col_edad$orden <- ifelse(m_col_edad$grupo_edad == "> 80 años", 1, m_col_edad$orden)
m_col_edad$orden <- ifelse(m_col_edad$grupo_edad == "70-79", 2, m_col_edad$orden)
m_col_edad$orden <- ifelse(m_col_edad$grupo_edad == "60-69", 3, m_col_edad$orden)
m_col_edad$orden <- ifelse(m_col_edad$grupo_edad == "40-59", 4, m_col_edad$orden)
m_col_edad$orden <- ifelse(m_col_edad$grupo_edad == "20-39", 5, m_col_edad$orden)
m_col_edad$orden <- ifelse(m_col_edad$grupo_edad == "< 20", 6, m_col_edad$orden)

m_col_edad$fecha <- as.Date(m_col_edad$fecha)
m_col_edad$dia <- NA
m_col_edad$dia <- aux_fechas$num_dia[match(m_col_edad$fecha,aux_fechas$fecha)]


# calcular promedio diario
m_col_edad$prom_diario <- NA
lista <- as.character(unique(m_col_edad$grupo_edad))

i <- lista[1]
for (i in lista) {
  aux_1 <- subset(m_col_edad, grupo_edad == i)
  lista_dias <- aux_1$dia[7:length(aux_1$dia)]
  j <- lista_dias[1]
  for (j in lista_dias) {
    k <- j-6
    aux_2 <- subset(aux_1, dia >= k & dia <= j)
    m_col_edad$prom_diario[match(paste(i,j),paste(m_col_edad$grupo_edad,m_col_edad$dia))] <- sum(aux_2$casos_dia)/7
  }
  rm(j,k,lista_dias,aux_2)
}
rm(i,lista_depart,aux_1)


# construir grafica
ggplot(m_col_edad,aes(x=fecha,y=prom_diario,col=reorder(grupo_edad,orden),)) +
  geom_text(x=as.Date("2020-06-01"),y=80,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  
  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=120,label="Reporte caso nº 1"),angle=90,size=2.5,col="black",show.legend=FALSE) +
 
  # datos
  geom_line(size=1) +
  scale_x_date(date_breaks="2 months",date_labels="%m-%y'",limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,20000,by=50),minor_breaks=seq(0,20000,10),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,20000,50),labels=comma)) +
  scale_color_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7","#999999")) +
  #scale_color_gradient(low="#CC79A7",high="#76448A") +
  labs(x="Fecha muerte",y=NULL,col=NULL,title="Muertes diarias por edad en Colombia",subtitle="Promedio móvil de 7 días",fill=NULL,caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",legend.direction = "horizontal",legend.background=element_rect(fill="transparent",color=NA),plot.caption=element_text(face="italic",hjust=0)) +
  
  guides(col=guide_legend(nrow=1)) +
  
  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0,xend=fecha_datos,yend=0),col="black",size=0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5) +
  
  # punto de confianza
  geom_rect(xmin=fecha_datos-14+0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0",alpha=0.01,col=NA) +
  geom_vline(xintercept = fecha_datos-14+0.5, size=0.4,colour="white") + 
  geom_text(aes(x=fecha_datos,y=max(casos_dia)*0.5,label="Datos\npreliminares"),angle=90,size=2.5,col="white") +
  geom_text(aes(x=fecha_datos,y=40,label="- 14 días"),angle=90,size=2.5,col="white")

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_036.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertes diarias por edad apilada}
# construir grafica
ggplot(m_col_edad,aes(x=fecha,y=prom_diario,fill=reorder(grupo_edad,orden))) +
  geom_text(x=as.Date("2020-06-01"),y=200,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  
  # datos
  #geom_line(size=1) +
  geom_area(alpha=0.8) +
  scale_x_date(date_breaks="2 months",date_labels="%m-%y'",limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,3000,by=100),minor_breaks=seq(0,3000,20),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,3000,100),labels=comma)) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7","#999999")) +
  labs(x="Fecha muerte",y=NULL,col=NULL,title="Muertes diarias por edad en Colombia",subtitle="Promedio móvil de 7 días",fill=NULL,caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",legend.direction = "horizontal",legend.background=element_rect(fill="transparent",color=NA),plot.caption=element_text(face="italic",hjust=0)) +
  
  guides(fill=guide_legend(nrow=1)) +
  
  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=300,label="Reporte caso nº 1"),angle=90,size=2.5,col="black",show.legend=FALSE) +
  
  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0,xend=fecha_datos,yend=0),col="black",size=0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5) +
  
  # punto de confianza
  geom_rect(xmin=fecha_datos-14+0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0",alpha=0.01,col=NA) +
  geom_vline(xintercept = fecha_datos-14+0.5, size=0.4,colour="white") +
  geom_text(aes(x=fecha_datos,y=300,label="Datos\npreliminares"),angle=90,size=2.5,col="white") +
  geom_text(aes(x=fecha_datos,y=100,label="- 14 días"),angle=90,size=2.5,col="white")

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_037.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertes diarias por edad porcentaje}
# construir grafica
ggplot(m_col_edad,aes(x=fecha,y=prom_diario,fill=reorder(grupo_edad,orden))) +
  
  # datos
  #geom_line(size=1) +
  geom_area(alpha=0.8,position="fill") +
  scale_x_date(date_breaks="2 months",date_labels="%m-%y'",limits=c(as.Date(NA),fecha_datos)) +
  scale_y_continuous(breaks=seq(0,1,by=0.2),minor_breaks=seq(0,1,0.1),labels=percent,sec.axis=sec_axis(~.,breaks=seq(0,1,0.2),labels=percent)) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7","#999999")) +
  labs(x="Fecha muerte",y=NULL,col=NULL,title="Porcentaje de muertes diarias por edad en Colombia",fill=NULL,caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",legend.direction = "horizontal",legend.background=element_rect(fill="transparent",color=NA),plot.caption=element_text(face="italic",hjust=0)) +
  
  guides(fill=guide_legend(nrow=1)) +
 
  geom_text(x=as.Date("2020-06-01"),y=0.2,label="@rundav5",col="white",size=3)  # usuario
 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_038.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

## Departamentos

### Pruebas

```{r pruebas por departamento, eval=FALSE, include=FALSE}
t_dep <- subset(t_PCR, select=c("fecha","Amazonas","Antioquia","Arauca","Atlantico","Bogota","Bolivar","Boyaca","Caldas","Caqueta","Casanare","Cauca","Cesar","Choco","Cordoba","Cundinamarca","Guainia","Guajira","Guaviare","Huila","Magdalena","Meta","Narino","Norte.de.Santander","Putumayo","Quindio","Risaralda","San.Andres","Santander","Sucre","Tolima","Valle.del.Cauca","Vaupes","Vichada","Barranquilla","Cartagena","Santa.Marta"))
t_dep_new <- data.frame(fecha=as.Date(NA),pruebas_acum=NA,departamento=NA)
lista_dep <- colnames(t_dep)[2:37]

for (i in lista_dep) {
  aux <- subset(t_dep,select=c("fecha",i))
  colnames(aux) <- c("fecha","pruebas_acum")
  aux$departamento <- i
  t_dep_new <- rbind(t_dep_new,aux)
}
rm(lista_dep)
t_dep <- subset(t_dep_new,!is.na(fecha))
rm(t_dep_new)
t_dep$departamento <- ifelse(t_dep$departamento=="Norte.de.Santander","Norte Santander",t_dep$departamento)
t_dep$departamento <- ifelse(t_dep$departamento=="San.Andres","Archipielago de San Andres",t_dep$departamento)
t_dep$departamento <- ifelse(t_dep$departamento=="Valle.del.Cauca","Valle",t_dep$departamento)
t_dep$departamento <- ifelse(t_dep$departamento=="Barranquilla","Atlantico",t_dep$departamento)
t_dep$departamento <- ifelse(t_dep$departamento=="Cartagena","Bolivar",t_dep$departamento)
t_dep$departamento <- ifelse(t_dep$departamento=="Santa.Marta","Magdalena",t_dep$departamento)
t_dep$departamento <- ifelse(t_dep$departamento=="Archipielago de San Andres","San Andres",t_dep$departamento)

t_dep$pruebas_acum <- str_replace_all(t_dep$pruebas_acum, "[[:punct:]]", "")
t_dep$pruebas_acum <- as.numeric(t_dep$pruebas_acum)

t_dep <- aggregate(pruebas_acum ~ fecha + departamento, t_dep, sum)
t_dep$dia <- aux_fechas$num_dia[match(t_dep$fecha,aux_fechas$fecha)]
t_dep$pruebas_dia <- NA

# pruebas diarias
lista_dep <- unique(t_dep$departamento)
i <- lista_dep[1]
for (i in lista_dep) {
  aux <- subset(t_dep, departamento == i)
  lista_dias <- unique(aux$dia)
  j <- lista_dias[2]
  for (j in lista_dias) {
    t_dep$pruebas_dia[match(paste(i,j),paste(t_dep$departamento,t_dep$dia))] <- aux$pruebas_acum[match(j,aux$dia)] - aux$pruebas_acum[match(j-1,aux$dia)]
  }
  rm(j,lista_dias)
}
rm(i,lista_dep)

t_dep$pruebas_dia <- ifelse(t_dep$pruebas_dia < 0, NA, t_dep$pruebas_dia)

# pruebas per capita
t_dep$departamento <- toupper(t_dep$departamento)
t_dep$habitantes <- info_dep$pob_total[match(t_dep$departamento,info_dep$departamento)]
t_dep$pruebas_hab <- t_dep$pruebas_dia / t_dep$habitantes * 1000
t_dep$pruebas_hab_acum <- t_dep$pruebas_acum / t_dep$habitantes * 1000

# promedio movil de pruebas per capita
t_dep$prom_diario <- NA
lista_depart <- as.character(unique(t_dep$departamento))
i <- lista_depart[1]
for (i in lista_depart) {
  aux_1 <- subset(t_dep, departamento == i)
  lista_dias <- aux_1$dia[7:length(aux_1$dia)]
  j <- lista_dias[1]
  for (j in lista_dias) {
    k <- j-6
    aux_2 <- subset(aux_1, dia >= k & dia <= j)
    t_dep$prom_diario[match(paste(i,j),paste(t_dep$departamento,t_dep$dia))] <- sum(aux_2$pruebas_hab)/7
  }
  rm(j,k,lista_dias,aux_2)
}
rm(i,lista_depart,aux_1)

# exportar dataframe
#write.csv(t_dep, paste("outputs/",reciente,"_pruebas_dep.csv"))

```

```{r pruebas diarias por departamento, eval=FALSE, include=FALSE}
# data frame con anotaciones
anno_text <- data.frame(departamento = unique(t_dep$departamento),x1=as.Date(NA),y1=NA,label_1=NA)

anno_text$x1[length(anno_text$departamento)] <- as.Date("2020-06-01")
anno_text$y1[length(anno_text$departamento)] <- 2
anno_text$label_1[length(anno_text$departamento)] <- "@rundav5"

ggplot(t_dep) +
  geom_area(aes(x=fecha,y=prom_diario,fill=departamento)) +
  facet_wrap(~ departamento,ncol = 7) +
  scale_x_date(date_breaks="4 months",date_minor_breaks="1 month",date_labels="%m-%y'",limits=c(as.Date("2020-03-06"),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,100,2),sec.axis=sec_axis(~.,breaks=seq(0,100,2))) +
  theme_minimal() +
  theme(legend.position="none",
        title = element_text(),
        axis.text.x=element_text(angle=0,size=7),
        axis.text.y=element_text(size=7),
        strip.text = element_text(size=7),
        plot.caption=element_text(face="italic",hjust=0),
        ) +
  labs(y=NULL,
       x="Fecha reporte",
       title="Pruebas PCR diarias por 1,000 habitantes por departamento",subtitle="Promedio móvil de 7 días",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"y datos de población ajustada por cobertura del Censo\nNacional de Población y Vivienda 2018")) +
  
  # anotaciones
  geom_text(data=anno_text,aes(x=x1,y=y1,label=label_1),angle = 0, size = 3,col="#AEB6BF") 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_110.jpeg", sep = ""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r pruebas semanales por departamento, eval=FALSE, include=FALSE}
# semana
t_dep$semana <- isoweek(t_dep$fecha)
t_dep_sem <- aggregate(pruebas_hab ~ departamento + semana, t_dep, sum)

ggplot(t_dep_sem,aes(x=semana,y=pruebas_hab,fill=departamento)) +
  geom_bar(stat="identity",width=0.85) +
  #geom_line() +
  facet_wrap(~ departamento,
             ncol = 7,
             #scales = "free_y",
             ) +
  scale_x_continuous(breaks=seq(2,52,4)) +
  scale_y_continuous(breaks=seq(0,10000,10),sec.axis=sec_axis(~.,breaks=seq(0,10000,10))) +
  theme_minimal() +
  theme(legend.position="none",
        title = element_text(),
        axis.text.x=element_text(angle=0,size=7),
        axis.text.y=element_text(size=7),
        strip.text = element_text(size=7),
        plot.caption=element_text(face="italic",hjust=0),
        ) +
  labs(y=NULL,
       x="Semana del año",
       #y="pruebas  / 1,000 habitantes",
       title="Pruebas PCR semanales por 1,000 habitantes por departamento",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"y datos de población ajustada por\ncobertura del Censo Nacional de Población y Vivienda 2018")) +
  
  # anotaciones
  geom_text(aes(x=25,y=20,label=ifelse(departamento == "Vichada","@rundav5","")),size=3.5,col="#AEB6BF") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_111.jpeg", sep = ""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r pruebas acumuladas por departamento, eval=FALSE, include=FALSE}
t_dep_hoy <- subset(t_dep, fecha == fecha_datos)

# valor para todo Colombia
t_col_hab <- max(t_col$pruebas_acum)/info_dep$pob_total[1]*1000

ggplot(t_dep_hoy,aes(x=reorder(departamento,pruebas_hab_acum),y=pruebas_hab_acum,fill=pruebas_hab_acum)) +
  
  # usuario
  geom_text(x="Caqueta",y=140,label="@rundav5",col="#AEB6BF",size=3) +
  
  # datos
  geom_bar(stat="identity",width=0.85) +
  geom_text(aes(label=round(pruebas_hab_acum,1),col=pruebas_hab_acum),size=3,nudge_y=5) +
  coord_flip() +
  scale_fill_gradient(low="#E69F00",high="#e67f00") +
  scale_color_gradient(low="#E69F00",high="#e67f00") +
  scale_y_continuous(breaks=seq(0,10000,20),sec.axis=sec_axis(~.,breaks=seq(0,10000,20))) +
  geom_hline(yintercept=t_col_hab,col="#999999") +
  geom_point(x="Caqueta",y=t_col_hab,col="#999999") +
  geom_label(x="Caqueta",y=t_col_hab*2,label=paste("Colombia",round(t_col_hab,1)),size=3,fill="#999999",col="white") +
  theme_minimal() +
  theme(legend.position="none",axis.text.x=element_text(angle=0),axis.text.y=element_text(size=8),plot.caption=element_text(face="italic",hjust=0)) +
  labs(x=NULL,y="pruebas  / 1,000 habitantes",title="Pruebas acumuladas por 1,000 habitantes por departamento",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"y datos de población ajustada por\ncobertura del Censo Nacional de Población y Vivienda 2018"))

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_112.jpeg", sep = ""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r distribucion del tiempo de reporte por departamento, eval=FALSE, include=FALSE}
# construir tabla de departamentos con más casos a la fecha
c_depart_top <- aggregate(caso ~ departamento, data_col, length)
c_depart_top <- c_depart_top[order(-c_depart_top$caso),] # ordenar por número de casos
c_depart_top <- c_depart_top[1:12,] # seleccionar top 20
data_col_dep <- subset(data_col, departamento %in% c_depart_top$departamento)
rm(c_depart_top)

# construir tabla
c_depart <- as.data.frame(table(data_col_dep$fecha_sintom_diagno, data_col_dep$departamento))
colnames(c_depart) <- c("fecha","departamento","casos_dia")

# arreglar fecha y agregar dia
c_depart$fecha <- as.Date(c_depart$fecha)
c_depart$dia <- NA
c_depart$dia <- aux_fechas$num_dia[match(c_depart$fecha,aux_fechas$fecha)]

# construir grafica
ggplot(data_col_dep, aes(x=semana_reporte,y=tiempo_reporte,group=semana_reporte,fill=departamento),size=0.2) +
  
  # datos
  geom_boxplot(outlier.shape=NA,outlier.size=1,size=0.2) +
  scale_x_continuous(breaks=seq(2,52,4)) +
  scale_y_continuous(limits=c(0,30),minor_breaks=seq(0,30,2),sec.axis=sec_axis(~.)) +
  labs(title="Tiempo de reporte de casos por departamento",subtitle=paste("Los",length(unique(c_depart$departamento)),"departamentos con más casos | Sólo casos sintomáticos"),y="Días entre inicio de síntomas y fecha reporte",x="Semana reporte",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=0,size=7), 
        axis.title = element_text(size = 7),
        title = element_text(size = 7),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0),
        legend.position="none") +
  facet_wrap(~ departamento) +
  
  # anotaciones
  geom_text(aes(x=21,y=28,label=ifelse(departamento == "VALLE","@rundav5","")),size=3.5,col="#AEB6BF") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_113.jpeg", sep = ""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r tiempo confiable de datos preliminares por departamento}
aux_ult_sem <- subset(data_col, semana_reporte == max(semana_reporte, na.rm = TRUE))

c_tiempo_reporte_dep <- aggregate(tiempo_reporte ~ departamento, aux_ult_sem, mean)
colnames(c_tiempo_reporte_dep)[2] <- "promedio"
c_tiempo_reporte_dep$percentil90 <- NA
c_tiempo_reporte_dep$percentil75 <- NA
c_tiempo_reporte_dep$percentil50 <- NA

lista <- unique(aux_ult_sem$departamento)
i <- lista[1]
for (i in lista) {
  aux <- subset(aux_ult_sem, departamento == i)
  c_tiempo_reporte_dep$percentil90[match(i,c_tiempo_reporte_dep$departamento)] <- quantile(aux$tiempo_reporte,0.9,na.rm=TRUE)
    c_tiempo_reporte_dep$percentil75[match(i,c_tiempo_reporte_dep$departamento)] <- quantile(aux$tiempo_reporte,0.75,na.rm=TRUE)
    c_tiempo_reporte_dep$percentil50[match(i,c_tiempo_reporte_dep$departamento)] <- quantile(aux$tiempo_reporte,0.50,na.rm=TRUE)
  
}
rm(i,lista)

c_tiempo_reporte_dep$departamento <- ifelse(c_tiempo_reporte_dep$departamento == "Archipielago De San Andres Providencia Y Santa Catalina","San Andres y Providencia", c_tiempo_reporte_dep$departamento)

# construir grafica
ggplot(c_tiempo_reporte_dep,aes(x=reorder(departamento,percentil90),xend=reorder(departamento,percentil90))) +
  
  # usuario
  geom_text(x="CALDAS",y=26,label="@rundav5",col="#AEB6BF",size=3) +
  
  # datos
  #geom_bar(stat="identity",width=0.85,aes(y=percentil90,fill=percentil90)) +
  geom_segment(aes(y=0,yend=percentil90,color=percentil90)) +
  geom_point(aes(y=percentil90,color=percentil90,shape="Percentil 90")) +
  geom_point(aes(y=percentil75,color=percentil75,shape="Percentil 75")) +
  #geom_point(aes(y=percentil50,color=percentil50,shape="Percentil 50")) +
  geom_point(aes(y=promedio,shape="Promedio")) +
  geom_hline(yintercept = 0) +
  coord_flip() +
  scale_color_gradient(low="#E69F00",high="#e67f00",guide=FALSE) +
  scale_shape_manual(values=c(17,15,21)) +
  scale_y_continuous(limits=c(0,NA),breaks=seq(0,100,5),sec.axis=sec_axis(~.,breaks=seq(0,100,5))) +
  theme_minimal() +
  theme(legend.position="right",axis.text.x=element_text(angle=0),axis.text.y=element_text(size=8),plot.caption=element_text(face="italic",hjust=0)) +
  labs(x=NULL,color=NULL,shape=NULL,y="Días entre inicio de síntomas y reporte",title="Tiempo de reporte de casos por departamento en la última semana",
       #subtitle="Percentil 90 de la distribución del tiempo de reporte de la última semana",
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos))

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_114.jpeg", sep = ""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

### Casos

```{r casos semanales por departamento}
data_col$semana_sintom <- isoweek(data_col$fecha_sintom_diagno)
data_col$ano_sintom <- isoyear(data_col$fecha_sintom_diagno)
#data_col$ano_sem_sintom <- as.numeric(paste(data_col$ano_sintom,data_col$semana_sintom,sep = ""))

c_dep_all <- aggregate(caso ~ departamento + semana_sintom + ano_sintom, data_col, length)
c_dep_all$ano_sem <- NA
c_dep_all$ano_sem <- ifelse(c_dep_all$semana_sintom < 10,as.numeric(paste(c_dep_all$ano_sintom,0,c_dep_all$semana_sintom, sep = "")),as.numeric(paste(c_dep_all$ano_sintom,c_dep_all$semana_sintom, sep = "")))

c_dep_all$yr_wk <- NA
c_dep_all$yr_wk <- yearweek(paste(c_dep_all$ano_sintom, 'week', c_dep_all$semana_sintom))

# habitantes
c_dep_all$hab <- NA
c_dep_all$hab <- info_dep$pob_total[match(c_dep_all$departamento,info_dep$departamento)]

# casos por numero de habitantes
c_dep_all$casos_hab <- c_dep_all$caso / c_dep_all$hab * 1000

# maximo de casos semanales por departamento
c_dep_max <- data.frame(departamento = unique(c_dep_all$departamento), maximo=NA,semana=NA)
i <- c_dep_max$departamento[1]
for (i in c_dep_max$departamento) {
  aux1 <- subset(c_dep_all, departamento == i)
  c_dep_max$maximo[match(i,c_dep_max$departamento)] <- max(aux1$caso)
  c_dep_max$semana[match(i,c_dep_max$departamento)] <- aux1$ano_sem[match(max(aux1$caso),aux1$caso)]
}
rm(aux1)

c_dep_all$casos_max <- NA
c_dep_all$casos_max <- c_dep_all$caso / c_dep_max$maximo[match(c_dep_all$departamento,c_dep_max$departamento)]
c_dep_all$semana_max <- NA
c_dep_all$semana_max <- c_dep_max$semana[match(c_dep_all$departamento,c_dep_max$departamento)]
rm(c_dep_max)

# grafica
ggplot(c_dep_all) +
  geom_tile(colour="white", aes(x=yr_wk, y=reorder(departamento,-semana_max), fill=casos_max)) +
  geom_text(y="QUINDIO",x=14,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  #scale_x_yearweek(date_breaks="2 weeks", date_labels = "%U") + 
  scale_x_yearweek(date_breaks="4 weeks", date_minor_breaks="1 week", date_labels = "%d-%m") + 
  scale_fill_gradient(low="transparent",high="black") +
  theme_minimal() +
  theme(legend.position="none",plot.caption=element_text(face="italic",hjust=0),axis.text.y = element_text(angle = 0, size = 8)) +
  labs(y=NULL,x="Semana de inicio síntomas | diagnóstico para asintomáticos (día-mes)",fill=NULL,title="Casos semanales por departamento",subtitle = "El tono más oscuro corresponde al valor máximo para cada departamento",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos"))

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_100.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos por habitantes por departamento}

# grafica
ggplot(c_dep_all) +
  geom_tile(colour="white", aes(x=yr_wk, y=reorder(departamento,-semana_max), fill=casos_hab)) +
  geom_text(y="QUINDIO",x=14,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  #scale_x_yearweek(date_breaks="2 weeks", date_labels = "%U") + 
  scale_x_yearweek(date_breaks="4 weeks", date_minor_breaks="1 week", date_labels = "%d-%m") + 
  scale_fill_gradient(low="transparent",high="black") +
  theme_minimal() +
  theme(legend.position="none",plot.caption=element_text(face="italic",hjust=0),axis.text.y = element_text(angle = 0, size = 8)) +
  labs(y=NULL,x="Semana de inicio síntomas | diagnóstico para asintomáticos",fill=NULL,title="Casos semanales por departamento",subtitle = "El tono más oscuro corresponde al valor máximo para cada departamento",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos"))

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_1000.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos diarios por departamento}
# construir tabla
c_depart <- as.data.frame(table(data_col$fecha_sintom_diagno, data_col$departamento))
colnames(c_depart) <- c("fecha","departamento","casos_dia")

# arreglar fecha y agregar dia
c_depart$fecha <- as.Date(c_depart$fecha)
c_depart$dia <- NA
c_depart$dia <- aux_fechas$num_dia[match(c_depart$fecha,aux_fechas$fecha)]

# calcular promedio diario
c_depart$prom_diario <- NA
lista_depart <- as.character(unique(c_depart$departamento))
i <- lista_depart[1]
for (i in lista_depart) {
  aux_1 <- subset(c_depart, departamento == i)
  lista_dias <- aux_1$dia[7:length(aux_1$dia)]
  j <- lista_dias[1]
  for (j in lista_dias) {
    k <- j-6
    aux_2 <- subset(aux_1, dia >= k & dia <= j)
    c_depart$prom_diario[match(paste(i,j),paste(c_depart$departamento,c_depart$dia))] <- sum(aux_2$casos_dia)/7
  }
  rm(j,k,lista_dias,aux_2)
}
rm(i,lista_depart,aux_1)
```

```{r casos diarios por departamento grupo 1}
# filtrar departamentos por grupo
lista <- c("BOGOTA","VALLE","ANTIOQUIA","ATLANTICO","CUNDINAMARCA","SANTANDER")
c_depart_g <- subset(c_depart, departamento %in% lista)
rm(lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(c_depart_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x1[1] <- as.Date("2020-03-06")+5
anno_text$y1[1] <- 1500
anno_text$x2[1] <- as.Date("2020-03-25")+5
anno_text$y2[1] <- 1500
anno_text$x3[1] <- as.Date("2020-04-27")+5
anno_text$y3[1] <- 1500
anno_text$x4[1] <- as.Date("2020-09-01")+5
anno_text$y4[1] <- 1500
anno_text$x5[1] <- fecha_datos - 6
anno_text$y5[1] <- 1500
anno_text$x6[length(anno_text$departamento)] <- as.Date("2020-04-10")
anno_text$y6[length(anno_text$departamento)] <- 2000

anno_text$label_1[1] <- "Caso nº 1"
anno_text$label_2[1] <- "Aislamiento"
anno_text$label_3[1] <- "Apertura parcial"
anno_text$label_4[1] <- "Fin aislamiento"
anno_text$label_5[1] <- "Datos\npreliminares*"
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(c_depart_g,aes(x = fecha)) +

  # datos
  geom_bar(aes(y=casos_dia),fill="#AEB6BF",stat = "identity") +
  geom_line(aes(y=prom_diario),col="white",size=1.5) +
  geom_line(aes(y=prom_diario,col=departamento),size=0.8) +
  scale_x_date(date_breaks="3 months",date_labels="%m-%y'",limits=c(as.Date("2020-03-06"),fecha_datos+1)) +
  scale_y_continuous(labels=comma) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,
       title="Casos diarios en Bogotá, Valle del Cauca, Antioquia, Atlántico, Cundinamarca y Santander",
       subtitle=paste("Promedio móvil de 7 días"),
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 7),
        title = element_text(size = 7),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0, size= 7),
        legend.position = "none") +
  facet_wrap(~ departamento, nrow = 2 ,
             scales = "free_y"
             ) +
  
  # #1º confirmado
  # geom_segment(aes(x=as.Date("2020-03-06"),y=Inf,xend=as.Date("2020-03-06"),yend=0),col = "#999999",size = 0.3) +
  # geom_point(aes(x=as.Date("2020-03-06"),y=0), col = "#999999", size = 0.4) +

  # # aislamiento
  # geom_vline(xintercept = as.Date("2020-03-25")-0.5, size=0.2,colour="black") + 
  # geom_segment(aes(x=as.Date("2020-03-25")-0.5,y=0,yend=0),xend=as.Date("2020-09-01"),col="black",size=0.2) +
  # geom_point(aes(x=as.Date("2020-03-25")-0.5,y=0),col="black",size=0.3) +
  # 
  # # apertura parcial
  # geom_vline(xintercept=as.Date("2020-04-27")-0.5,size=0.2,colour="black",linetype="dashed") +
  # geom_point(aes(x=as.Date("2020-04-27")-0.5,y=0),col="black",size=0.3) +
  # 
  # # aislamiento selectivo
  # geom_vline(xintercept=as.Date("2020-09-01")-0.5,size=0.2,colour="black") +
  # geom_point(aes(x=as.Date("2020-09-01")-0.5,y=0),col="black",size=0.3) +

  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0", alpha = 0.01, col = NA) +
  geom_vline(xintercept = fecha_datos-confianza_casos-0.5, size=0.4,colour="white") +

  # anotaciones
  # geom_text(data=anno_text,aes(x=x1,y=y1,label=label_1),angle=90,size=2,col="#999999") +
  # geom_text(data=anno_text,aes(x=x2,y=y2,label=label_2),angle=90,size=2,col="black") +
  # geom_text(data=anno_text,aes(x=x3,y=y3,label=label_3),angle=90,size=2,col="black") +
  # geom_text(data=anno_text,aes(x=x4,y=y4,label=label_4),angle=90,size=2,col="black") +
  # geom_text(data=anno_text,aes(x=x5,y=y5,label=label_5),angle=90,size=2,col="white") +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle=90,size=3,col="#AEB6BF") 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_101.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos diarios por departamento grupo 2}
# filtrar departamentos por grupo
lista <- c("BOLIVAR","CORDOBA","NARINO","NORTE SANTANDER","CAUCA","MAGDALENA")

c_depart_g <- subset(c_depart, departamento %in% lista)
rm(lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(c_depart_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x1[1] <- as.Date("2020-03-06")+5
anno_text$y1[1] <- 250
anno_text$x2[1] <- as.Date("2020-03-25")+5
anno_text$y2[1] <- 250
anno_text$x3[1] <- as.Date("2020-04-27")+5
anno_text$y3[1] <- 250
anno_text$x4[1] <- as.Date("2020-09-01")+5
anno_text$y4[1] <- 250
anno_text$x5[1] <- fecha_datos - 6
anno_text$y5[1] <- 250
anno_text$x6[length(anno_text$departamento)] <- as.Date("2020-04-10")
anno_text$y6[length(anno_text$departamento)] <- 400

anno_text$label_1[1] <- "Caso nº 1"
anno_text$label_2[1] <- "Aislamiento"
anno_text$label_3[1] <- "Apertura parcial"
anno_text$label_4[1] <- "Fin aislamiento"
anno_text$label_5[1] <- "Datos\npreliminares*"
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(c_depart_g,aes(x = fecha)) +

  # datos
  geom_bar(aes(y=casos_dia),fill="#AEB6BF",stat = "identity") +
  geom_line(aes(y=prom_diario),col="white",size=1.5) +
  geom_line(aes(y=prom_diario,col=departamento),size=0.8) +
  scale_x_date(date_breaks="3 months",date_labels="%m-%y'",limits=c(as.Date("2020-03-06"),fecha_datos+1)) +
  scale_y_continuous(labels=comma) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,
       title="Casos diarios en Bolívar, Córdoba, Nariño, Norte de Santander, Cauca y Magdalena",
       subtitle=paste("Promedio móvil de 7 días"),
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 7),
        title = element_text(size = 7),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0, size= 7),
        legend.position = "none") +
  facet_wrap(~ departamento, nrow = 2 , 
             scales = "free_y"
             ) +
  
  # #1º confirmado
  # geom_segment(aes(x=as.Date("2020-03-06"),y=Inf,xend=as.Date("2020-03-06"),yend=0),col = "#999999",size = 0.3) +
  # geom_point(aes(x=as.Date("2020-03-06"),y=0), col = "#999999", size = 0.4) +
  # 
  # # aislamiento
  # geom_vline(xintercept = as.Date("2020-03-25")-0.5, size=0.2,colour="black") + 
  # geom_segment(aes(x=as.Date("2020-03-25")-0.5,y=0,yend=0),xend=as.Date("2020-09-01"),col="black",size=0.2) +
  # geom_point(aes(x=as.Date("2020-03-25")-0.5,y=0),col="black",size=0.3) +
  # 
  # # apertura parcial
  # geom_vline(xintercept=as.Date("2020-04-27")-0.5,size=0.2,colour="black",linetype="dashed") +
  # geom_point(aes(x=as.Date("2020-04-27")-0.5,y=0),col="black",size=0.3) +
  # 
  # # aislamiento selectivo
  # geom_vline(xintercept=as.Date("2020-09-01")-0.5,size=0.2,colour="black") +
  # geom_point(aes(x=as.Date("2020-09-01")-0.5,y=0),col="black",size=0.3) +

  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0", alpha = 0.01, col = NA) +
  geom_vline(xintercept = fecha_datos-confianza_casos-0.5, size=0.4,colour="white") +

  # anotaciones
  # geom_text(data=anno_text,aes(x=x1,y=y1,label=label_1),angle = 90, size = 2,col="#999999") +
  # geom_text(data=anno_text,aes(x=x2,y=y2,label=label_2),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x3,y=y3,label=label_3),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x4,y=y4,label=label_4),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x5,y=y5,label=label_5),angle = 90, size = 2,col="white") +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle = 90, size = 3,col="#AEB6BF") 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_102.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos diarios por departamento grupo 3}
# filtrar departamentos por grupo
lista <- c("TOLIMA","BOYACA","CESAR","HUILA","META","CALDAS")

c_depart_g <- subset(c_depart, departamento %in% lista)
rm(lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(c_depart_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x1[1] <- as.Date("2020-03-06")+5
anno_text$y1[1] <- 200
anno_text$x2[1] <- as.Date("2020-03-25")+5
anno_text$y2[1] <- 200
anno_text$x3[1] <- as.Date("2020-04-27")+5
anno_text$y3[1] <- 200
anno_text$x4[1] <- as.Date("2020-09-01")+5
anno_text$y4[1] <- 200
anno_text$x5[1] <- fecha_datos - 6
anno_text$y5[1] <- 200
anno_text$x6[length(anno_text$departamento)] <- as.Date("2020-04-10")
anno_text$y6[length(anno_text$departamento)] <- 600

anno_text$label_1[1] <- "Caso nº 1"
anno_text$label_2[1] <- "Aislamiento"
anno_text$label_3[1] <- "Apertura parcial"
anno_text$label_4[1] <- "Fin aislamiento"
anno_text$label_5[1] <- "Datos\npreliminares*"
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(c_depart_g,aes(x = fecha)) +

  # datos
  geom_bar(aes(y=casos_dia),fill="#AEB6BF",stat = "identity") +
  geom_line(aes(y=prom_diario),col="white",size=1.5) +
  geom_line(aes(y=prom_diario,col=departamento),size=0.8) +
  scale_x_date(date_breaks="3 months",date_labels="%m-%y'",limits=c(as.Date("2020-03-06"),fecha_datos+1)) +
  scale_y_continuous(labels=comma) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,
       title="Casos diarios en Tolima, Boyacá, Cesar, Huila, Meta y Caldas",
       subtitle=paste("Promedio móvil de 7 días"),
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 7),
        title = element_text(size = 7),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0, size= 7),
        legend.position = "none") +
  facet_wrap(~ departamento, nrow = 2 , 
             scales = "free_y"
             ) +
  
  # #1º confirmado
  # geom_segment(aes(x=as.Date("2020-03-06"),y=Inf,xend=as.Date("2020-03-06"),yend=0),col = "#999999",size = 0.3) +
  # geom_point(aes(x=as.Date("2020-03-06"),y=0), col = "#999999", size = 0.4) +
  # 
  # # aislamiento
  # geom_vline(xintercept = as.Date("2020-03-25")-0.5, size=0.2,colour="black") + 
  # geom_segment(aes(x=as.Date("2020-03-25")-0.5,y=0,yend=0),xend=as.Date("2020-09-01"),col="black",size=0.2) +
  # geom_point(aes(x=as.Date("2020-03-25")-0.5,y=0),col="black",size=0.3) +
  # 
  # # apertura parcial
  # geom_vline(xintercept=as.Date("2020-04-27")-0.5,size=0.2,colour="black",linetype="dashed") +
  # geom_point(aes(x=as.Date("2020-04-27")-0.5,y=0),col="black",size=0.3) +
  # 
  # # aislamiento selectivo
  # geom_vline(xintercept=as.Date("2020-09-01")-0.5,size=0.2,colour="black") +
  # geom_point(aes(x=as.Date("2020-09-01")-0.5,y=0),col="black",size=0.3) +

  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0", alpha = 0.01, col = NA) +
  geom_vline(xintercept = fecha_datos-confianza_casos-0.5, size=0.4,colour="white") +

  # anotaciones
  # geom_text(data=anno_text,aes(x=x1,y=y1,label=label_1),angle = 90, size = 2,col="#999999") +
  # geom_text(data=anno_text,aes(x=x2,y=y2,label=label_2),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x3,y=y3,label=label_3),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x4,y=y4,label=label_4),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x5,y=y5,label=label_5),angle = 90, size = 2,col="white") +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle = 90, size = 3,col="#AEB6BF") 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_103.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos diarios por departamento grupo 4}
# filtrar departamentos por grupo
lista <- c("RISARALDA","SUCRE","GUAJIRA","QUINDIO","CHOCO","CASANARE")

c_depart_g <- subset(c_depart, departamento %in% lista)
rm(lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(c_depart_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x1[1] <- as.Date("2020-03-06")+5
anno_text$y1[1] <- 150
anno_text$x2[1] <- as.Date("2020-03-25")+5
anno_text$y2[1] <- 150
anno_text$x3[1] <- as.Date("2020-04-27")+5
anno_text$y3[1] <- 150
anno_text$x4[1] <- as.Date("2020-09-01")+5
anno_text$y4[1] <- 150
anno_text$x5[1] <- fecha_datos - 6
anno_text$y5[1] <- 150
anno_text$x6[length(anno_text$departamento)] <- as.Date("2020-04-10")
anno_text$y6[length(anno_text$departamento)] <- 400

anno_text$label_1[1] <- "Caso nº 1"
anno_text$label_2[1] <- "Aislamiento"
anno_text$label_3[1] <- "Apertura parcial"
anno_text$label_4[1] <- "Fin aislamiento"
anno_text$label_5[1] <- "Datos\npreliminares*"
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(c_depart_g,aes(x = fecha)) +

  # datos
  geom_bar(aes(y=casos_dia),fill="#AEB6BF",stat = "identity") +
  geom_line(aes(y=prom_diario),col="white",size=1.5) +
  geom_line(aes(y=prom_diario,col=departamento),size=0.8) +
  scale_x_date(date_breaks="3 months",date_labels="%m-%y'",limits=c(as.Date("2020-03-06"),fecha_datos+1)) +
  scale_y_continuous(labels=comma) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,
       title="Casos diarios en Risaralda, Sucre, La Guajira, Quindío, Chocó y Casanare",
       subtitle=paste("Promedio móvil de 7 días"),
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 7),
        title = element_text(size = 7),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0, size= 7),
        legend.position = "none") +
  facet_wrap(~ departamento, nrow = 2 , 
             scales = "free_y"
             ) +
  
  # #1º confirmado
  # geom_segment(aes(x=as.Date("2020-03-06"),y=Inf,xend=as.Date("2020-03-06"),yend=0),col = "#999999",size = 0.3) +
  # geom_point(aes(x=as.Date("2020-03-06"),y=0), col = "#999999", size = 0.4) +
  # 
  # # aislamiento
  # geom_vline(xintercept = as.Date("2020-03-25")-0.5, size=0.2,colour="black") + 
  # geom_segment(aes(x=as.Date("2020-03-25")-0.5,y=0,yend=0),xend=as.Date("2020-09-01"),col="black",size=0.2) +
  # geom_point(aes(x=as.Date("2020-03-25")-0.5,y=0),col="black",size=0.3) +
  # 
  # # apertura parcial
  # geom_vline(xintercept=as.Date("2020-04-27")-0.5,size=0.2,colour="black",linetype="dashed") +
  # geom_point(aes(x=as.Date("2020-04-27")-0.5,y=0),col="black",size=0.3) +
  # 
  # # aislamiento selectivo
  # geom_vline(xintercept=as.Date("2020-09-01")-0.5,size=0.2,colour="black") +
  # geom_point(aes(x=as.Date("2020-09-01")-0.5,y=0),col="black",size=0.3) +

  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0", alpha = 0.01, col = NA) +
  geom_vline(xintercept = fecha_datos-confianza_casos-0.5, size=0.4,colour="white") +

  # anotaciones
  # geom_text(data=anno_text,aes(x=x1,y=y1,label=label_1),angle = 90, size = 2,col="#999999") +
  # geom_text(data=anno_text,aes(x=x2,y=y2,label=label_2),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x3,y=y3,label=label_3),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x4,y=y4,label=label_4),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x5,y=y5,label=label_5),angle = 90, size = 2,col="white") +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle = 90, size = 3,col="#AEB6BF") 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_104.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos diarios por departamento grupo 5}
# filtrar departamentos por grupo
lista <- c("CAQUETA","PUTUMAYO","ARAUCA","GUAVIARE","VICHADA","AMAZONAS","SAN ANDRES","GUAINIA","VAUPES")
c_depart_g <- subset(c_depart, departamento %in% lista)
rm(lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(c_depart_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x1[1] <- as.Date("2020-03-06")+5
anno_text$y1[1] <- 75
anno_text$x2[1] <- as.Date("2020-03-25")+5
anno_text$y2[1] <- 75
anno_text$x3[1] <- as.Date("2020-04-27")+5
anno_text$y3[1] <- 75
anno_text$x4[1] <- as.Date("2020-09-01")+5
anno_text$y4[1] <- 75
anno_text$x5[1] <- fecha_datos - 6
anno_text$y5[1] <- 75
anno_text$x6[length(anno_text$departamento)] <- as.Date("2020-04-10")
anno_text$y6[length(anno_text$departamento)] <- 40

anno_text$label_1[1] <- "Caso nº 1"
anno_text$label_2[1] <- "Aislamiento"
anno_text$label_3[1] <- "Apertura parcial"
anno_text$label_4[1] <- "Fin aislamiento"
anno_text$label_5[1] <- "Datos\npreliminares*"
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(c_depart_g,aes(x = fecha)) +

  # datos
  geom_bar(aes(y=casos_dia),fill="#AEB6BF",stat = "identity") +
  geom_line(aes(y=prom_diario),col="white",size=1.5) +
  geom_line(aes(y=prom_diario,col=departamento),size=0.8) +
  scale_x_date(date_breaks="3 months",date_labels="%m-%y'",limits=c(as.Date("2020-03-06"),fecha_datos+1)) +
  scale_y_continuous(labels=comma) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,
       title="Casos diarios en Caquetá, Putumayo, Arauca, Guaviare, Vichada, Amazonas, San Andrés y Providencia, Guainía y Vaupés",
       subtitle=paste("Promedio móvil de 7 días"),
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 7),
        title = element_text(size = 7),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0, size= 7),
        legend.position = "none") +
  facet_wrap(~ departamento, nrow = 3 , 
             scales = "free_y"
             ) +
  
  # #1º confirmado
  # geom_segment(aes(x=as.Date("2020-03-06"),y=Inf,xend=as.Date("2020-03-06"),yend=0),col = "#999999",size = 0.3) +
  # geom_point(aes(x=as.Date("2020-03-06"),y=0), col = "#999999", size = 0.4) +
  # 
  # # aislamiento
  # geom_vline(xintercept = as.Date("2020-03-25")-0.5, size=0.2,colour="black") + 
  # geom_segment(aes(x=as.Date("2020-03-25")-0.5,y=0,yend=0),xend=as.Date("2020-09-01"),col="black",size=0.2) +
  # geom_point(aes(x=as.Date("2020-03-25")-0.5,y=0),col="black",size=0.3) +
  # 
  # # apertura parcial
  # geom_vline(xintercept=as.Date("2020-04-27")-0.5,size=0.2,colour="black",linetype="dashed") +
  # geom_point(aes(x=as.Date("2020-04-27")-0.5,y=0),col="black",size=0.3) +
  # 
  # # aislamiento selectivo
  # geom_vline(xintercept=as.Date("2020-09-01")-0.5,size=0.2,colour="black") +
  # geom_point(aes(x=as.Date("2020-09-01")-0.5,y=0),col="black",size=0.3) +

  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0", alpha = 0.01, col = NA) +
  geom_vline(xintercept = fecha_datos-confianza_casos-0.5, size=0.4,colour="white") +

  # anotaciones
  # geom_text(data=anno_text,aes(x=x1,y=y1,label=label_1),angle = 90, size = 2,col="#999999") +
  # geom_text(data=anno_text,aes(x=x2,y=y2,label=label_2),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x3,y=y3,label=label_3),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x4,y=y4,label=label_4),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x5,y=y5,label=label_5),angle = 90, size = 2,col="white") +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle = 90, size = 3,col="#AEB6BF") 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_105.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos relacionados por departamento, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
c_col_tipo_dep <- aggregate(caso ~ departamento + fecha_sintom_diagno + tipo, data_col_dep, length)

c_col_tipo_dep$fecha_sintom_diagno <- as.Date(c_col_tipo_dep$fecha_sintom_diagno)
colnames(c_col_tipo_dep)[2] <- "fecha"
colnames(c_col_tipo_dep)[4] <- "casos"

c_col_tipo_dep$dia <- NA
c_col_tipo_dep$dia <- aux_fechas$num_dia[match(as.character(c_col_tipo_dep$fecha),as.character(aux_fechas$fecha))]


# calcular proporcion
c_col_tipo_dep$prop <- NA
lista_dep <- unique(c_col_tipo_dep$departamento)
#i <- lista_dep[1]
for (i in lista_dep) {
  aux_1 <- subset(c_col_tipo_dep, departamento == i)
  lista_dias <- unique(c_col_tipo_dep$dia)
  #j <- lista_dias[1]
  for (j in lista_dias) {
    aux_2 <- subset(aux_1, dia == j)
    aux_2$prop <- aux_2$casos / sum(aux_2$casos,na.rm=TRUE)
    lista_tipos <- unique(aux_2$tipo)
    #k <- lista_tipos[1]
    for (k in lista_tipos) {
      aux_3 <- subset(aux_2, tipo == k)
      aux_3 <- aux_3$prop
      c_col_tipo_dep$prop[match(paste(i,j,k),paste(c_col_tipo_dep$departamento,c_col_tipo_dep$dia,c_col_tipo_dep$tipo))] <- aux_3
    }
    rm(aux_3,k,lista_tipos)
  }
  rm(aux_2,lista_dias,j)
}
rm(aux_1,lista_dep,i)

# construir grafica
ggplot(subset(c_col_tipo_dep, tipo == "Relacionado"),aes(x=fecha,y=prop)) +
  
  # datos
  #geom_area(position="fill",alpha = 0.8,size=0.5,col="white") +
  stat_smooth(geom = 'area', method = 'loess', span = 1/3,alpha = 0.8, fill="#E69F00", col="#E69F00") + 
  scale_x_date(date_breaks="3 months",date_labels="%m-%y'",limits=c(as.Date("2020-03-06"),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,1,0.5),labels=percent, sec.axis = sec_axis(~.,breaks=seq(0,1,0.5),labels=percent)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 7),
        title = element_text(size = 7),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.position="none") +
  facet_wrap(~ departamento) +
  theme(legend.position = "none") +
  labs(col=NULL,x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,title="Proporción de casos relacionados por departamento",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  
  # anotaciones
  geom_text(aes(x=as.Date("2020-07-01"),y=0.75,label=ifelse(departamento == "Valle del Cauca","@rundav5","")),size=3.5,col="#AEB6BF") 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_109.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)
```

```{r calcular proporcion de asintomaticos por departamento}
c_dep_sintomas <- aggregate(caso ~ departamento + fecha_sintom_diagno + sintomas, data_col, length)
colnames(c_dep_sintomas)[2] <- "fecha"
colnames(c_dep_sintomas)[4] <- "casos"
c_dep_sintomas$fecha <- as.Date(c_dep_sintomas$fecha)

# arreglar fecha y agregar dia
#c_col_sintomas$fecha <- as.Date(c_col_sintomas$fecha)
c_dep_sintomas$dia <- NA
c_dep_sintomas$dia <- aux_fechas$num_dia[match(as.character(c_dep_sintomas$fecha),as.character(aux_fechas$fecha))]

# calcular porcentaje de asintomáticos
aux <- aggregate(caso ~ departamento + fecha_sintom_diagno, data_col, length)

c_dep_sintomas$prop <- c_dep_sintomas$casos / aux$caso[match(paste(c_dep_sintomas$departamento,c_dep_sintomas$fecha),paste(aux$departamento,aux$fecha_sintom_diagno))]
rm(aux)

# dejar sólo asintomáticos
c_dep_sintomas <- subset(c_dep_sintomas, sintomas == "Asintomático")

# calcular promedio movil de proporcion de asintomaticos
c_dep_sintomas$prom_diario <- NA
lista_depart <- as.character(unique(c_dep_sintomas$departamento))
i <- lista_depart[1]
for (i in lista_depart) {
  aux_1 <- subset(c_dep_sintomas, departamento == i)
  lista_dias <- aux_1$dia[7:length(aux_1$dia)]
  j <- lista_dias[1]
  for (j in lista_dias) {
    k <- j-6
    aux_2 <- subset(aux_1, dia >= k & dia <= j)
    c_dep_sintomas$prom_diario[match(paste(i,j),paste(c_dep_sintomas$departamento,c_dep_sintomas$dia))] <- sum(aux_2$prop)/7
  }
  rm(j,k,lista_dias,aux_2)
}
rm(i,lista_depart,aux_1)
```

```{r proporcion de asintomaticos por departamento grupo 1}
# filtrar departamentos por grupo
#lista <- c("BOGOTA","VALLE","ANTIOQUIA","ATLANTICO","CUNDINAMARCA","SANTANDER","BOLIVAR","CORDOBA","NARINO","NORTE SANTANDER","CAUCA","MAGDALENA")
lista <- c("BOGOTA","VALLE","ANTIOQUIA","ATLANTICO","CUNDINAMARCA","SANTANDER","BOLIVAR","CORDOBA","NARINO","NORTE SANTANDER","CAUCA","MAGDALENA")

c_dep_sintomas_g <- subset(c_dep_sintomas, departamento %in% lista)
rm(lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(c_dep_sintomas_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x1[1] <- as.Date("2020-03-06")+5
anno_text$y1[1] <- 75
anno_text$x2[1] <- as.Date("2020-03-25")+5
anno_text$y2[1] <- 75
anno_text$x3[1] <- as.Date("2020-04-27")+5
anno_text$y3[1] <- 75
anno_text$x4[1] <- as.Date("2020-09-01")+5
anno_text$y4[1] <- 75
anno_text$x5[1] <- fecha_datos - 6
anno_text$y5[1] <- 0.5
anno_text$x6[length(anno_text$departamento)] <- as.Date("2020-04-10")
anno_text$y6[length(anno_text$departamento)] <- 0.5

anno_text$label_1[1] <- "Caso nº 1"
anno_text$label_2[1] <- "Aislamiento"
anno_text$label_3[1] <- "Apertura parcial"
anno_text$label_4[1] <- "Fin aislamiento"
anno_text$label_5[1] <- "Datos\npreliminares*"
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(c_dep_sintomas_g,aes(x=fecha,y=prop)) +
  
  # datos
  #geom_line(size=0.5,col="#D55E00") +
  stat_smooth(geom = 'area', method = 'loess', span = 1/3,alpha = 0.8, fill="#D55E00", col="#D55E00") + 
  scale_x_date(date_breaks="3 month",date_labels="%m-%y'",limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(limits = c(0,1.1),breaks=seq(0,1,0.2),minor_breaks=seq(0,1,0.1),labels=percent,sec.axis=sec_axis(~.,breaks=seq(0,1,0.2),labels=percent)) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",
       y=NULL,fill=NULL,title="Porcentaje de casos asintomáticos por departamento",color=NULL,caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",plot.caption=element_text(face="italic",hjust=0)) +
  facet_wrap(~departamento) +

  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0", alpha = 0.01, col = NA) +
  geom_vline(xintercept = fecha_datos-confianza_casos-0.5, size=0.4,colour="white") +

  # anotaciones
  #geom_text(data=anno_text,aes(x=x1,y=y1,label=label_1),angle = 90, size = 2,col="#999999") +
  #geom_text(data=anno_text,aes(x=x2,y=y2,label=label_2),angle = 90, size = 2,col="black") +
  #geom_text(data=anno_text,aes(x=x3,y=y3,label=label_3),angle = 90, size = 2,col="black") +
  #geom_text(data=anno_text,aes(x=x4,y=y4,label=label_4),angle = 90, size = 2,col="black") +
  #geom_text(data=anno_text,aes(x=x5,y=y5,label=label_5),angle = 90, size = 2,col="white") +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle = 90, size = 3,col="#AEB6BF") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_109.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

### Muertes

```{r muertes semanales por departamento}
data_col_muertes$semana_muerte <- isoweek(data_col_muertes$fecha_muerte)
data_col_muertes$ano_muerte <- isoyear(data_col_muertes$fecha_muerte)

c_dep_all <- aggregate(caso ~ departamento + semana_muerte + ano_muerte, data_col_muertes, length)
c_dep_all$ano_sem <- NA
c_dep_all$ano_sem <- ifelse(c_dep_all$semana_muerte < 10,as.numeric(paste(c_dep_all$ano_muerte,0,c_dep_all$semana_muerte, sep = "")),as.numeric(paste(c_dep_all$ano_muerte,c_dep_all$semana_muerte, sep = "")))

c_dep_all$yr_wk <- NA
c_dep_all$yr_wk <- yearweek(paste(c_dep_all$ano_muerte, 'week', c_dep_all$semana_muerte))

# habitantes
c_dep_all$hab <- NA
c_dep_all$hab <- info_dep$pob_total[match(c_dep_all$departamento,info_dep$departamento)]

# casos por numero de habitantes
c_dep_all$casos_hab <- c_dep_all$caso / c_dep_all$hab * 1000

# maximo de casos semanales por departamento
c_dep_max <- data.frame(departamento = unique(c_dep_all$departamento), maximo=NA,semana=NA)
i <- c_dep_max$departamento[1]
for (i in c_dep_max$departamento) {
  aux1 <- subset(c_dep_all, departamento == i)
  c_dep_max$maximo[match(i,c_dep_max$departamento)] <- max(aux1$caso)
  c_dep_max$semana[match(i,c_dep_max$departamento)] <- aux1$ano_sem[match(max(aux1$caso),aux1$caso)]
}
rm(aux1)

c_dep_all$casos_max <- NA
c_dep_all$casos_max <- c_dep_all$caso / c_dep_max$maximo[match(c_dep_all$departamento,c_dep_max$departamento)]
c_dep_all$semana_max <- NA
c_dep_all$semana_max <- c_dep_max$semana[match(c_dep_all$departamento,c_dep_max$departamento)]
rm(c_dep_max)

# grafica
ggplot(c_dep_all) +
  geom_tile(colour="white", aes(x=yr_wk, y=reorder(departamento,-semana_max), fill=casos_max)) +
  geom_text(y="QUINDIO",x=14,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  #scale_x_yearweek(date_breaks="2 weeks", date_labels = "%U") + 
  scale_x_yearweek(date_breaks="4 weeks", date_minor_breaks="1 week", date_labels = "%d-%m") + 
  scale_fill_gradient(low="transparent",high="#76448A") +
  theme_minimal() +
  theme(legend.position="none",plot.caption=element_text(face="italic",hjust=0),axis.text.y = element_text(angle = 0, size = 8)) +
  labs(y=NULL,x="Semana de muerte (día-mes)",fill=NULL,title="Muertes semanales por departamento",subtitle = "El tono más oscuro corresponde al valor máximo para cada departamento",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos"))

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_120.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertes por habitantes por departamento}
# grafica
ggplot(c_dep_all) +
  geom_tile(colour="white", aes(x=yr_wk, y=reorder(departamento,-semana_max), fill=casos_hab)) +
  geom_text(y="QUINDIO",x=14,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  #scale_x_yearweek(date_breaks="2 weeks", date_labels = "%U") + 
  scale_x_yearweek(date_breaks="4 weeks", date_minor_breaks="1 week", date_labels = "%d-%m") + 
  scale_fill_gradient(low="transparent",high="#76448A") +
  theme_minimal() +
  theme(legend.position="none",plot.caption=element_text(face="italic",hjust=0),axis.text.y = element_text(angle = 0, size = 8)) +
  labs(y=NULL,x="Semana de muerte",fill=NULL,title="Muertes semanales por departamento",subtitle = "El tono más oscuro corresponde al valor máximo para cada departamento",caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"\n*El periodo de datos preliminares varía en función del tiempo de reporte de casos"))


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_1200.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertes diarias por departamento}
# construir tabla
m_depart <- aggregate(caso ~  fecha_muerte + departamento,data_col_muertes,length)
colnames(m_depart) <- c("fecha","departamento","casos_dia")

# arreglar fecha y agregar dia
m_depart$fecha <- as.Date(m_depart$fecha)
m_depart$dia <- NA
m_depart$dia <- aux_fechas$num_dia[match(m_depart$fecha,aux_fechas$fecha)]

# calcular promedio diario
m_depart$prom_diario <- NA
lista_depart <- as.character(unique(m_depart$departamento))

i <- lista_depart[1]
for (i in lista_depart) {
  aux_1 <- subset(m_depart, departamento == i)
  lista_dias <- aux_1$dia[7:length(aux_1$dia)]
  j <- lista_dias[1]
  for (j in lista_dias) {
    k <- j-6
    aux_2 <- subset(aux_1, dia >= k & dia <= j)
    m_depart$prom_diario[match(paste(i,j),paste(m_depart$departamento,m_depart$dia))] <- sum(aux_2$casos_dia)/7
  }
  rm(j,k,lista_dias,aux_2)
}
rm(i,lista_depart,aux_1)

```

```{r muertes diarias por departamento grupo 1}
# filtrar departamentos por grupo
lista <- c("BOGOTA","VALLE","ANTIOQUIA","ATLANTICO","CUNDINAMARCA","SANTANDER")
m_depart_g <- subset(m_depart, departamento %in% lista)
rm(lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(m_depart_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x1[1] <- as.Date("2020-03-06")+5
anno_text$y1[1] <- 20
anno_text$x2[1] <- as.Date("2020-03-25")+5
anno_text$y2[1] <- 20
anno_text$x3[1] <- as.Date("2020-04-27")+5
anno_text$y3[1] <- 20
anno_text$x4[1] <- as.Date("2020-09-01")+5
anno_text$y4[1] <- 20
anno_text$x5[1] <- fecha_datos - 2
anno_text$y5[1] <- 20
anno_text$x6[length(anno_text$departamento)] <- as.Date("2020-04-10")
anno_text$y6[length(anno_text$departamento)] <- 40

anno_text$label_1[1] <- "Caso nº 1"
anno_text$label_2[1] <- "Aislamiento"
anno_text$label_3[1] <- "Apertura parcial"
anno_text$label_4[1] <- "Fin aislamiento"
anno_text$label_5[1] <- "Datos\npreliminares"
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(m_depart_g,aes(x = fecha)) +

  # datos
  geom_bar(aes(y=casos_dia),fill="#AEB6BF",stat = "identity") +
  geom_line(aes(y=prom_diario),col="white",size=1.5) +
  geom_line(aes(y=prom_diario,col=prom_diario),size=0.8) +
  scale_x_date(date_breaks="3 months",date_labels="%m-%y'",limits=c(as.Date("2020-03-06"),fecha_datos+1)) +
  #scale_y_continuous(labels=comma) +
  scale_color_gradient(low="#CC79A7",high="#76448A") +
  labs(x="Fecha muerte",y=NULL,
       title="Muertes diarias en Bogotá, Valle del Cauca, Antioquia, Atlántico, Cundinamarca y Santander",
       subtitle=paste("Promedio móvil de 7 días"),
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 7),
        title = element_text(size = 7),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0, size= 7),
        legend.position = "none") +
  facet_wrap(~ departamento, nrow = 2 , 
             scales = "free_y"
             ) +
  
  # #1º confirmado
  # geom_segment(aes(x=as.Date("2020-03-06"),y=Inf,xend=as.Date("2020-03-06"),yend=0),col = "#999999",size = 0.3) +
  # geom_point(aes(x=as.Date("2020-03-06"),y=0), col = "#999999", size = 0.4) +
  # 
  # # aislamiento
  # geom_vline(xintercept = as.Date("2020-03-25")-0.5, size=0.2,colour="black") + 
  # geom_segment(aes(x=as.Date("2020-03-25")-0.5,y=0,yend=0),xend=as.Date("2020-09-01"),col="black",size=0.2) +
  # geom_point(aes(x=as.Date("2020-03-25")-0.5,y=0),col="black",size=0.3) +
  # 
  # # apertura parcial
  # geom_vline(xintercept=as.Date("2020-04-27")-0.5,size=0.2,colour="black",linetype="dashed") +
  # geom_point(aes(x=as.Date("2020-04-27")-0.5,y=0),col="black",size=0.3) +
  # 
  # # aislamiento selectivo
  # geom_vline(xintercept=as.Date("2020-09-01")-0.5,size=0.2,colour="black") +
  # geom_point(aes(x=as.Date("2020-09-01")-0.5,y=0),col="black",size=0.3) +

  # punto de confianza
  geom_rect(xmin=fecha_datos-14-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0", alpha = 0.01, col = NA) +
  geom_vline(xintercept = fecha_datos-14-0.5, size=0.4,colour="white") +

  # anotaciones
  # geom_text(data=anno_text,aes(x=x1,y=y1,label=label_1),angle = 90, size = 2,col="#999999") +
  # geom_text(data=anno_text,aes(x=x2,y=y2,label=label_2),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x3,y=y3,label=label_3),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x4,y=y4,label=label_4),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x5,y=y5,label=label_5),angle = 90, size = 2,col="white") +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle = 90, size = 3,col="#AEB6BF") 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_121.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)
```

```{r muertes diarias por departamento grupo 2}
# filtrar departamentos por grupo
lista <- c("BOLIVAR","CORDOBA","NARINO","NORTE SANTANDER","CAUCA","MAGDALENA")

m_depart_g <- subset(m_depart, departamento %in% lista)
rm(lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(m_depart_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x1[1] <- as.Date("2020-03-06")+5
anno_text$y1[1] <- 10
anno_text$x2[1] <- as.Date("2020-03-25")+5
anno_text$y2[1] <- 10
anno_text$x3[1] <- as.Date("2020-04-27")+5
anno_text$y3[1] <- 10
anno_text$x4[1] <- as.Date("2020-09-01")+5
anno_text$y4[1] <- 10
anno_text$x5[1] <- fecha_datos - 2
anno_text$y5[1] <- 10
anno_text$x6[length(anno_text$departamento)] <- as.Date("2020-04-10")
anno_text$y6[length(anno_text$departamento)] <- 15

anno_text$label_1[1] <- "Caso nº 1"
anno_text$label_2[1] <- "Aislamiento"
anno_text$label_3[1] <- "Apertura parcial"
anno_text$label_4[1] <- "Fin aislamiento"
anno_text$label_5[1] <- "Datos\npreliminares"
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(m_depart_g,aes(x = fecha)) +

  # datos
  geom_bar(aes(y=casos_dia),fill="#AEB6BF",stat = "identity") +
  geom_line(aes(y=prom_diario),col="white",size=1.5) +
  geom_line(aes(y=prom_diario,col=prom_diario),size=0.8) +
  scale_x_date(date_breaks="3 months",date_labels="%m-%y'",limits=c(as.Date("2020-03-06"),fecha_datos+1)) +
  #scale_y_continuous(labels=comma) +
  scale_color_gradient(low="#CC79A7",high="#76448A") +
  labs(x="Fecha muerte",y=NULL,
       title="Muertes diarias en Bolívar, Córdoba, Nariño, Norte de Santander, Cauca y Magdalena",
       #subtitle=paste("Promedio móvil de 7 días | Escala variable entre departamentos"),
       subtitle=paste("Promedio móvil de 7 días"),
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 7),
        title = element_text(size = 7),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0, size= 7),
        legend.position = "none") +
  facet_wrap(~ departamento, nrow = 2 , 
             scales = "free_y"
             ) +
  
  # #1º confirmado
  # geom_segment(aes(x=as.Date("2020-03-06"),y=Inf,xend=as.Date("2020-03-06"),yend=0),col = "#999999",size = 0.3) +
  # geom_point(aes(x=as.Date("2020-03-06"),y=0), col = "#999999", size = 0.4) +
  # 
  # # aislamiento
  # geom_vline(xintercept = as.Date("2020-03-25")-0.5, size=0.2,colour="black") + 
  # geom_segment(aes(x=as.Date("2020-03-25")-0.5,y=0,yend=0),xend=as.Date("2020-09-01"),col="black",size=0.2) +
  # geom_point(aes(x=as.Date("2020-03-25")-0.5,y=0),col="black",size=0.3) +
  # 
  # # apertura parcial
  # geom_vline(xintercept=as.Date("2020-04-27")-0.5,size=0.2,colour="black",linetype="dashed") +
  # geom_point(aes(x=as.Date("2020-04-27")-0.5,y=0),col="black",size=0.3) +
  # 
  # # aislamiento selectivo
  # geom_vline(xintercept=as.Date("2020-09-01")-0.5,size=0.2,colour="black") +
  # geom_point(aes(x=as.Date("2020-09-01")-0.5,y=0),col="black",size=0.3) +

  # punto de confianza
  geom_rect(xmin=fecha_datos-14-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0", alpha = 0.01, col = NA) +
  geom_vline(xintercept = fecha_datos-14-0.5, size=0.4,colour="white") +

  # anotaciones
  # geom_text(data=anno_text,aes(x=x1,y=y1,label=label_1),angle = 90, size = 2,col="#999999") +
  # geom_text(data=anno_text,aes(x=x2,y=y2,label=label_2),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x3,y=y3,label=label_3),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x4,y=y4,label=label_4),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x5,y=y5,label=label_5),angle = 90, size = 2,col="white") +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle = 90, size = 3,col="#AEB6BF") 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_122.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)
```

```{r muertes diarias por departamento grupo 3}
# filtrar departamentos por grupo
lista <- c("TOLIMA","BOYACA","CESAR","HUILA","META","CALDAS")

m_depart_g <- subset(m_depart, departamento %in% lista)
rm(lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(m_depart_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x1[1] <- as.Date("2020-03-06")+5
anno_text$y1[1] <- 10
anno_text$x2[1] <- as.Date("2020-03-25")+5
anno_text$y2[1] <- 10
anno_text$x3[1] <- as.Date("2020-04-27")+5
anno_text$y3[1] <- 10
anno_text$x4[1] <- as.Date("2020-09-01")+5
anno_text$y4[1] <- 10
anno_text$x5[1] <- fecha_datos - 2
anno_text$y5[1] <- 10
anno_text$x6[length(anno_text$departamento)] <- as.Date("2020-04-10")
anno_text$y6[length(anno_text$departamento)] <- 15

anno_text$label_1[1] <- "Caso nº 1"
anno_text$label_2[1] <- "Aislamiento"
anno_text$label_3[1] <- "Apertura parcial"
anno_text$label_4[1] <- "Fin aislamiento"
anno_text$label_5[1] <- "Datos\npreliminares"
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(m_depart_g,aes(x = fecha)) +

  # datos
  geom_bar(aes(y=casos_dia),fill="#AEB6BF",stat = "identity") +
  geom_line(aes(y=prom_diario),col="white",size=1.5) +
  geom_line(aes(y=prom_diario,col=prom_diario),size=0.8) +
  scale_x_date(date_breaks="3 months",date_labels="%m-%y'",limits=c(as.Date("2020-03-06"),fecha_datos+1)) +
  scale_y_continuous() +
  scale_color_gradient(low="#CC79A7",high="#76448A") +
  labs(x="Fecha muerte",y=NULL,
       title="Muertes diarias en Tolima, Boyacá, Cesar, Huila, Meta y Caldas",
       subtitle=paste("Promedio móvil de 7 días"),
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 7),
        title = element_text(size = 7),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0, size= 7),
        legend.position = "none") +
  facet_wrap(~ departamento, nrow = 2 , 
             #scales = "free_y"
             ) +
  
  # #1º confirmado
  # geom_segment(aes(x=as.Date("2020-03-06"),y=Inf,xend=as.Date("2020-03-06"),yend=0),col = "#999999",size = 0.3) +
  # geom_point(aes(x=as.Date("2020-03-06"),y=0), col = "#999999", size = 0.4) +
  # 
  # # aislamiento
  # geom_vline(xintercept = as.Date("2020-03-25")-0.5, size=0.2,colour="black") + 
  # geom_segment(aes(x=as.Date("2020-03-25")-0.5,y=0,yend=0),xend=as.Date("2020-09-01"),col="black",size=0.2) +
  # geom_point(aes(x=as.Date("2020-03-25")-0.5,y=0),col="black",size=0.3) +
  # 
  # # apertura parcial
  # geom_vline(xintercept=as.Date("2020-04-27")-0.5,size=0.2,colour="black",linetype="dashed") +
  # geom_point(aes(x=as.Date("2020-04-27")-0.5,y=0),col="black",size=0.3) +
  # 
  # # aislamiento selectivo
  # geom_vline(xintercept=as.Date("2020-09-01")-0.5,size=0.2,colour="black") +
  # geom_point(aes(x=as.Date("2020-09-01")-0.5,y=0),col="black",size=0.3) +

  # punto de confianza
  geom_rect(xmin=fecha_datos-14-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0", alpha = 0.01, col = NA) +
  geom_vline(xintercept = fecha_datos-14-0.5, size=0.4,colour="white") +

  # anotaciones
  # geom_text(data=anno_text,aes(x=x1,y=y1,label=label_1),angle = 90, size = 2,col="#999999") +
  # geom_text(data=anno_text,aes(x=x2,y=y2,label=label_2),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x3,y=y3,label=label_3),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x4,y=y4,label=label_4),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x5,y=y5,label=label_5),angle = 90, size = 2,col="white") +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle = 90, size = 3,col="#AEB6BF") 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_123.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)
```

```{r muertes diarias por departamento grupo 4}
# filtrar departamentos por grupo
lista <- c("RISARALDA","SUCRE","GUAJIRA","QUINDIO","CHOCO","CASANARE")

m_depart_g <- subset(m_depart, departamento %in% lista)
rm(lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(m_depart_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x1[1] <- as.Date("2020-03-06")+5
anno_text$y1[1] <- 8
anno_text$x2[1] <- as.Date("2020-03-25")+5
anno_text$y2[1] <- 8
anno_text$x3[1] <- as.Date("2020-04-27")+5
anno_text$y3[1] <- 8
anno_text$x4[1] <- as.Date("2020-09-01")+5
anno_text$y4[1] <- 8
anno_text$x5[1] <- fecha_datos - 2
anno_text$y5[1] <- 8
anno_text$x6[length(anno_text$departamento)] <- as.Date("2020-04-10")
anno_text$y6[length(anno_text$departamento)] <- 8

anno_text$label_1[1] <- "Caso nº 1"
anno_text$label_2[1] <- "Aislamiento"
anno_text$label_3[1] <- "Apertura parcial"
anno_text$label_4[1] <- "Fin aislamiento"
anno_text$label_5[1] <- "Datos\npreliminares"
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(m_depart_g,aes(x = fecha)) +

  # datos
  geom_bar(aes(y=casos_dia),fill="#AEB6BF",stat = "identity") +
  geom_line(aes(y=prom_diario),col="white",size=1.5) +
  geom_line(aes(y=prom_diario,col=prom_diario),size=0.8) +
  scale_x_date(date_breaks="3 months",date_labels="%m-%y'",limits=c(as.Date("2020-03-06"),fecha_datos+1)) +
  #scale_y_continuous(labels=comma) +
  scale_color_gradient(low="#CC79A7",high="#76448A") +
  labs(x="Fecha muerte",y=NULL,
       title="Muertes diarias en Risaralda, Sucre, La Guajira, Quindío, Chocó y Casanare",
       subtitle=paste("Promedio móvil de 7 días"),
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 7),
        title = element_text(size = 7),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0, size= 7),
        legend.position = "none") +
  facet_wrap(~ departamento, nrow = 2 , 
             #scales = "free_y"
             ) +
  
  # #1º confirmado
  # geom_segment(aes(x=as.Date("2020-03-06"),y=Inf,xend=as.Date("2020-03-06"),yend=0),col = "#999999",size = 0.3) +
  # geom_point(aes(x=as.Date("2020-03-06"),y=0), col = "#999999", size = 0.4) +
  # 
  # # aislamiento
  # geom_vline(xintercept = as.Date("2020-03-25")-0.5, size=0.2,colour="black") + 
  # geom_segment(aes(x=as.Date("2020-03-25")-0.5,y=0,yend=0),xend=as.Date("2020-09-01"),col="black",size=0.2) +
  # geom_point(aes(x=as.Date("2020-03-25")-0.5,y=0),col="black",size=0.3) +
  # 
  # # apertura parcial
  # geom_vline(xintercept=as.Date("2020-04-27")-0.5,size=0.2,colour="black",linetype="dashed") +
  # geom_point(aes(x=as.Date("2020-04-27")-0.5,y=0),col="black",size=0.3) +
  # 
  # # aislamiento selectivo
  # geom_vline(xintercept=as.Date("2020-09-01")-0.5,size=0.2,colour="black") +
  # geom_point(aes(x=as.Date("2020-09-01")-0.5,y=0),col="black",size=0.3) +

  # punto de confianza
  geom_rect(xmin=fecha_datos-14-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0", alpha = 0.01, col = NA) +
  geom_vline(xintercept = fecha_datos-14-0.5, size=0.4,colour="white") +

  # anotaciones
  # geom_text(data=anno_text,aes(x=x1,y=y1,label=label_1),angle = 90, size = 2,col="#999999") +
  # geom_text(data=anno_text,aes(x=x2,y=y2,label=label_2),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x3,y=y3,label=label_3),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x4,y=y4,label=label_4),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x5,y=y5,label=label_5),angle = 90, size = 2,col="white") +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle = 90, size = 3,col="#AEB6BF") 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_124.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)
```

```{r muertes diarias por departamento grupo 5}
# filtrar departamentos por grupo
lista <- c("CAQUETA","PUTUMAYO","ARAUCA","GUAVIARE","VICHADA","AMAZONAS","SAN ANDRES","GUAINIA","VAUPES")

m_depart_g <- subset(m_depart, departamento %in% lista)
rm(lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(m_depart_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x1[1] <- as.Date("2020-03-06")+5
anno_text$y1[1] <- 6
anno_text$x2[1] <- as.Date("2020-03-25")+5
anno_text$y2[1] <- 6
anno_text$x3[1] <- as.Date("2020-04-27")+5
anno_text$y3[1] <- 6
anno_text$x4[1] <- as.Date("2020-09-01")+5
anno_text$y4[1] <- 6
anno_text$x5[1] <- fecha_datos - 2
anno_text$y5[1] <- 6
anno_text$x6[length(anno_text$departamento)] <- as.Date("2020-04-10")
anno_text$y6[length(anno_text$departamento)] <- 6

anno_text$label_1[1] <- "Caso nº 1"
anno_text$label_2[1] <- "Aislamiento"
anno_text$label_3[1] <- "Apertura parcial"
anno_text$label_4[1] <- "Fin aislamiento"
anno_text$label_5[1] <- "Datos\npreliminares"
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(m_depart_g,aes(x = fecha)) +

  # datos
  geom_bar(aes(y=casos_dia),fill="#AEB6BF",stat = "identity") +
  geom_line(aes(y=prom_diario),col="white",size=1.5) +
  geom_line(aes(y=prom_diario,col=prom_diario),size=0.8) +
  scale_x_date(date_breaks="3 months",date_labels="%m-%y'",limits=c(as.Date("2020-03-06"),fecha_datos+1)) +
  #scale_y_continuous(labels=comma) +
  scale_color_gradient(low="#CC79A7",high="#76448A") +
  labs(x="Fecha muerte",y=NULL,
       title="Muertes diarias en Caquetá, Putumayo, Arauca, Guaviare, Vichada, Amazonas, San Andrés y Providencia, Guanía y Vaupés",
       subtitle=paste("Promedio móvil de 7 días"),
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 7),
        title = element_text(size = 7),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0, size= 7),
        legend.position = "none") +
  facet_wrap(~ departamento, nrow = 3 , 
             #scales = "free_y"
             ) +
  
  # #1º confirmado
  # geom_segment(aes(x=as.Date("2020-03-06"),y=Inf,xend=as.Date("2020-03-06"),yend=0),col = "#999999",size = 0.3) +
  # geom_point(aes(x=as.Date("2020-03-06"),y=0), col = "#999999", size = 0.4) +
  # 
  # # aislamiento
  # geom_vline(xintercept = as.Date("2020-03-25")-0.5, size=0.2,colour="black") + 
  # geom_segment(aes(x=as.Date("2020-03-25")-0.5,y=0,yend=0),xend=as.Date("2020-09-01"),col="black",size=0.2) +
  # geom_point(aes(x=as.Date("2020-03-25")-0.5,y=0),col="black",size=0.3) +
  # 
  # # apertura parcial
  # geom_vline(xintercept=as.Date("2020-04-27")-0.5,size=0.2,colour="black",linetype="dashed") +
  # geom_point(aes(x=as.Date("2020-04-27")-0.5,y=0),col="black",size=0.3) +
  # 
  # # aislamiento selectivo
  # geom_vline(xintercept=as.Date("2020-09-01")-0.5,size=0.2,colour="black") +
  # geom_point(aes(x=as.Date("2020-09-01")-0.5,y=0),col="black",size=0.3) +

  # punto de confianza
  geom_rect(xmin=fecha_datos-14-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0", alpha = 0.01, col = NA) +
  geom_vline(xintercept = fecha_datos-14-0.5, size=0.4,colour="white") +

  # anotaciones
  # geom_text(data=anno_text,aes(x=x1,y=y1,label=label_1),angle = 90, size = 2,col="#999999") +
  # geom_text(data=anno_text,aes(x=x2,y=y2,label=label_2),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x3,y=y3,label=label_3),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x4,y=y4,label=label_4),angle = 90, size = 2,col="black") +
  # geom_text(data=anno_text,aes(x=x5,y=y5,label=label_5),angle = 90, size = 2,col="white") +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle = 90, size = 3,col="#AEB6BF") 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_125.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)
```

```{r muertes acumuladas por departamento}
# construir tabla
# m_depart_total <- aggregate(caso ~ departamento + cod_DIVIPOLA_departamento,data_col_muertes,length)
m_depart_total <- aggregate(caso ~ departamento,data_col_muertes,length)

m_depart_total$poblacion <- NA
# m_depart_total$poblacion <- info_dep$pob_total[match(m_depart_total$cod_DIVIPOLA_departamento,info_dep$cod_DIVIPOLA)]
m_depart_total$poblacion <- info_dep$pob_total[match(m_depart_total$departamento,info_dep$departamento)]

m_depart_total$tasa <- NA
m_depart_total$tasa <- (m_depart_total$caso/m_depart_total$poblacion)*100000


# valor para todo Colombia
m_col_hab <- (length(data_col_muertes$caso)/info_dep$pob_total[1])*100000

# construir grafica
ggplot(m_depart_total,aes(x=reorder(departamento,tasa),y=tasa,fill=tasa)) +
  geom_text(x="CAUCA",y=300,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  geom_bar(stat="identity", width = 0.85) +
  geom_text(aes(label=round(tasa,1),col=tasa),size=2.5,nudge_y=10) +
  geom_hline(yintercept=m_col_hab,col="#999999") +
  geom_point(x="GUAJIRA",y=m_col_hab,col="#999999") +
geom_label(x="GUAJIRA",y=m_col_hab*1.2,label=paste("Colombia",round(m_col_hab,1)),size=3,fill="#999999",col="white") +
  scale_fill_gradient(low="#CC79A7",high="#76448A") +
  scale_color_gradient(low="#CC79A7",high="#76448A") +
  scale_y_continuous(breaks=seq(0,500,50),sec.axis=sec_axis(~.,breaks=seq(0,500,50))) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position="none",plot.caption=element_text(face="italic",hjust=0),axis.text.y = element_text(angle = 0, size = 8)) +
  labs(subtitle="Muertes acumuladas por cada 100,000 habitantes por departamento",
       x=NULL,y=NULL,
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"y datos de población ajustada por\ncobertura del Censo Nacional de Población y Vivienda 2018"))

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_130.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

## Municipios

La tabla a continuación presenta el número de casos y muertes absolutas y normalizadas por población de todos los municipios de Colombia:

```{r casos por municipio}
c_mun_all <- aggregate(caso ~ ciudad + departamento + cod_DIVIPOLA_ciudad, data_col, length)
colnames(c_mun_all)[4] <- "casos"

c_mun_all$muertes <- NA
aux <- aggregate(caso ~ ciudad + departamento + cod_DIVIPOLA_ciudad, data_col_muertes, length)
c_mun_all$muertes <- aux$caso[match(c_mun_all$cod_DIVIPOLA_ciudad, aux$cod_DIVIPOLA_ciudad)]
rm(aux)

c_mun_all$poblacion <- NA
c_mun_all$poblacion <- info_mun$pob_total[match(c_mun_all$cod_DIVIPOLA_ciudad,info_mun$cod_DIVIPOLA)]

c_mun_all$casos_hab <- NA
c_mun_all$casos_hab <- c_mun_all$casos / c_mun_all$poblacion * 1000

c_mun_all$muertes_hab <- NA
c_mun_all$muertes_hab <- c_mun_all$muertes / c_mun_all$poblacion * 1000

c_mun_all$cod_DIVIPOLA_ciudad <- NULL
c_mun_all$poblacion <- NULL

c_mun_all <- c_mun_all[order(-c_mun_all$casos),]

datatable(c_mun_all, width = 800, style = "default", rownames = NULL, filter = "none", options = list(pageLength=20), caption = "Casos y muertes acumuladas por municipio en Colombia", colnames = c("Municipio","Departamento","Casos","Muertes", "Casos por 1,000 hab","Muertes por 1,000 hab")) %>% formatCurrency(c('casos_hab','muertes_hab'),currency = "", interval = 3, digits = 1,mark = ",")

```

```{r casos acumulados por edad y sexo en manizales, eval=FALSE, include=FALSE}
aux <- aggregate(caso ~ edad + estado_actual + sexo, subset(data_col, ciudad == "MANIZALES"), length)
colnames(aux)[4] <- "casos"
aux$casos_new <- ifelse(aux$sexo=="F",aux$casos*-1,aux$casos)

# construir grafica
ggplot(aux, aes(x = edad,y = casos_new,fill = estado_actual)) +
  geom_text(x=10,y=-10000,label="@rundav5",col="#AEB6BF",size=3)+ #usuario
  # datos 
  geom_bar(stat = "identity") +
  scale_x_continuous(breaks = seq(0,100,by=10),limits=c(0,100)) +
  scale_y_continuous(limits=c(-250,250),breaks=seq(-300,300,by=50),minor_breaks=seq(-300,300,10),labels=c(300,250,200,150,100,50,0,50,100,150,200,250,300),sec.axis=sec_axis(~.,breaks=seq(-300,300,50),labels=c(300,250,200,150,100,50,0,50,100,150,200,250,300))) +
  scale_fill_manual(values=c("#999999","#56B4E9","#0072B2","#CC79A7","#009E73")) +
  labs(x="Edad",y=NULL,title="Distribución de casos acumulados por edad y sexo en Manizales, Caldas",fill=NULL,caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos)) +
  theme_minimal() +
  theme(legend.position="right",plot.caption=element_text(face="italic",hjust=0)) +
  coord_flip() +
  geom_hline(yintercept = 0, size= 0.4) +
  geom_label(x=100,y=150,label="Hombres",size=3,fill="white") +
  geom_label(x=100,y=-150,label="Mujeres",size=3,fill="white")

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_aux.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos vs restricciones en bogota, eval=FALSE, include=FALSE}
# construir tabla de casos diarios por fecha de diagnóstico
c_bog <- subset(c_depart, departamento == "BOGOTA")

c_bog$mobility <- NA
aux <- subset(google, sub_region_1 == "Bogota")
#c_bog$mobility <- aux$retail_and_recreation_percent_change_from_baseline[match(c_bog$fecha,aux$date)]
#c_bog$mobility <- aux$grocery_and_pharmacy_percent_change_from_baseline[match(c_bog$fecha,aux$date)]
#c_bog$mobility <- aux$parks_percent_change_from_baseline[match(c_bog$fecha,aux$date)]
#c_bog$mobility <- aux$transit_stations_percent_change_from_baseline[match(c_bog$fecha,aux$date)]
c_bog$mobility <- aux$workplaces_percent_change_from_baseline[match(c_bog$fecha,aux$date)]
rm(aux)

c_bog$prom_mob <- NA
lista_dias <- c_bog$dia[7:length(c_bog$dia)]
i <- lista_dias[1]
for (i in lista_dias) {
  j <- i-6
  aux <- subset(c_bog, dia >= j & dia <= i)
  c_bog$prom_mob[match(i,c_bog$dia)] <- sum(aux$mobility)/7
  }
rm(i,lista_dias)

# construir grafica
ggplot(c_bog,aes(x=fecha)) +
  
  # usuario
  geom_text(x=as.Date("2020-06-01"),y=4000,label="@rundav5",col="#AEB6BF",size=3) +

  # datos
  geom_line(aes(y=prom_diario,col=prom_mob),size=1) +
  scale_x_date(date_breaks="1 month",date_labels="%m-%y'",
               #date_minor_breaks="1/2 month",
               limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,30000,1000),minor_breaks=seq(0,30000,500),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,20000,1000),labels=comma)) +
  scale_color_gradient(low="red",high="green") +
  theme_minimal() +
  theme(legend.position="top",legend.box="horizontal",legend.background=element_rect(fill="transparent",color=NA),plot.caption=element_text(face="italic",hjust=0)) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,title="Casos diarios y reducción de movilidad* en Bogotá",fill=NULL,
       #color="*Reducción de movilidad en tiendas y ocio",
       #color="*Reducción de movilidad en supermercados y farmacias",
       #color="*Reducción de movilidad en parques",
       #color="*Reducción de movilidad en estaciones de transporte",
       color="*Reducción de movilidad en lugares de trabajo",
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"e informes de movilidad de de Google\n**El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
 
  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=max(casos_dia,na.rm=TRUE)*0.5,label="Reporte caso nº 1"),angle=90,size=2.5) +
 
  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+0.4,y=0,xend=fecha_datos,yend=0), col = "black",size = 0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5) +
  
  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0",alpha=0.01) +
  geom_vline(xintercept=fecha_datos-confianza_casos-0.5,size=0.4,colour="white") + 
  geom_text(aes(x=fecha_datos-confianza_casos/5,y=max(casos_dia)*0.5,label="Datos\npreliminares"),angle=90,size=2.5,col="white") +
  geom_text(aes(x=fecha_datos-confianza_casos+4,y=500,label=paste("-",confianza_casos,"días**")),angle=90,size=2.5,col="white") 
  

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_140.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos vs restricciones en medellin, eval=FALSE, include=FALSE}
# construir tabla de casos diarios por fecha de diagnóstico
c_med <- aggregate(caso ~ fecha_sintom_diagno, subset(data_col, ciudad == "MEDELLIN"),length)
colnames(c_med)[2] <- "casos_dia"

# pegar dia
c_med$dia <- NA
c_med$dia <- aux_fechas$num_dia[match(c_med$fecha,aux_fechas$fecha)]

# promedio diario
c_med$prom_diario <- NA
lista_dias <- c_med$dia[7:length(c_med$dia)]
i <- lista_dias[1]
for (i in lista_dias) {
  j <- i-6
  aux <- subset(c_med, dia >= j & dia <= i)
  c_med$prom_diario[match(i,c_med$dia)] <- sum(aux$casos_dia)/7
  }
rm(i,lista_dias)

# índicde de movilidad de google
c_med$mobility <- NA
aux <- subset(google, sub_region_2 == "Medellin")
c_med$mobility <- aux$retail_and_recreation_percent_change_from_baseline[match(c_med$fecha,aux$date)]
#c_med$mobility <- aux$grocery_and_pharmacy_percent_change_from_baseline[match(c_med$fecha,aux$date)]
#c_med$mobility <- aux$parks_percent_change_from_baseline[match(c_med$fecha,aux$date)]
#c_med$mobility <- aux$transit_stations_percent_change_from_baseline[match(c_med$fecha,aux$date)]
#c_med$mobility <- aux$workplaces_percent_change_from_baseline[match(c_med$fecha,aux$date)]
rm(aux)

c_med$prom_mob <- NA
lista_dias <- c_med$dia[7:length(c_med$dia)]
i <- lista_dias[1]
for (i in lista_dias) {
  j <- i-6
  aux <- subset(c_med, dia >= j & dia <= i)
  c_med$prom_mob[match(i,c_med$dia)] <- sum(aux$mobility)/7
  }
rm(i,lista_dias)

# construir grafica
ggplot(c_med,aes(x=fecha_sintom_diagno)) +
  
  # usuario
  geom_text(x=as.Date("2020-06-01"),y=1000,label="@rundav5",col="#AEB6BF",size=3) +

  # datos
  geom_line(aes(y=prom_diario,col=prom_mob),size=1) +
  scale_x_date(date_breaks="1 month",date_labels="%m-%y'",
               #date_minor_breaks="1/2 month",
               limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,30000,200),minor_breaks=seq(0,30000,100),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,20000,200),labels=comma)) +
  scale_color_gradient(low="red",high="green") +
  theme_minimal() +
  theme(legend.position="top",legend.box="horizontal",legend.background=element_rect(fill="transparent",color=NA),plot.caption=element_text(face="italic",hjust=0)) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,title="Casos diarios y reducción de movilidad* en Medellín",fill=NULL,
       color="*Reducción de movilidad en tiendas y ocio",
       #color="*Reducción de movilidad en supermercados y farmacias",
       #color="*Reducción de movilidad en parques",
       #color="*Reducción de movilidad en estaciones de transporte",
       #color="*Reducción de movilidad en lugares de trabajo",
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"e informes de movilidad de de Google\n**El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
 
  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=max(casos_dia,na.rm=TRUE)*0.5,label="Reporte caso nº 1"),angle=90,size=2.5) +
 
  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+0.4,y=0,xend=fecha_datos,yend=0), col = "black",size = 0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5) +
  
  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0",alpha=0.01) +
  geom_vline(xintercept=fecha_datos-confianza_casos-0.5,size=0.4,colour="white") + 
  geom_text(aes(x=fecha_datos-confianza_casos/5,y=max(casos_dia)*0.5,label="Datos\npreliminares"),angle=90,size=2.5,col="white") +
  geom_text(aes(x=fecha_datos-confianza_casos+4,y=200,label=paste("-",confianza_casos,"días**")),angle=90,size=2.5,col="white") 
  

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_141.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos vs restricciones en barranquilla, eval=FALSE, include=FALSE}
# construir tabla de casos diarios por fecha de diagnóstico
c_bar <- aggregate(caso ~ fecha_sintom_diagno, subset(data_col, ciudad == "BARRANQUILLA"),length)
colnames(c_bar)[2] <- "casos_dia"

# pegar dia
c_bar$dia <- NA
c_bar$dia <- aux_fechas$num_dia[match(c_bar$fecha,aux_fechas$fecha)]

# promedio diario
c_bar$prom_diario <- NA
lista_dias <- c_bar$dia[7:length(c_bar$dia)]
i <- lista_dias[1]
for (i in lista_dias) {
  j <- i-6
  aux <- subset(c_bar, dia >= j & dia <= i)
  c_bar$prom_diario[match(i,c_bar$dia)] <- sum(aux$casos_dia)/7
  }
rm(i,lista_dias)

# índicde de movilidad de google
c_bar$mobility <- NA
aux <- subset(google, sub_region_2 == "Barranquilla")
c_bar$mobility <- aux$retail_and_recreation_percent_change_from_baseline[match(c_bar$fecha,aux$date)]
#c_bar$mobility <- aux$grocery_and_pharmacy_percent_change_from_baseline[match(c_bar$fecha,aux$date)]
#c_bar$mobility <- aux$parks_percent_change_from_baseline[match(c_bar$fecha,aux$date)]
#c_bar$mobility <- aux$transit_stations_percent_change_from_baseline[match(c_bar$fecha,aux$date)]
#c_bar$mobility <- aux$workplaces_percent_change_from_baseline[match(c_bar$fecha,aux$date)]
rm(aux)

c_bar$prom_mob <- NA
lista_dias <- c_bar$dia[7:length(c_bar$dia)]
i <- lista_dias[1]
for (i in lista_dias) {
  j <- i-6
  aux <- subset(c_bar, dia >= j & dia <= i)
  c_bar$prom_mob[match(i,c_bar$dia)] <- sum(aux$mobility)/7
  }
rm(i,lista_dias)

# construir grafica
ggplot(c_bar,aes(x=fecha_sintom_diagno)) +
  
  # usuario
  geom_text(x=as.Date("2020-06-01"),y=1000,label="@rundav5",col="#AEB6BF",size=3) +

  # datos
  geom_line(aes(y=prom_diario,col=prom_mob),size=1) +
  scale_x_date(date_breaks="1 month",date_labels="%m-%y'",
               #date_minor_breaks="1/2 month",
               limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,30000,200),minor_breaks=seq(0,30000,100),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,20000,200),labels=comma)) +
  scale_color_gradient(low="red",high="green") +
  theme_minimal() +
  theme(legend.position="top",legend.box="horizontal",legend.background=element_rect(fill="transparent",color=NA),plot.caption=element_text(face="italic",hjust=0)) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,title="Casos diarios y reducción de movilidad* en Barranquilla",fill=NULL,
       color="*Reducción de movilidad en tiendas y ocio",
       #color="*Reducción de movilidad en supermercados y farmacias",
       #color="*Reducción de movilidad en parques",
       #color="*Reducción de movilidad en estaciones de transporte",
       #color="*Reducción de movilidad en lugares de trabajo",
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"e informes de movilidad de de Google\n**El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
 
  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=max(casos_dia,na.rm=TRUE)*0.5,label="Reporte caso nº 1"),angle=90,size=2.5) +
 
  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+0.4,y=0,xend=fecha_datos,yend=0), col = "black",size = 0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5) +
  
  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0",alpha=0.01) +
  geom_vline(xintercept=fecha_datos-confianza_casos-0.5,size=0.4,colour="white") + 
  geom_text(aes(x=fecha_datos-confianza_casos/5,y=max(casos_dia)*0.5,label="Datos\npreliminares"),angle=90,size=2.5,col="white") +
  geom_text(aes(x=fecha_datos-confianza_casos+4,y=200,label=paste("-",confianza_casos,"días**")),angle=90,size=2.5,col="white") 
  

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_142.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r casos vs restricciones en santa marta, eval=FALSE, include=FALSE}
# construir tabla de casos diarios por fecha de diagnóstico
c_smar <- aggregate(caso ~ fecha_sintom_diagno, subset(data_col, ciudad == "SANTA MARTA"),length)
colnames(c_smar)[2] <- "casos_dia"

# pegar dia
c_smar$dia <- NA
c_smar$dia <- aux_fechas$num_dia[match(c_smar$fecha,aux_fechas$fecha)]

# promedio diario
c_smar$prom_diario <- NA
lista_dias <- c_smar$dia[7:length(c_smar$dia)]
i <- lista_dias[1]
for (i in lista_dias) {
  j <- i-6
  aux <- subset(c_smar, dia >= j & dia <= i)
  c_smar$prom_diario[match(i,c_smar$dia)] <- sum(aux$casos_dia)/7
  }
rm(i,lista_dias)

# índicde de movilidad de google
c_smar$mobility <- NA
aux <- subset(google, sub_region_2 == "Barranquilla")
c_smar$mobility <- aux$retail_and_recreation_percent_change_from_baseline[match(c_smar$fecha,aux$date)]
#c_smar$mobility <- aux$grocery_and_pharmacy_percent_change_from_baseline[match(c_smar$fecha,aux$date)]
#c_smar$mobility <- aux$parks_percent_change_from_baseline[match(c_smar$fecha,aux$date)]
#c_smar$mobility <- aux$transit_stations_percent_change_from_baseline[match(c_smar$fecha,aux$date)]
#c_smar$mobility <- aux$workplaces_percent_change_from_baseline[match(c_smar$fecha,aux$date)]
rm(aux)

c_smar$prom_mob <- NA
lista_dias <- c_smar$dia[7:length(c_smar$dia)]
i <- lista_dias[1]
for (i in lista_dias) {
  j <- i-6
  aux <- subset(c_smar, dia >= j & dia <= i)
  c_smar$prom_mob[match(i,c_smar$dia)] <- sum(aux$mobility)/7
  }
rm(i,lista_dias)

# construir grafica
ggplot(c_smar,aes(x=fecha_sintom_diagno)) +
  
  # usuario
  geom_text(x=as.Date("2020-06-01"),y=200,label="@rundav5",col="#AEB6BF",size=3) +

  # datos
  geom_line(aes(y=prom_diario,col=prom_mob),size=1) +
  scale_x_date(date_breaks="1 month",date_labels="%m-%y'",
               #date_minor_breaks="1/2 month",
               limits=c(min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),fecha_datos+1)) +
  scale_y_continuous(breaks=seq(0,30000,100),minor_breaks=seq(0,30000,50),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,20000,100),labels=comma)) +
  scale_color_gradient(low="red",high="green") +
  theme_minimal() +
  theme(legend.position="top",legend.box="horizontal",legend.background=element_rect(fill="transparent",color=NA),plot.caption=element_text(face="italic",hjust=0)) +
  labs(x="Fecha inicio síntomas | diagnóstico para asintomáticos",y=NULL,title="Casos diarios y reducción de movilidad* en Santa Marta",fill=NULL,
       color="*Reducción de movilidad en tiendas y ocio",
       #color="*Reducción de movilidad en supermercados y farmacias",
       #color="*Reducción de movilidad en parques",
       #color="*Reducción de movilidad en estaciones de transporte",
       #color="*Reducción de movilidad en lugares de trabajo",
       caption=paste("Fuente: datos reportados por el Instituto Nacional de Salud (INS) el",fecha_datos,"e informes de movilidad de de Google\n**El periodo de datos preliminares varía en función del tiempo de reporte de casos")) +
 
  #1º confirmado
  geom_vline(aes(xintercept=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)),size=0.4,linetype="dotdash") +
  geom_point(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),y=0),col="black",show.legend=FALSE) +
  geom_text(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+6,y=max(prom_diario,na.rm=TRUE)*0.5,label="Reporte caso nº 1"),angle=90,size=2.5) +
 
  # dias desde 1º
  geom_segment(aes(x=min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE)+0.4,y=0,xend=fecha_datos,yend=0), col = "black",size = 0.4) +
  geom_point(aes(x=fecha_datos,y=0),col="black",shape=15,show.legend=FALSE,size=1.2) +
  geom_text(aes(x=fecha_datos+0.2,y=0,label=paste(fecha_datos-min(as.Date(data_col$fecha_reporte_web),na.rm=TRUE),"\ndías")),colour="black",size=2.5) +
  
  # punto de confianza
  geom_rect(xmin=fecha_datos-confianza_casos-0.5,ymin=-Inf,xmax=Inf,ymax=Inf,fill="#b0b0b0",alpha=0.01) +
  geom_vline(xintercept=fecha_datos-confianza_casos-0.5,size=0.4,colour="white") + 
  geom_text(aes(x=fecha_datos-confianza_casos/5,y=max(prom_diario,na.rm=TRUE)*0.5,label="Datos\npreliminares"),angle=90,size=2.5,col="white") +
  geom_text(aes(x=fecha_datos-confianza_casos+4,y=50,label=paste("-",confianza_casos,"días**")),angle=90,size=2.5,col="white") 
  

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_143.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

***
# Exceso de mortalidad

El exceso de mortalidad se calcula a partir de información del Departamento Nacional de Estadística (DANE) y es una fuente más fiable del impacto del virus en la mortalidad en el país, dado que registra todas las muertes por todas las causas. La comparación del 2020 y 2021 contra las cifras de años anteriores permite dimensionar la magnitud del impacto de la pandemia en la mortalidad sin depender del número de pruebas realizadas. Además, permite entender mejor las consecuencias del virus y de las restricciones tomadas por el gobierno sobre otras causas de mortalidad (naturales y violentas).

```{r importar datos muertes semanales DANE}
data_muertes_DANE <- read_excel("inputs/defunciones DANE/anexos-defunciones-covid-dept-sexo-2020-02mar-2021-09may.xlsx",sheet="Tabla seguimiento mortalidad",range="A13:O11863",col_names=FALSE,col_types = c("text", "text", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric"))
colnames(data_muertes_DANE) <- c("ano","departamento","semana","total_natural","hombres_natural","mujeres_natural","indet_natural","total_violento","hombres_violento","mujeres_violento","indet_violento","total_en_estudio","hombres_en_estudio","mujeres_en_estudio","indet_en_estudio")

# año
lista <- seq(1,length(data_muertes_DANE$ano),1)
for (i in lista) {
  data_muertes_DANE$ano[i] <- ifelse(is.na(data_muertes_DANE$ano[i]),data_muertes_DANE$ano[i-1],data_muertes_DANE$ano[i])
}
rm(i,lista)

# departamento
lista <- seq(1,length(data_muertes_DANE$ano),1)
for (i in lista) {
  data_muertes_DANE$departamento[i] <- ifelse(is.na(data_muertes_DANE$departamento[i]),data_muertes_DANE$departamento[i-1],data_muertes_DANE$departamento[i])
}
rm(i,lista)

# semana
data_muertes_DANE$semana_new <- ifelse(data_muertes_DANE$semana == "Total","Total",gsub('*[A-z ]', '' , data_muertes_DANE$semana))
data_muertes_DANE$semana <- data_muertes_DANE$semana_new
data_muertes_DANE$semana_new <-NULL

# convertir datos
aux1 <- subset(data_muertes_DANE, select = c("ano","departamento","semana","hombres_natural"))
aux1$sexo <- "Hombres"
aux1$tipo <- "Naturales"
colnames(aux1)[4] <- "muertes"

aux2 <- subset(data_muertes_DANE, select = c("ano","departamento","semana","mujeres_natural"))
aux2$sexo <- "Mujeres"
aux2$tipo <- "Naturales"
colnames(aux2)[4] <- "muertes"

aux3 <- subset(data_muertes_DANE, select = c("ano","departamento","semana","indet_natural"))
aux3$sexo <- "Indeterminado"
aux3$tipo <- "Naturales"
colnames(aux3)[4] <- "muertes"

aux4 <- subset(data_muertes_DANE, select = c("ano","departamento","semana","hombres_violento"))
aux4$sexo <- "Hombres"
aux4$tipo <- "Violentas"
colnames(aux4)[4] <- "muertes"

aux5 <- subset(data_muertes_DANE, select = c("ano","departamento","semana","mujeres_violento"))
aux5$sexo <- "Mujeres"
aux5$tipo <- "Violentas"
colnames(aux5)[4] <- "muertes"

aux6 <- subset(data_muertes_DANE, select = c("ano","departamento","semana","mujeres_violento"))
aux6$sexo <- "Indeterminado"
aux6$tipo <- "Violentas"
colnames(aux6)[4] <- "muertes"

aux7 <- subset(data_muertes_DANE, select = c("ano","departamento","semana","hombres_en_estudio"))
aux7$sexo <- "Hombres"
aux7$tipo <- "En estudio"
colnames(aux7)[4] <- "muertes"

aux8 <- subset(data_muertes_DANE, select = c("ano","departamento","semana","mujeres_en_estudio"))
aux8$sexo <- "Mujeres"
aux8$tipo <- "En estudio"
colnames(aux8)[4] <- "muertes"

aux9 <- subset(data_muertes_DANE, select = c("ano","departamento","semana","indet_en_estudio"))
aux9$sexo <- "Indeterminado"
aux9$tipo <- "En estudio"
colnames(aux9)[4] <- "muertes"

c_muertes_DANE <- rbind(aux1,aux2,aux3,aux4,aux5,aux6,aux7,aux8,aux9)
rm(aux1,aux2,aux3,aux4,aux5,aux6,aux7,aux8,aux9)

c_muertes_DANE <- subset(c_muertes_DANE, !is.na(semana) & semana != "Total")
c_muertes_DANE$semana <- as.numeric(c_muertes_DANE$semana)

rm(data_muertes_DANE)

c_muertes_DANE$ano_new <- NA
c_muertes_DANE$ano_new <- substr(c_muertes_DANE$ano,1,4)
c_muertes_DANE$ano_sem <- NA
c_muertes_DANE$ano_sem <- ifelse(c_muertes_DANE$semana < 10, as.numeric(paste(c_muertes_DANE$ano_new,0,c_muertes_DANE$semana,sep="")), as.numeric(paste(c_muertes_DANE$ano_new,c_muertes_DANE$semana,sep="")))
c_muertes_DANE$yr_wk <- NA
c_muertes_DANE$yr_wk <- yearweek(paste(c_muertes_DANE$ano_new, 'week', c_muertes_DANE$semana))

# borrar datos 2021
#c_muertes_DANE <- subset(c_muertes_DANE, ano != "2021pr")
```

## Colombia

```{r muertos totales por año, fig.height=4.5, fig.width=8}
c_muertes_tot <- aggregate(muertes ~ ano + semana, c_muertes_DANE, sum)

ggplot(c_muertes_tot,aes(x=semana,y=muertes,col=ano)) +
  geom_line(size=1) +
  #geom_area(stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  #geom_text(aes(label=ifelse(semana==26,percent(exceso, accuracy = 2),NA)),show.legend=FALSE,nudge_x=2,size=3) +
  scale_x_continuous(limits=c(1,53),breaks=seq(2,52,2)) +
  scale_y_continuous(limits=c(0,NA),breaks=seq(0,20000,by=1000),minor_breaks=seq(0,20000,200),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,20000,1000),labels=comma)) +
  #scale_color_manual(values = c("#CC79A7","#999999")) +
  #scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(legend.position="top",
        plot.caption=element_text(face="italic",hjust=0),
        ) +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Muertes totales por año en Colombia",
       caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE)\nLos datos de 2020 son preliminares") +
  
  # usuario
  geom_text(x=6,y=500,label="@rundav5",col="#AEB6BF",size=3.5) 

```

```{r variacion de muertos totales por año, eval=FALSE, fig.height=4.5, fig.width=8, include=FALSE}
c_muertes_tot$crecimiento <- NA
lista <- unique(c_muertes_tot$semana)
#i <- lista[2]
for (i in lista) {
  aux <- subset(c_muertes_tot, semana == i)
  lista_anos <- unique(aux$ano)[2:6]
  #j <- lista_anos[1]
  for (j in lista_anos) {
    c_muertes_tot$crecimiento[match(paste(i,j),paste(c_muertes_tot$semana,c_muertes_tot$ano))] <- aux$muertes[match(j,aux$ano)]/aux$muertes[match(j,aux$ano)-1] - 1
  }
  rm(lista_anos,j)
}
rm(i,lista,aux)

ggplot(c_muertes_tot,aes(x=semana,y=crecimiento,col=ano)) +
  geom_line(size=1) +
  scale_x_continuous(limits=c(1,53),breaks=seq(2,52,2)) +
  #scale_y_continuous(limits=c(-0.3,0.3),breaks=seq(-1,1,by=0.1),minor_breaks=seq(0,1,0.05),labels=percent_format(accuracy = 1),sec.axis=sec_axis(~.,breaks=seq(-1,1,0.1),labels=percent_format(accuracy = 1))) +
  #scale_color_manual(values = c("#CC79A7","#999999")) +
  #scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(legend.position="top",
        plot.caption=element_text(face="italic",hjust=0),
        ) +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Muertes totales por año en Colombia",
       caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE)\nLos datos de 2019 y 2020 son preliminares") +
  
  # usuario
  geom_text(x=6,y=-0.2,label="@rundav5",col="#AEB6BF",size=3.5) 

```

```{r exceso de mortalidad en Colombia}
# muertes semanales en 2020 y 2021
c_exc <- subset(c_muertes_DANE, ano_new >= 2020)
c_exc$ano <- c_exc$ano_new
c_exc$ano_new <- NULL

# promedio semanal de años anteriores
c_exc_col <- aggregate(muertes ~ semana + ano + ano_sem + yr_wk, c_exc, sum)

aux <- aggregate(muertes ~ semana + ano + ano_sem + yr_wk, subset(c_muertes_DANE, ano_new < 2020), sum)
aux_2 <- aggregate(muertes ~ semana, aux, mean)

c_exc_col$prom_15_19 <- NA
c_exc_col$prom_15_19 <- aux_2$muertes[match(c_exc_col$semana,aux_2$semana)]
rm(aux, aux_2)

# construir grafica
ggplot(c_exc_col,aes(x=yr_wk)) +
  geom_area(aes(y=muertes,color="2020 y 2021",fill="2020 y 2021"),stat="identity",position="dodge",alpha=0.5,size=1) +
  geom_area(aes(y=prom_15_19,color="Promedio 2015-2019",fill="Promedio 2015-2019"),stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  scale_x_yearweek(
    date_labels="%m-%y'",
    date_breaks="3 months",
    date_minor_breaks="1 month"
    ) +
  scale_y_continuous(limits=c(0,NA),breaks=seq(0,20000,by=1000),minor_breaks=seq(0,20000,500),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,20000,1000),labels=comma)) +
  scale_color_manual(values = c("#CC79A7","#999999")) +
  scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(legend.position="top",
        plot.caption=element_text(face="italic",hjust=0),
        ) +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Fecha",
       col=NULL,
       fill=NULL,
       title="Exceso de mortalidad en Colombia",
       subtitle="Comparación de muertes (por todas las causas) en 2020 y 2021 respecto al promedio de años anteriores",caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE) el 2021-05-24\nLos datos de 2020 y 2021 son preliminares") +
  
  # #1º confirmado
  # geom_vline(aes(xintercept=as.Date("2020-03-06")),size=0.4,linetype="dashed") +
  # geom_point(aes(x=as.Date("2020-03-06"),y=0),col="black",show.legend=FALSE) +
  # geom_text(aes(x=as.Date("2020-03-06"),y=5000,label="Primer caso de COVID-19\nen Colombia"),angle=90,size=2.5,col="black") +

  # usuario
  geom_text(y=2000,x=as.Date("2021-03-01"),label="@rundav5",col="white",size=3) 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_exc_000.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)


```

```{r muertos por tipo en Colombia, fig.height=4.5, fig.width=8}
c_exc_20_sexo <- aggregate(muertes ~ semana + ano + tipo, c_exc_20, sum)
c_exc_20_sexo <- subset(c_exc_20_sexo, tipo != "En estudio")

# calcular exceso de mortalidad acumulado
aux <- aggregate(muertes ~ ano + tipo, subset(c_exc_20_sexo, semana <= 53), sum)
aux_exceso <- data.frame(tipo=unique(aux$tipo))
aux_exceso$tipo <- as.character(aux_exceso$tipo)
aux_exceso$exceso <- NA
lista <- as.character(aux_exceso$tipo)
for (i in lista) {
  aux_exceso$exceso[match(i,aux_exceso$tipo)] <- aux$muertes[match(paste(2020,i),paste(aux$ano,aux$tipo))] / aux$muertes[match(paste("Promedio 2015-2019",i),paste(aux$ano,aux$tipo))] - 1
  
}
rm(i,aux,lista)

c_exc_20_sexo$exceso <- NA
c_exc_20_sexo$exceso <- ifelse(c_exc_20_sexo$semana==50 & c_exc_20_sexo$ano==2020,aux_exceso$exceso[match(c_exc_20_sexo$tipo,aux_exceso$tipo)],NA)
rm(aux_exceso)

# construir grafica
ggplot(c_exc_20_sexo,aes(x=semana,y=muertes,col=ano,fill=ano)) +
  geom_area(stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  geom_text(aes(label=percent(exceso,accuracy=2)),show.legend=FALSE,nudge_y=1000,size=3.5,col="#CC79A7") +
  scale_x_continuous(limits=c(1,53),breaks=seq(4,52,4)) +
  scale_y_continuous(limits=c(0,NA),breaks=seq(0,20000,by=1000),minor_breaks=seq(0,20000,200),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,20000,1000),labels=comma)) +
  scale_color_manual(values = c("#CC79A7","#999999")) +
  scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(legend.position="top",plot.caption=element_text(face="italic",hjust=0),
        ) +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Exceso de muertes naturales y violentas en Colombia",
       subtitle="Comparación de 2020 respecto al promedio de años anteriores",caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE) el 2021-02-04\nLos datos de 2020 son preliminares") +
  facet_wrap(~ tipo, ncol = 2)  +
  
  # anotaciones
  #geom_text(anno_text,aes(x=x1,y=y1,label=exceso),angle=0,size=3,col="#AEB6BF") +
  geom_text(aes(x=12,y=500,label=ifelse(tipo == "Naturales","@rundav5","")),size=3,col="white") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_exc_002.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertos por sexo en Colombia, fig.height=4.5, fig.width=8}
c_exc_20_sexo <- aggregate(muertes ~ semana + ano + sexo, c_exc_20, sum)
c_exc_20_sexo <- subset(c_exc_20_sexo, sexo != "Indeterminado")

# calcular exceso de mortalidad acumulado
aux <- aggregate(muertes ~ ano + sexo, subset(c_exc_20_sexo, semana <= 53), sum)
aux_exceso <- data.frame(sexo=unique(aux$sexo))
aux_exceso$sexo <- as.character(aux_exceso$sexo)
aux_exceso$exceso <- NA
lista <- as.character(aux_exceso$sexo)
for (i in lista) {
  aux_exceso$exceso[match(i,aux_exceso$sexo)] <- aux$muertes[match(paste(2020,i),paste(aux$ano,aux$sexo))] / aux$muertes[match(paste("Promedio 2015-2019",i),paste(aux$ano,aux$sexo))] - 1
  
}
rm(i,aux,lista)

c_exc_20_sexo$exceso <- NA
c_exc_20_sexo$exceso <- ifelse(c_exc_20_sexo$semana==50 & c_exc_20_sexo$ano==2020,aux_exceso$exceso[match(c_exc_20_sexo$sexo,aux_exceso$sexo)],NA)
rm(aux_exceso)

# construir grafica
ggplot(c_exc_20_sexo,aes(x=semana,y=muertes,col=ano,fill=ano)) +
  geom_area(stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  geom_text(aes(label=percent(exceso,accuracy=2)),show.legend=FALSE,nudge_y=1000,size=3.5,col="#CC79A7") +
  scale_x_continuous(limits=c(1,53),breaks=seq(2,52,2)) +
  scale_y_continuous(limits=c(0,NA),labels=comma,breaks=seq(0,20000,1000),sec.axis=sec_axis(~.,breaks=seq(0,20000,1000),labels=comma)) +
  scale_color_manual(values = c("#CC79A7","#999999")) +
  scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(legend.position="top",
        plot.caption=element_text(face="italic",hjust=0),
        ) +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Exceso de muertes por sexo en Colombia",
       subtitle="Comparación de 2020 respecto al promedio de años anteriores",caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE) el 2021-02-04\nLos datos de 2020 son preliminares") +
  facet_wrap(~ sexo, ncol = 1)  +
  
  # anotaciones
  geom_text(aes(x=8,y=1000,label=ifelse(sexo == "Mujeres","@rundav5","")),size=3,col="white") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_exc_003.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertos por tipo y por sexo en Colombia, fig.height=4.5, fig.width=8}
c_exc_20_tipo_sexo <- aggregate(muertes ~ semana + ano + tipo + sexo, c_exc_20, sum)
c_exc_20_tipo_sexo <- subset(c_exc_20_tipo_sexo, tipo != "En estudio")
c_exc_20_tipo_sexo <- subset(c_exc_20_tipo_sexo, sexo != "Indeterminado")

ggplot(c_exc_20_tipo_sexo,aes(x=semana,y=muertes,col=ano,fill=ano)) +
  geom_area(stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  #geom_text(aes(label=ifelse(semana==26,percent(exceso, accuracy = 2),NA)),show.legend=FALSE,nudge_x=3,nudge_y=ifelse(c_exc_20_sexo$tipo=="Violentas",500,0),size=3) +
  scale_x_continuous(limits=c(1,53),breaks=seq(4,52,4)) +
  scale_y_continuous(limits=c(0,NA),breaks=seq(0,20000,by=1000),minor_breaks=seq(0,20000,200),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,20000,1000),labels=comma)) +
  scale_color_manual(values = c("#CC79A7","#999999")) +
  scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(legend.position="top",
        plot.caption=element_text(face="italic",hjust=0),
        ) +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Exceso de muertes naturales y violentas por sexo en Colombia",
       subtitle="Comparación de 2020 respecto al promedio de años anteriores",caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE) el 2021-02-04\nLos datos de 2020 son preliminares") +
  facet_grid(sexo ~ tipo, scales = "free_y") +
  
  # anotaciones
  geom_text(aes(x=8,y=500,label=ifelse(sexo == "Mujeres" & tipo == "Naturales","@rundav5","")),size=3,col="white") 

  

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_exc_004.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

## Departamentos

```{r muertes por departamento}
c_exc_20_dep <- aggregate(muertes ~ semana + ano + departamento, c_exc_20, sum)
c_exc_20_dep <- subset(c_exc_20_dep, departamento != "Sin información" & departamento != "Extranjero")

# aumento porcentual por semana
c_exc_20_dep$exceso <- NA
lista_dep <- unique(c_exc_20_dep$departamento)
for (j in lista_dep) {
  aux1 <- subset(c_exc_20_dep, departamento == j)
  lista <- unique(aux1$semana)
  for (i in lista) {
    aux2 <- subset(aux1, semana == i)
    c_exc_20_dep$exceso[match(paste(j,i,2020),paste(c_exc_20_dep$departamento,c_exc_20_dep$semana,c_exc_20_dep$ano))] <- aux2$muertes[match(2020,aux2$ano)]/aux2$muertes[match("Promedio 2015-2019",aux2$ano)] - 1
  }
  rm(i,lista,aux2)
}
rm(j,lista_dep,aux1)

```

```{r muertes naturales y volentas por departamento}
c_exc_20_dep_nv <- aggregate(muertes ~ semana + ano + tipo + departamento, c_exc_20, sum)
c_exc_20_dep_nv <- subset(c_exc_20_dep_nv, departamento != "Sin información" & departamento != "Extranjero" & tipo != "En estudio")

# aumento porcentual por semana
c_exc_20_dep_nv$exceso <- NA
lista_dep <- unique(c_exc_20_dep_nv$departamento)
for (j in lista_dep) {
  aux1 <- subset(c_exc_20_dep_nv, departamento == j)
  lista_tipo <- unique(aux1$tipo)
  for (k in lista_tipo) {
    aux2 <- subset(aux1, tipo == k)
    lista <- unique(aux1$semana)
    for (i in lista) {
      aux3 <- subset(aux2, semana == i)
      c_exc_20_dep_nv$exceso[match(paste(j,k,i,2020),paste(c_exc_20_dep_nv$departamento,c_exc_20_dep_nv$tipo,c_exc_20_dep_nv$semana,c_exc_20_dep_nv$ano))] <- aux3$muertes[match(2020,aux3$ano)]/aux3$muertes[match("Promedio 2015-2019",aux3$ano)] - 1
    }
    rm(i,lista,aux3)
  }
  rm(k,aux2,lista_tipo)
}
rm(j,lista_dep,aux1)

```

```{r muertes en departamentos grupo 1}
lista <- c("Bogotá","Valle del Cauca","Antioquia","Atlántico","Cundinamarca","Santander")
c_exc_20_dep_g1 <- subset(c_exc_20_dep, departamento %in% lista)
rm(lista)

# calcular exceso de mortalidad acumulado
aux <- aggregate(muertes ~ ano + departamento, subset(c_exc_20_dep_g1, semana <= 44), sum)
aux_exceso <- data.frame(departamento=unique(aux$departamento))
aux_exceso$departamento <- as.character(aux_exceso$departamento)
aux_exceso$exceso <- NA
lista <- as.character(aux_exceso$departamento)
for (i in lista) {
  aux_exceso$exceso[match(i,aux_exceso$departamento)] <- aux$muertes[match(paste(2020,i),paste(aux$ano,aux$departamento))] / aux$muertes[match(paste("Promedio 2015-2019",i),paste(aux$ano,aux$departamento))] - 1
  
}
rm(i,aux,lista)

c_exc_20_dep_g1$exceso <- NA
c_exc_20_dep_g1$exceso <- ifelse(c_exc_20_dep_g1$semana==50 & c_exc_20_dep_g1$ano==2020,aux_exceso$exceso[match(c_exc_20_dep_g1$departamento,aux_exceso$departamento)],NA)
rm(aux_exceso)

# construir grafica
ggplot(c_exc_20_dep_g1,aes(x=semana,y=muertes,col=ano,fill=ano)) +
  geom_area(stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  geom_text(aes(label=percent(exceso,accuracy=2)),show.legend=FALSE,nudge_y=500,size=3,col="#CC79A7") +
  scale_x_continuous(limits=c(1,53),breaks=seq(4,52,4)) +
  scale_y_continuous(limits=c(0,NA),labels=comma,sec.axis=sec_axis(~.,labels=comma)) +
  scale_color_manual(values = c("#CC79A7","#999999")) +
  scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 9),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Exceso de muertes en Bogotá, Antioquia, Atlántico, Valle del Cauca, Cundinamarca y Santander",
       subtitle="Comparación del total de muertes (por todas las causas) en 2020 respecto al promedio de años anteriores",caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE) el 2021-02-04\nLos datos de 2020 son preliminares") +
  facet_wrap(~ departamento, ncol = 3) +
  
  # anotaciones
  geom_text(aes(x=12,y=250,label=ifelse(departamento == "Valle del Cauca","@rundav5","")),size=3,col="white") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_exc_011.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertes en departamentos grupo 2}
lista <- c("Bolívar","Córdoba","Nariño","Norte de Santander","Cauca","Magdalena")
c_exc_20_dep_g1 <- subset(c_exc_20_dep, departamento %in% lista)
rm(lista)

# calcular exceso de mortalidad acumulado
aux <- aggregate(muertes ~ ano + departamento, subset(c_exc_20_dep_g1, semana <= 44), sum)
aux_exceso <- data.frame(departamento=unique(aux$departamento))
aux_exceso$departamento <- as.character(aux_exceso$departamento)
aux_exceso$exceso <- NA
lista <- as.character(aux_exceso$departamento)
for (i in lista) {
  aux_exceso$exceso[match(i,aux_exceso$departamento)] <- aux$muertes[match(paste(2020,i),paste(aux$ano,aux$departamento))] / aux$muertes[match(paste("Promedio 2015-2019",i),paste(aux$ano,aux$departamento))] - 1
  
}
rm(i,aux,lista)

c_exc_20_dep_g1$exceso <- NA
c_exc_20_dep_g1$exceso <- ifelse(c_exc_20_dep_g1$semana==50 & c_exc_20_dep_g1$ano==2020,aux_exceso$exceso[match(c_exc_20_dep_g1$departamento,aux_exceso$departamento)],NA)
rm(aux_exceso)

# construir grafica
ggplot(c_exc_20_dep_g1,aes(x=semana,y=muertes,col=ano,fill=ano)) +
  geom_area(stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  geom_text(aes(label=percent(exceso,accuracy=2)),show.legend=FALSE,nudge_y=100,size=3,col="#CC79A7") +
  scale_x_continuous(limits=c(1,53),breaks=seq(4,52,4)) +
  scale_y_continuous(limits=c(0,NA),labels=comma,sec.axis=sec_axis(~.,labels=comma)) +
  scale_color_manual(values = c("#CC79A7","#999999")) +
  scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 9),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Exceso de muertes en Bolívar, Córdoba, Nariño, Norte de Santander, Cauca y Magdalena",
       subtitle="Comparación del total de muertes (por todas las causas) en 2020 respecto al promedio de años anteriores",caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE) el 2021-02-04\nLos datos de 2020 son preliminares") +
  facet_wrap(~ departamento, ncol = 3) +
  
  # anotaciones
  geom_text(aes(x=12,y=60,label=ifelse(departamento == "Norte de Santander","@rundav5","")),size=3,col="white") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_exc_012.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertes en departamentos grupo 3}
lista <- c("Tolima","Boyacá","Cesar","Huila","Meta","Caldas")
c_exc_20_dep_g1 <- subset(c_exc_20_dep, departamento %in% lista)
rm(lista)

# calcular exceso de mortalidad acumulado
aux <- aggregate(muertes ~ ano + departamento, subset(c_exc_20_dep_g1, semana <= 44), sum)
aux_exceso <- data.frame(departamento=unique(aux$departamento))
aux_exceso$departamento <- as.character(aux_exceso$departamento)
aux_exceso$exceso <- NA
lista <- as.character(aux_exceso$departamento)
for (i in lista) {
  aux_exceso$exceso[match(i,aux_exceso$departamento)] <- aux$muertes[match(paste(2020,i),paste(aux$ano,aux$departamento))] / aux$muertes[match(paste("Promedio 2015-2019",i),paste(aux$ano,aux$departamento))] - 1
  
}
rm(i,aux,lista)

c_exc_20_dep_g1$exceso <- NA
c_exc_20_dep_g1$exceso <- ifelse(c_exc_20_dep_g1$semana==50 & c_exc_20_dep_g1$ano==2020,aux_exceso$exceso[match(c_exc_20_dep_g1$departamento,aux_exceso$departamento)],NA)
rm(aux_exceso)

# construir grafica
ggplot(c_exc_20_dep_g1,aes(x=semana,y=muertes,col=ano,fill=ano)) +
  geom_area(stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  geom_text(aes(label=percent(exceso,accuracy=2)),show.legend=FALSE,nudge_x=,nudge_y=80,size=3,col="#CC79A7") +
  scale_x_continuous(limits=c(1,53),breaks=seq(4,52,4)) +
  scale_y_continuous(limits=c(0,NA),labels=comma,sec.axis=sec_axis(~.,labels=comma)) +
  scale_color_manual(values = c("#CC79A7","#999999")) +
  scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 9),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Exceso de muertes en Tolima, Boyacá, Cesar, Huila, Meta y Caldas",
       subtitle="Comparación del total de muertes (por todas las causas) en 2020 respecto al promedio de años anteriores",caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE) el 2021-02-04\nLos datos de 2020 son preliminares") +
  facet_wrap(~ departamento, ncol = 3) +
  
  # anotaciones
  geom_text(aes(x=12,y=50,label=ifelse(departamento == "Tolima","@rundav5","")),size=3,col="white") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_exc_013.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertes en departamentos grupo 4}
lista <- c("Risaralda","Sucre","La Guajira","Quindío","Chocó","Casanare")
c_exc_20_dep_g1 <- subset(c_exc_20_dep, departamento %in% lista)
rm(lista)

# calcular exceso de mortalidad acumulado
aux <- aggregate(muertes ~ ano + departamento, subset(c_exc_20_dep_g1, semana <= 44), sum)
aux_exceso <- data.frame(departamento=unique(aux$departamento))
aux_exceso$departamento <- as.character(aux_exceso$departamento)
aux_exceso$exceso <- NA
lista <- as.character(aux_exceso$departamento)
for (i in lista) {
  aux_exceso$exceso[match(i,aux_exceso$departamento)] <- aux$muertes[match(paste(2020,i),paste(aux$ano,aux$departamento))] / aux$muertes[match(paste("Promedio 2015-2019",i),paste(aux$ano,aux$departamento))] - 1
  
}
rm(i,aux,lista)

c_exc_20_dep_g1$exceso <- NA
c_exc_20_dep_g1$exceso <- ifelse(c_exc_20_dep_g1$semana==50 & c_exc_20_dep_g1$ano==2020,aux_exceso$exceso[match(c_exc_20_dep_g1$departamento,aux_exceso$departamento)],NA)
rm(aux_exceso)

# construir grafica
ggplot(c_exc_20_dep_g1,aes(x=semana,y=muertes,col=ano,fill=ano)) +
  geom_area(stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  geom_text(aes(label=percent(exceso,accuracy=2)),show.legend=FALSE,nudge_x=0,nudge_y=50,size=3,col="#CC79A7") +
  scale_x_continuous(limits=c(1,53),breaks=seq(4,52,4)) +
  scale_y_continuous(limits=c(0,NA),labels=comma,sec.axis=sec_axis(~.,labels=comma)) +
  scale_color_manual(values = c("#CC79A7","#999999")) +
  scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 9),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Exceso de muertes en Risaralda, Sucre, La Guajira, Quindío, Chocó y Casanare",subtitle="Comparación del total de muertes (por todas las causas) en 2020 respecto al promedio de años anteriores",caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE) el 2021-02-04\nLos datos de 2020 son preliminares") +
  facet_wrap(~ departamento, ncol = 3) +
  
  # anotaciones
  geom_text(aes(x=12,y=25,label=ifelse(departamento == "Sucre","@rundav5","")),size=3,col="white") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_exc_014.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertes en departamentos grupo 5}
lista <- c("Caquetá","Putumayo","Arauca","Guaviare","Vichada","Amazonas","San Andrés y Providencia","Guainía","Vaupés")
c_exc_20_dep_g1 <- subset(c_exc_20_dep, departamento %in% lista)
rm(lista)

# calcular exceso de mortalidad acumulado
aux <- aggregate(muertes ~ ano + departamento, subset(c_exc_20_dep_g1, semana <= 44), sum)
aux_exceso <- data.frame(departamento=unique(aux$departamento))
aux_exceso$departamento <- as.character(aux_exceso$departamento)
aux_exceso$exceso <- NA
lista <- as.character(aux_exceso$departamento)
for (i in lista) {
  aux_exceso$exceso[match(i,aux_exceso$departamento)] <- aux$muertes[match(paste(2020,i),paste(aux$ano,aux$departamento))] / aux$muertes[match(paste("Promedio 2015-2019",i),paste(aux$ano,aux$departamento))] - 1
  
}
rm(i,aux,lista)

c_exc_20_dep_g1$exceso <- NA
c_exc_20_dep_g1$exceso <- ifelse(c_exc_20_dep_g1$semana==50 & c_exc_20_dep_g1$ano==2020,aux_exceso$exceso[match(c_exc_20_dep_g1$departamento,aux_exceso$departamento)],NA)
rm(aux_exceso)

# construir grafica
ggplot(c_exc_20_dep_g1,aes(x=semana,y=muertes,col=ano,fill=ano)) +
  geom_area(stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  geom_text(aes(label=percent(exceso,accuracy=2)),show.legend=FALSE,nudge_x=0,nudge_y=40,size=3,col="#CC79A7") +
  scale_x_continuous(limits=c(1,53),breaks=seq(4,52,4)) +
  scale_y_continuous(limits=c(0,NA),labels=comma,sec.axis=sec_axis(~.,labels=comma)) +
  scale_color_manual(values = c("#CC79A7","#999999")) +
  scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 9),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Exceso de muertes en Caquetá, Putumayo, Arauca, Guaviare, Vichada, Amazonas, San Andrés y Providencia,\nGuainía y Vaupés",
       subtitle="Comparación del total de muertes (por todas las causas) en 2020 respecto al promedio de años anteriores",caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE) el 2021-02-04\nLos datos de 2020 son preliminares") +
  facet_wrap(~ departamento, ncol = 3) +
  
  # anotaciones
  geom_text(aes(x=12,y=18,label=ifelse(departamento=="Caquetá","@rundav5","")),size=3,col="white") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_exc_015.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertes naturales y violentas en grupo 1}
lista <- c("Bogotá","Valle del Cauca","Antioquia","Atlántico","Cundinamarca","Santander")

c_exc_20_dep_nv_selection <- subset(c_exc_20_dep_nv, departamento %in% lista)
rm(lista)

# construir grafica
ggplot(c_exc_20_dep_nv_selection,aes(x=semana,y=muertes,col=ano,fill=ano)) +
  geom_area(stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  scale_x_continuous(limits=c(1,53),breaks=seq(2,52,8)) +
  scale_y_continuous(limits=c(0,NA),labels=comma) +
  scale_color_manual(values = c("#CC79A7","#999999")) +
  scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Exceso de muertes naturales y violentas en Bogotá, Antioquia, Atlántico, Valle del Cauca, Cundinamarca y Santander",
       subtitle="Comparación del total de muertes (por todas las causas) en 2020 respecto al promedio de años anteriores",caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE) el 2021-02-04\nLos datos de 2020 son preliminares") +
  facet_grid(tipo ~ departamento) +
  
  # anotaciones
  geom_text(aes(x=26,y=250,label=ifelse(departamento == "Valle del Cauca" & tipo == "Naturales","@rundav5","")),size=3,col="white") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_exc_021.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertes naturales y violentas en grupo 2}
lista <- c("Bolívar","Córdoba","Nariño","Norte de Santander","Cauca","Magdalena")

c_exc_20_dep_nv_selection <- subset(c_exc_20_dep_nv, departamento %in% lista)
rm(lista)

# construir grafica
ggplot(c_exc_20_dep_nv_selection,aes(x=semana,y=muertes,col=ano,fill=ano)) +
  geom_area(stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  scale_x_continuous(limits=c(1,53),breaks=seq(2,52,8)) +
  scale_y_continuous(limits=c(0,NA),labels=comma) +
  scale_color_manual(values = c("#CC79A7","#999999")) +
  scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Exceso de muertes naturales y violentas en Bolívar, Córdoba, Nariño, Norte de Santander, Cauca y Magdalena",
       subtitle="Comparación del total de muertes (por todas las causas) en 2020 respecto al promedio de años anteriores",caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE) el 2021-02-04\nLos datos de 2020 son preliminares") +
  facet_grid(tipo ~ departamento) +
  
  # anotaciones
  geom_text(aes(x=26,y=50,label=ifelse(departamento == "Norte de Santander" & tipo == "Naturales","@rundav5","")),size=3,col="white") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_exc_022.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertes naturales y violentas en grupo 3}
lista <- c("Tolima","Boyacá","Cesar","Huila","Meta","Caldas")

c_exc_20_dep_nv_selection <- subset(c_exc_20_dep_nv, departamento %in% lista)
rm(lista)

# construir grafica
ggplot(c_exc_20_dep_nv_selection,aes(x=semana,y=muertes,col=ano,fill=ano)) +
  geom_area(stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  #geom_text(aes(label=ifelse(semana==26 | exceso == max(exceso),percent(exceso, accuracy = 2),NA)),show.legend=FALSE,nudge_x=5,nudge_y=ifelse(c_exc_20_dep_nv_selection$exceso<0,-100,70),size=2.5) +
  scale_x_continuous(limits=c(1,53),breaks=seq(2,52,8)) +
  scale_y_continuous(limits=c(0,NA),labels=comma) +
  scale_color_manual(values = c("#CC79A7","#999999")) +
  scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Exceso de muertes naturales y violentas en Tolima, Boyacá, Cesar, Huila, Meta y Caldas",
       subtitle="Comparación del total de muertes (por todas las causas) en 2020 respecto al promedio de años anteriores",caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE) el 2021-02-04\nLos datos de 2020 son preliminares") +
  facet_grid(tipo ~ departamento) +
  
  # anotaciones
  geom_text(aes(x=26,y=50,label=ifelse(departamento == "Tolima" & tipo == "Naturales","@rundav5","")),size=3,col="white") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_exc_023.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertes naturales y violentas en grupo 4}
lista <- c("Risaralda","Sucre","La Guajira","Quindío","Chocó","Casanare")
c_exc_20_dep_nv_selection <- subset(c_exc_20_dep_nv, departamento %in% lista)
rm(lista)

# construir grafica
ggplot(c_exc_20_dep_nv_selection,aes(x=semana,y=muertes,col=ano,fill=ano)) +
  geom_area(stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  scale_x_continuous(limits=c(1,53),breaks=seq(2,52,8)) +
  scale_y_continuous(limits=c(0,NA),labels=comma) +
  scale_color_manual(values = c("#CC79A7","#999999")) +
  scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Exceso de muertes naturales y violentas en Risaralda, Sucre, La Guajira, Quindío, Chocó y Casanare",
       subtitle="Comparación del total de muertes (por todas las causas) en 2020 respecto al promedio de años anteriores",caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE) el 2021-02-04\nLos datos de 2020 son preliminares") +
  facet_grid(tipo ~ departamento) +
  
  # anotaciones
  geom_text(aes(x=26,y=20,label=ifelse(departamento == "Sucre" & tipo == "Naturales","@rundav5","")),size=3,col="white") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_exc_024.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertes naturales y violentas en grupo 5}
lista <- c("Caquetá","Putumayo","Arauca","Guaviare","Vichada","Amazonas")
c_exc_20_dep_nv_selection <- subset(c_exc_20_dep_nv, departamento %in% lista)
rm(lista)

# construir grafica
ggplot(c_exc_20_dep_nv_selection,aes(x=semana,y=muertes,col=ano,fill=ano)) +
  geom_area(stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  scale_x_continuous(limits=c(1,53),breaks=seq(2,52,8)) +
  scale_y_continuous(limits=c(0,NA),labels=comma) +
  scale_color_manual(values = c("#CC79A7","#999999")) +
  scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Exceso de muertes naturales y violentas en Caquetá, Putumayo, Arauca, Guaviare, Vichada y Amazonas",
       subtitle="Comparación del total de muertes (por todas las causas) en 2020 respecto al promedio de años anteriores",caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE) el 2021-02-04\nLos datos de 2020 son preliminares") +
  facet_grid(tipo ~ departamento) +
  
  # anotaciones
  geom_text(aes(x=26,y=10,label=ifelse(departamento == "Caquetá" & tipo == "Naturales","@rundav5","")),size=3,col="white") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_exc_025.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r muertes naturales y violentas en grupo 6}
lista <- c("San Andrés y Providencia","Guainía","Vaupés")
c_exc_20_dep_nv_selection <- subset(c_exc_20_dep_nv, departamento %in% lista)
rm(lista)

# construir grafica
ggplot(c_exc_20_dep_nv_selection,aes(x=semana,y=muertes,col=ano,fill=ano)) +
  geom_area(stat="identity", position = "dodge", alpha = 0.5, size = 1) +
  scale_x_continuous(limits=c(1,53),breaks=seq(4,52,4)) +
  scale_y_continuous(limits=c(0,NA)) +
  scale_color_manual(values = c("#CC79A7","#999999")) +
  scale_fill_manual(values = c("#CC79A7","#999999")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  labs(y=NULL,
       x="Semana del año",
       col=NULL,
       fill=NULL,
       title="Exceso de muertes naturales y violentas en San Andrés y Providencia, Guanía y Vaupés",
       subtitle="Comparación del total de muertes (por todas las causas) en 2020 respecto al promedio de años anteriores",caption="Fuente: datos de mortalidad por semana reportados por el Departamento Administrativo Nacional de Estadística (DANE) el 2021-02-04\nLos datos de 2020 son preliminares") +
  facet_grid(tipo ~ departamento) +
  
  # anotaciones
  geom_text(aes(x=26,y=2,label=ifelse(departamento == "San Andrés y Providencia" & tipo == "Naturales","@rundav5","")),size=3,col="white") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_exc_026.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

***
# Proceso de vacunación

El proceso de vacunación inició el 17 de febrero del 2021 en Colombia. 

```{r importar y arreglar info vacunacion}
v_dep <- read_excel(paste("inputs/vacunas/vacunacioncolombiaok_",reciente,".xlsx",sep=""))
v_dep <- subset(v_dep, select = c(1,4:7))
colnames(v_dep) <- c("departamento", "fecha", "asignadas_resolucion", "disponibles_acum","aplicadas_acum")

v_dep$departamento_new <- NA
v_dep$departamento_new <- v_dep$departamento
v_dep$departamento_new <- ifelse(v_dep$departamento == "BARRANQUILLA*", "ATLANTICO", v_dep$departamento_new)
v_dep$departamento_new <- ifelse(v_dep$departamento == "CARTAGENA*", "BOLIVAR", v_dep$departamento_new)
v_dep$departamento_new <- ifelse(v_dep$departamento == "SANTA MARTA*", "MAGDALENA", v_dep$departamento_new)
v_dep$departamento_new <- ifelse(v_dep$departamento == "BUENAVENTURA*", "VALLE DEL CAUCA", v_dep$departamento_new)

v_dep$departamento_new <- stri_trans_general(v_dep$departamento_new,"Latin-ASCII") #acentos
v_dep$departamento_new <- toupper(v_dep$departamento_new)

v_dep$departamento_new <- ifelse(v_dep$departamento_new == "NORTE DE SANTANDER", "NORTE SANTANDER", v_dep$departamento_new)
v_dep$departamento_new <- ifelse(v_dep$departamento_new == "SAN ANDRES Y PROVIDENCIA", "SAN ANDRES", v_dep$departamento_new)
v_dep$departamento_new <- ifelse(v_dep$departamento_new == "VALLE DEL CAUCA", "VALLE", v_dep$departamento_new)
v_dep$departamento_new <- ifelse(v_dep$departamento_new == "LA GUAJIRA", "GUAJIRA", v_dep$departamento_new)

v_dep$departamento <- NULL
v_dep <- aggregate(. ~ departamento_new + fecha, v_dep, sum)
colnames(v_dep)[1] <- "departamento"

# calcular dosis aplicadas por cada 100 habitantes
v_dep$aplicadas_100hab <- NA
v_dep$aplicadas_100hab <- 100 * v_dep$aplicadas_acum / info_dep$pob_total[match(v_dep$departamento,info_dep$departamento)]

```

```{r transformar dataframe de vacunas}
aux1 <- subset(v_dep, select = c(1,2,3))
colnames(aux1)[3] <- "dosis"
aux1$estado <- "Disponibles"
aux3 <- subset(v_dep, select = c(1,2,5))
colnames(aux3)[3] <- "dosis"
aux3$estado <- "Aplicadas"

v_dep_aux <- rbind(aux1,aux3)
rm(aux1,aux3)

v_dep_aux$orden <- ifelse(v_dep_aux$estado == "Disponibles",1,2)

v_dep_aux$fecha <- as.Date(v_dep_aux$fecha)

# dosis disponibles y aplicadas por cada 100 habitantes
v_dep_aux$hab <- info_dep$pob_total[match(v_dep_aux$departamento,info_dep$departamento)]
v_dep_aux$dosis_100hab <- v_dep_aux$dosis / v_dep_aux$hab * 100

```

```{r dosis disponibles y aplicadas en colombia}
v_col <- aggregate(dosis ~ fecha + estado, v_dep_aux, sum)

v_col$dosis_100hab <- NA
v_col$dosis_100hab <- v_col$dosis / info_dep$pob_total[1] * 100
v_col$orden <- ifelse(v_col$estado == "Disponibles",1,2)

#v_col$fecha <- as.Date(v_col$fecha)

# construir grafica
ggplot(v_col) +

  geom_text(x=as.Date("2021-03-01"),y=6000000,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  geom_area(size=0.8,aes(x=fecha,y=dosis,fill=reorder(estado,orden)),alpha=0.8,position="dodge") +
  scale_x_date(date_breaks="2 weeks",date_minor_breaks="1 week",date_labels="%d-%m") +
  scale_y_continuous(breaks=seq(0,40000000,2000000),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,40000000,2000000),labels=comma)) +
  scale_fill_manual(values=c("#878787","#009fe3", "red")) +
  labs(x="Fecha",y=NULL,fill=NULL,
       title="Dosis de vacunas disponibles y aplicadas en Colombia",
       caption=paste("Fuente: información reportada por MinSalud en Twitter hasta el",fecha_datos, "y consolidada por Silvana Zapata Bedoya (@solsivanazb)\nLas vacunas disponibles corresponden a las que han sido asignadas por resolución a los departamentos")) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",plot.caption=element_text(face="italic",hjust=0)) 

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_201.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r dosis aplicadas por dia en Colombia}
v_col_2 <- aggregate(aplicadas_acum ~ fecha, v_dep, sum)

v_col_2$aplicadas_dia <- NA
v_col_2$aplicadas_dia[1] <- v_col_2$aplicadas_acum[1]
lista <- as.numeric(rownames(v_col_2)[2:length(rownames(v_col_2))])
for (i in lista) {
  v_col_2$aplicadas_dia[i] <- v_col_2$aplicadas_acum[i] - v_col_2$aplicadas_acum[i-1]
}
rm(lista,i)

v_col_2$fecha <- as.Date(v_col_2$fecha)

v_col_2$semana <- isoweek(v_col_2$fecha)
aux <- aggregate(aplicadas_dia ~ semana, v_col_2, mean)

v_col_2$aplicadas_sem <- NA
v_col_2$aplicadas_sem <- aux$aplicadas_dia[match(v_col_2$semana,aux$semana)]
rm(aux)

#v_col_2$aplicadas_sem[match(20,v_col_2$semana)] <- NA

ggplot(v_col_2,aes(x=fecha)) +
  geom_text(x=as.Date("2021-03-01"),y=150000,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  geom_bar(aes(y=aplicadas_dia),stat="identity",fill="#009fe3",alpha=0.8) +
  geom_step(aes(y=aplicadas_sem,col="promedio semana"),size=0.8) +
  scale_x_date(date_breaks="2 weeks", date_minor_breaks="1 week", date_labels="%d-%m") +
  scale_y_continuous(breaks=seq(0,500000,50000),minor_breaks=seq(0,500000,10000),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,500000,50000),labels=comma)) +
  scale_color_manual(values="#003e65") +
  labs(x="Fecha",y=NULL,fill=NULL,color=NULL,
       title="Dosis de vacunas aplicadas al día en Colombia",
       caption=paste("Fuente: información reportada por MinSalud en Twitter hasta el",fecha_datos, "y consolidada por Silvana Zapata Bedoya (@solsivanazb)\nLas vacunas disponibles corresponden a las que han sido asignadas por resolución a los departamentos")) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=0),legend.position="top",plot.caption=element_text(face="italic",hjust=0)) 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_202.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```


```{r dosis disponibles y aplicadas por departamento grupo 1}
lista <- c("BOGOTA","VALLE","ANTIOQUIA","ATLANTICO","CUNDINAMARCA","SANTANDER")
#lista <- c("BOLIVAR","CORDOBA","NARINO","NORTE SANTANDER","CAUCA","MAGDALENA")
#lista <- c("TOLIMA","BOYACA","CESAR","HUILA","META","CALDAS")
#lista <- c("RISARALDA","SUCRE","GUAJIRA","QUINDIO","CHOCO","CASANARE")
#lista <- c("CAQUETA","PUTUMAYO","ARAUCA","GUAVIARE","VICHADA","AMAZONAS","SAN ANDRES","GUANIA","VAUPES")

vacunas_dep_g <- subset(v_dep_aux, departamento %in% lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(vacunas_dep_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x6[length(anno_text$departamento)] <- as.Date("2021-03-01")
anno_text$y6[length(anno_text$departamento)] <- 40
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(vacunas_dep_g) +

  # datos
  geom_area(size=0.8,aes(x=fecha,y=dosis_100hab,fill=reorder(estado,orden)),alpha=0.8,position="dodge") +
  scale_x_date(date_breaks="1 month",date_labels="%d-%m") +
  scale_y_continuous(breaks=seq(0,100,10),sec.axis=sec_axis(~.,breaks=seq(0,100,10))) +
  scale_fill_manual(values=c("#878787","#009fe3")) +
  labs(x="Fecha",y="Dosis por cada 100 habitantes",fill=NULL,
       subtitle="Dosis de vacunas disponibles y aplicadas en Bogotá, Antioquia, Atlántico, Valle del Cauca, Cundinamarca y Santander",
       caption=paste("Fuente: información reportada por MinSalud en Twitter hasta el",fecha_datos, "y consolidada por Silvana Zapata Bedoya (@solsivanazb)")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  facet_wrap(~departamento) +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle = 0, size = 3,col="#AEB6BF") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_211.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r dosis disponibles y aplicadas por departamento grupo 2}
#lista <- c("BOGOTA","VALLE","ANTIOQUIA","ATLANTICO","CUNDINAMARCA","SANTANDER")
lista <- c("BOLIVAR","CORDOBA","NARINO","NORTE SANTANDER","CAUCA","MAGDALENA")
#lista <- c("TOLIMA","BOYACA","CESAR","HUILA","META","CALDAS")
#lista <- c("RISARALDA","SUCRE","GUAJIRA","QUINDIO","CHOCO","CASANARE")
#lista <- c("CAQUETA","PUTUMAYO","ARAUCA","GUAVIARE","VICHADA","AMAZONAS","SAN ANDRES","GUANIA","VAUPES")

vacunas_dep_g <- subset(v_dep_aux, departamento %in% lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(vacunas_dep_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x6[length(anno_text$departamento)] <- as.Date("2021-03-01")
anno_text$y6[length(anno_text$departamento)] <- 40
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(vacunas_dep_g) +

  # datos
  geom_area(size=0.8,aes(x=fecha,y=dosis_100hab,fill=reorder(estado,orden)),alpha=0.8,position="dodge") +
  scale_x_date(date_breaks="1 month",date_labels="%d-%m") +
  scale_y_continuous(breaks=seq(0,100,10),sec.axis=sec_axis(~.,breaks=seq(0,100,10))) +
  scale_fill_manual(values=c("#878787","#009fe3")) +
  labs(x="Fecha",y="Dosis por cada 100 habitantes",fill=NULL,
       subtitle="Dosis de vacunas disponibles y aplicadas en Bolívar, Córdoba, Nariño, Norte de Santander, Cauca y Magdalena",
       caption=paste("Fuente: información reportada por MinSalud en Twitter hasta el",fecha_datos, "y consolidada por Silvana Zapata Bedoya (@solsivanazb)")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  facet_wrap(~departamento) +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle = 0, size = 3,col="#AEB6BF") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_212.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r dosis disponibles y aplicadas por departamento grupo 3}
#lista <- c("BOGOTA","VALLE","ANTIOQUIA","ATLANTICO","CUNDINAMARCA","SANTANDER")
#lista <- c("BOLIVAR","CORDOBA","NARINO","NORTE SANTANDER","CAUCA","MAGDALENA")
lista <- c("TOLIMA","BOYACA","CESAR","HUILA","META","CALDAS")
#lista <- c("RISARALDA","SUCRE","GUAJIRA","QUINDIO","CHOCO","CASANARE")
#lista <- c("CAQUETA","PUTUMAYO","ARAUCA","GUAVIARE","VICHADA","AMAZONAS","SAN ANDRES","GUANIA","VAUPES")

vacunas_dep_g <- subset(v_dep_aux, departamento %in% lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(vacunas_dep_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x6[length(anno_text$departamento)] <- as.Date("2021-03-01")
anno_text$y6[length(anno_text$departamento)] <- 40
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(vacunas_dep_g) +

  # datos
  geom_area(size=0.8,aes(x=fecha,y=dosis_100hab,fill=reorder(estado,orden)),alpha=0.8,position="dodge") +
  scale_x_date(date_breaks="1 month",date_labels="%d-%m") +
  scale_y_continuous(breaks=seq(0,100,10),sec.axis=sec_axis(~.,breaks=seq(0,100,10))) +
  scale_fill_manual(values=c("#878787","#009fe3")) +
  labs(x="Fecha",y="Dosis por cada 100 habitantes",fill=NULL,
       subtitle="Dosis de vacunas disponibles y aplicadas en Tolima, Boyacá, Cesár, Huila, Meta y Caldas",
       caption=paste("Fuente: información reportada por MinSalud en Twitter hasta el",fecha_datos, "y consolidada por Silvana Zapata Bedoya (@solsivanazb)")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  facet_wrap(~departamento) +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle = 0, size = 3,col="#AEB6BF") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_213.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r dosis disponibles y aplicadas por departamento grupo 4}
#lista <- c("BOGOTA","VALLE","ANTIOQUIA","ATLANTICO","CUNDINAMARCA","SANTANDER")
#lista <- c("BOLIVAR","CORDOBA","NARINO","NORTE SANTANDER","CAUCA","MAGDALENA")
#lista <- c("TOLIMA","BOYACA","CESAR","HUILA","META","CALDAS")
lista <- c("RISARALDA","SUCRE","GUAJIRA","QUINDIO","CHOCO","CASANARE")
#lista <- c("CAQUETA","PUTUMAYO","ARAUCA","GUAVIARE","VICHADA","AMAZONAS","SAN ANDRES","GUANIA","VAUPES")

vacunas_dep_g <- subset(v_dep_aux, departamento %in% lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(vacunas_dep_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x6[length(anno_text$departamento)] <- as.Date("2021-03-01")
anno_text$y6[length(anno_text$departamento)] <- 40
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(vacunas_dep_g) +

  # datos
  geom_area(size=0.8,aes(x=fecha,y=dosis_100hab,fill=reorder(estado,orden)),alpha=0.8,position="dodge") +
  scale_x_date(date_breaks="1 month",date_labels="%d-%m") +
  scale_y_continuous(breaks=seq(0,100,10),sec.axis=sec_axis(~.,breaks=seq(0,100,10))) +
  scale_fill_manual(values=c("#878787","#009fe3")) +
  labs(x="Fecha",y="Dosis por cada 100 habitantes",fill=NULL,
       subtitle="Dosis de vacunas disponibles y aplicadas en Risaralda, Sucre, La Guajira, Quindío, Chocó y Casanare",
       caption=paste("Fuente: información reportada por MinSalud en Twitter hasta el",fecha_datos, "y consolidada por Silvana Zapata Bedoya (@solsivanazb)")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  facet_wrap(~departamento) +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle=0,size=3,col="#AEB6BF") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_214.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r dosis disponibles y aplicadas por departamento grupo 5}
#lista <- c("BOGOTA","VALLE","ANTIOQUIA","ATLANTICO","CUNDINAMARCA","SANTANDER")
#lista <- c("BOLIVAR","CORDOBA","NARINO","NORTE SANTANDER","CAUCA","MAGDALENA")
#lista <- c("TOLIMA","BOYACA","CESAR","HUILA","META","CALDAS")
#lista <- c("RISARALDA","SUCRE","GUAJIRA","QUINDIO","CHOCO","CASANARE")
lista <- c("CAQUETA","PUTUMAYO","ARAUCA","GUAVIARE","VICHADA")

vacunas_dep_g <- subset(v_dep_aux, departamento %in% lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(vacunas_dep_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x6[length(anno_text$departamento)] <- as.Date("2021-03-01")
anno_text$y6[length(anno_text$departamento)] <- 40
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(vacunas_dep_g) +

  # datos
  geom_area(size=0.8,aes(x=fecha,y=dosis_100hab,fill=reorder(estado,orden)),alpha=0.8,position="dodge") +
  scale_x_date(date_breaks="1 month",date_labels="%d-%m") +
  scale_y_continuous(breaks=seq(0,100,10),sec.axis=sec_axis(~.,breaks=seq(0,100,10))) +
  scale_fill_manual(values=c("#878787","#009fe3")) +
  labs(x="Fecha",y="Dosis por cada 100 habitantes",fill=NULL,
       subtitle="Dosis de vacunas disponibles y aplicadas en Caquetá, Putumayo, Arauca, Guaviare, Vichada y San Andrés",
       caption=paste("Fuente: información reportada por MinSalud en Twitter hasta el",fecha_datos, "y consolidada por Silvana Zapata Bedoya (@solsivanazb)")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  facet_wrap(~departamento) +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle = 0, size = 3,col="#AEB6BF") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_215.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r dosis disponibles y aplicadas por departamento grupo 6}
#lista <- c("BOGOTA","VALLE","ANTIOQUIA","ATLANTICO","CUNDINAMARCA","SANTANDER")
#lista <- c("BOLIVAR","CORDOBA","NARINO","NORTE SANTANDER","CAUCA","MAGDALENA")
#lista <- c("TOLIMA","BOYACA","CESAR","HUILA","META","CALDAS")
#lista <- c("RISARALDA","SUCRE","GUAJIRA","QUINDIO","CHOCO","CASANARE")
lista <- c("AMAZONAS","GUAINIA","VAUPES","SAN ANDRES")

vacunas_dep_g <- subset(v_dep_aux, departamento %in% lista)

# data frame con anotaciones
anno_text <- data.frame(departamento = unique(vacunas_dep_g$departamento),
                        x1=as.Date(NA),y1=NA,label_1=NA,
                        x2=as.Date(NA),y2=NA,label_2=NA,
                        x3=as.Date(NA),y3=NA,label_3=NA,
                        x4=as.Date(NA),y4=NA,label_4=NA,
                        x5=as.Date(NA),y5=NA,label_5=NA,
                        x6=as.Date(NA),y6=NA,label_6=NA)

anno_text$x6[length(anno_text$departamento)] <- as.Date("2021-03-01")
anno_text$y6[length(anno_text$departamento)] <- 80
anno_text$label_6[length(anno_text$departamento)] <- "@rundav5"

# construir grafica
ggplot(vacunas_dep_g) +

  # datos
  geom_area(size=0.8,aes(x=fecha,y=dosis_100hab,fill=reorder(estado,orden)),alpha=0.8,position="dodge") +
  scale_x_date(date_breaks="1 month",date_labels="%d-%m") +
  scale_y_continuous(breaks=seq(0,200,20),sec.axis=sec_axis(~.,breaks=seq(0,200,20))) +
  scale_fill_manual(values=c("#878787","#009fe3")) +
  labs(x="Fecha",y="Dosis por cada 100 habitantes",fill=NULL,
       subtitle="Dosis de vacunas disponibles y aplicadas en Amazonas, Guainía y Vaupés",
       caption=paste("Fuente: información reportada por MinSalud en Twitter hasta el",fecha_datos, "y consolidada por Silvana Zapata Bedoya (@solsivanazb)")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, size = 6), 
        axis.title = element_text(size = 8),
        title = element_text(size = 8),
        axis.text.y = element_text(size = 6),
        strip.text = element_text(size = 6),
        plot.caption=element_text(face="italic",hjust=0,size=7),
        legend.text = element_text(size = 7),
        legend.position="top") +
  guides(col=guide_legend(nrow=1)) +
  facet_wrap(~departamento, ncol = 3) +
  geom_text(data=anno_text,aes(x=x6,y=y6,label=label_6),angle = 0, size = 3,col="#AEB6BF") 


# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_216.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r dosis asignadas acumuladas por departamento}

v_dep_acum <- subset(v_dep, fecha == max(fecha))

# construir grafica
ggplot(v_dep_acum,aes(x=reorder(departamento,asignadas_resolucion),y=asignadas_resolucion,fill=asignadas_resolucion)) +
  geom_text(x="PUTUMAYO",y=500000,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  geom_bar(stat="identity", width = 0.85) +
  geom_text(aes(label=comma(asignadas_resolucion),col=asignadas_resolucion),size=2.5,nudge_y=40000) +
  scale_fill_gradient(low="#009fe3",high="#003e65") +
  scale_color_gradient(low="#009fe3",high="#003e65") +
  scale_y_continuous(breaks=seq(0,2000000,200000),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,2000000,200000),labels=comma)) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position="none",plot.caption=element_text(face="italic",hjust=0),axis.text.y = element_text(angle = 0, size = 8)) +
  labs(subtitle="Dosis acumuladas asignadas por departamento",
       x=NULL,y=NULL,
       caption=paste("Fuente: información reportada por MinSalud en Twitter hasta el",fecha_datos, "y consolidada por Silvana Zapata Bedoya (@solsivanazb)"))

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_230.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r dosis aplicadas acumuladas por departamento}

# construir grafica
ggplot(v_dep_acum,aes(x=reorder(departamento,aplicadas_acum),y=aplicadas_acum,fill=aplicadas_acum)) +
  geom_text(x="PUTUMAYO",y=300000,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  geom_bar(stat="identity", width = 0.85) +
  geom_text(aes(label=comma(aplicadas_acum),col=aplicadas_acum),size=2.5,nudge_y=30000) +
  scale_fill_gradient(low="#009fe3",high="#003e65") +
  scale_color_gradient(low="#009fe3",high="#003e65") +
  scale_y_continuous(breaks=seq(0,2000000,200000),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,2000000,200000),labels=comma)) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position="none",plot.caption=element_text(face="italic",hjust=0),axis.text.y = element_text(angle = 0, size = 8)) +
  labs(subtitle="Dosis acumuladas aplicadas por departamento",
       x=NULL,y=NULL,
       caption=paste("Fuente: información reportada por MinSalud en Twitter hasta el",fecha_datos, "y consolidada por Silvana Zapata Bedoya (@solsivanazb)"))

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
#ggsave(paste(reciente,"_231.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r porcentaje de dosis disponibles y aplicadas por departamento, eval=FALSE, include=FALSE}
v_dep_acum$porc_aplicadas <- NA
v_dep_acum$porc_aplicadas <- v_dep_acum$aplicadas_acum / v_dep_acum$asignadas_resolucion

# construir grafica
ggplot(v_dep_acum,aes(x=reorder(departamento,aplicadas_acum))) +
  geom_text(x="PUTUMAYO",y=3000000,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  geom_bar(stat="identity",width=0.85,aes(y=asignadas_resolucion,fill="Disponibles")) +
  geom_bar(stat="identity",width=0.85,aes(y=aplicadas_acum,fill="Aplicadas")) +
  geom_text(aes(label=percent(porc_aplicadas,accuracy=1),y=aplicadas_acum),size=2.5,nudge_y=60000,col="#003e65") +
  scale_fill_manual(values=c("#009fe3","#878787")) +
  scale_y_continuous(breaks=seq(0,30000000,500000),labels=comma,sec.axis=sec_axis(~.,breaks=seq(0,30000000,500000),labels=comma)) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position="none",plot.caption=element_text(face="italic",hjust=0,size=8),axis.text.y=element_text(angle=0,size=8)) +
  labs(subtitle="Porcentaje de dosis disponibles que han sido aplicadas por departamento",x=NULL,y=NULL,caption=paste("Fuente: información reportada por MinSalud en Twitter hasta el",fecha_datos, "y consolidada por Silvana Zapata Bedoya (@solsivanazb)"))

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_230.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

```{r dosis aplicadas por cada 100 habitantes, eval=FALSE, include=FALSE}
aux <- subset(v_col, fecha == max(fecha))
v_col_hab <- aux$dosis_100hab[match("Aplicadas",aux$estado)]
rm(aux)

# construir grafica
ggplot(v_dep_acum,aes(x=reorder(departamento,aplicadas_100hab),)) +
  geom_text(x="PUTUMAYO",y=75,label="@rundav5",col="#AEB6BF",size=3) + # usuario
  geom_bar(stat="identity", width = 0.85,aes(y=aplicadas_100hab,fill=aplicadas_100hab)) +
  geom_text(aes(label=round(aplicadas_100hab,2),y=aplicadas_100hab,col=aplicadas_100hab),size=2.5,nudge_y=2) +
  scale_y_continuous(breaks=seq(0,200,5),sec.axis=sec_axis(~.,breaks=seq(0,200,5))) +
  scale_fill_gradient(low="#009fe3",high="#003e65") +
  scale_color_gradient(low="#009fe3",high="#003e65") +
  geom_hline(yintercept=v_col_hab,col="#999999") +
  geom_point(x="GUAJIRA",y=v_col_hab,col="#999999") +
geom_label(x="GUAJIRA",y=v_col_hab*1.5,label=paste("Colombia",round(v_col_hab,2)),size=3,fill="#999999",col="white") +
  coord_flip() +
  theme_minimal() +
  theme(legend.position="none",plot.caption=element_text(face="italic",hjust=0,size=8),axis.text.y=element_text(angle=0,size=8)) +
  labs(subtitle="Dosis aplicadas por cada 100 habitantes por departamento",
       x=NULL,y=NULL,
       caption=paste("Fuente: información reportada por MinSalud en Twitter hasta el ", fecha_datos, " y consolidada por Silvana Zapata Bedoya (@solisivanazb);\npoblación ajustada por cobertura del Censo Nacional de Población y Vivienda 2018",sep = ""))

# guardar jpg
aratio <- 16/9
w <- 8
h <- w/aratio
ggsave(paste(reciente,"_231.jpeg",sep=""),last_plot(),device="jpeg",path="outputs/",width=w,height=h)
rm(aratio, w,h)

```

# Discusión

+ Valor y transparencia de la información
+ Análisis y visualización de datos en los medios de comunicación
+ [Prevention paradox](https://www.theguardian.com/world/2020/apr/26/virologist-christian-drosten-germany-coronavirus-expert-interview)
+ [Population density and viral transmission](https://www.nytimes.com/2020/05/15/opinion/sunday/coronavirus-cities-density.html)
+ [Risk on public transport](https://www.bbc.com/news/health-51736185)
+ [Radiografía de tres brotes](https://elpais.com/ciencia/2020-06-06/radiografia-de-tres-brotes-asi-se-contagiaron-y-asi-podemos-evitarlo.html)
+ [Caso Japón](https://www.sciencemag.org/news/2020/05/japan-ends-its-covid-19-state-emergency)
+ [Lockdown in developing countries](https://voxeu.org/article/lockdowns-developing-countries-should-focus-shielding-elderly)
+ [No Urban Myth](https://www.worldbank.org/en/news/immersive-story/2020/06/18/no-urban-myth-building-inclusive-and-sustainable-cities-in-the-pandemic-recovery)
+ [Predicting the Trajectory of Any COVID19 Epidemic From the Best Straight Line](https://www.medrxiv.org/content/10.1101/2020.06.26.20140814v1)
